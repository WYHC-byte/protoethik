<!--Copyright (c) 2025 Protoethik Co., Ltd. All rights reserved.-->
<!--
//                            _ooOoo_  
//                           o8888888o  
//                           88" . "88  
//                           (| -_- |)  
//                            O\ = /O  
//                        ____/`---'\____  
//                      .   ' \\| |// `.  
//                       / \\||| : |||// \  
//                     / _||||| -:- |||||- \  
//                       | | \\\ - /// | |  
//                     | \_| ''\---/'' | |  
//                      \ .-\__ `-` ___/-. /  
//                   ___`. .' /--.--\ `. . __  
//                ."" '< `.___\_<|>_/___.' >'"".  
//               | | : `- \`.;`\ _ /`;.`/ - ` : | |  
//                 \ \ `-. \_ __\ /__ _/ .-` / /  
//         ======`-.____`-.___\_____/___.-`____.-'======  
//                            `=---='  
//  
//         .............................................  
//                  佛祖保佑          此文件永无BUG
//    God bless        this file may it be forever bug-free (Amen).
-->
<!DOCTYPE html><!-- Last Published: Thu Oct 23 2025 21:05:45 GMT+0000 (Coordinated Universal Time) -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TyloAI</title>
    <meta name="description" content="TyloAI - Power, at your command">
    <meta name="keywords" content="AI,TyloAI,">
    <link rel="icon" href="logo.png" type="image/png">
    
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="debug.js"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <!--<link rel="stylesheet" href="style.css">-->
    <style>
        /* Artifact Panel Styles */
        .artifact-panel {
            position: fixed;
            right: -600px;
            top: 0;
            width: 600px;
            height: 100vh;
            background: white;
            border-left: 1px solid #e5e7eb;
            transition: right 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .dark .artifact-panel {
            background: #1f2937;
            border-left-color: #374151;
        }

        .artifact-panel.open {
            right: 0;
        }

        .artifact-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dark .artifact-header {
            border-bottom-color: #374151;
        }

        .artifact-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
        }

        .dark .artifact-tabs {
            border-bottom-color: #374151;
        }

        .artifact-tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .artifact-tab.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
        }

        .artifact-content {
            flex: 1;
            overflow: auto;
        }

        .artifact-editor {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            padding: 16px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: white;
            color: #1f2937;
        }

        .dark .artifact-editor {
            background: #1f2937;
            color: #e5e5e5;
        }

        .artifact-preview {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        /* Research button animation */
        #researchToggle {
            transition: all 0.3s ease;
        }
        #researchToggle.research-active {
            animation: researchPulse 1.5s ease-in-out infinite;
        }
        @keyframes researchPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: .5;
            }
        }
        #advancedOptionsMenu {
            display: none;
        }
        #advancedOptionsMenu.open {
            display: block !important;
        }
        #advancedOptionsMenu.open {
            display: block !important;
            z-index: 1000 !important;
        }

        #modelOptions.open {
            display: block !important;
            z-index: 999 !important;
        }
        #advancedOptionsMenu {
            position: absolute;
            bottom: 100%;
            margin-bottom: 8px;
            left: 0;
            min-width: 200px;
            z-index: 1000 !important;
        }

        #advancedOptionsMenu.open {
            display: block !important;
        }

        /* Ensure dropdowns don't overlap */
        .dropdown-options {
            z-index: 100;
        }

        #advancedOptionsMenu {
            z-index: 1000;
        }
        
        /* Custom Styles */
        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        .sidebar.active {
            transform: translateX(0);
        }
        .dropdown-options {
            display: none;
        }
        .dropdown-options.open {
            display: block;
        }
        .chat-message-user {
            background: #dbeafe;
            border-radius: 18px;
            padding: 12px 16px;
            margin: 8px 0 8px 0;
            max-width: 80%;
            margin-left: 0;
        }
        .chat-message-ai {
            padding: 16px 20px;
            margin: 12px 0;
            max-width: 100%;
            font-size: 16px;
            line-height: 1.8;
        }
        .dark .chat-message-user {
            background: #1e40af;
            color: white;
        }
        .ai-typing {
            display: inline-block;
            width: 20px;
            height: 20px;
            position: relative;
        }
        .ai-typing::after {
            content: '. . .';
            animation: typing 1.4s infinite;
            font-size: 12px;
        }
        @keyframes typing {
            0%, 60% { opacity: 0.3; }
            30% { opacity: 1; }
        }
        pre {
            background: #1f2937;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            position: relative;
        }
        .copy-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #4b5563;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Modal Overlay */
        .modal-overlay {
            backdrop-filter: blur(4px);
        }

        /* Memory notification animation */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
        }

        #memorySavedNotification {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Collapsible code block */
        .code-block-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            margin: 16px 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .code-block-card.collapsed {
            max-height: 60px;
        }

        .code-block-header {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            user-select: none;
        }

        .code-block-header:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .code-block-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .code-block-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .code-block-meta {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .code-block-filename {
            font-weight: 600;
            font-size: 14px;
        }

        .code-block-details {
            font-size: 11px;
            opacity: 0.8;
        }

        .code-block-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .code-block-card:not(.collapsed) .code-block-content {
            max-height: 2000px;
        }

        .code-block-content pre {
            margin: 0;
            border-radius: 0 0 12px 12px;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #6b7280;
        }
        
        /* æ€è€ƒè¿›ç¨‹æ ·å¼ - ä¼˜åŒ–ç‰ˆ */
        .thinking-process {
            background: linear-gradient(135deg, #e8f4f8 0%, #d4e7f5 100%);
            border: 2px solid #b8d4ea;
            border-radius: 16px;
            margin: 16px 0;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.12);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .thinking-process:hover {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.18);
            transform: translateY(-2px);
            border-color: #3b82f6;
        }

        .dark .thinking-process {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            border-color: #475569;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .dark .thinking-process:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            border-color: #64748b;
        }

        /* æ€è€ƒè¿›ç¨‹å¤´éƒ¨ */
        .thinking-process .flex.items-center.justify-between {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 16px 20px;
            border-bottom: 2px solid rgba(59, 130, 246, 0.1);
            transition: all 0.3s ease;
        }

        .dark .thinking-process .flex.items-center.justify-between {
            background: rgba(30, 41, 59, 0.9);
            border-bottom: 2px solid rgba(148, 163, 184, 0.1);
        }

        .thinking-process .flex.items-center.justify-between:hover {
            background: rgba(255, 255, 255, 1);
        }

        .dark .thinking-process .flex.items-center.justify-between:hover {
            background: rgba(30, 41, 59, 1);
        }

        /* æ€è€ƒå›¾æ ‡åŠ¨ç”» */
        .thinking-process .fa-brain {
            animation: brainPulse 2.5s ease-in-out infinite;
            filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));
        }

        @keyframes brainPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.15);
                opacity: 0.85;
            }
        }

        /* å±•å¼€/æ”¶èµ·ç®­å¤´ */
        .thinking-process .fa-chevron-down {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #64748b;
        }

        .dark .thinking-process .fa-chevron-down {
            color: #94a3b8;
        }

        .thinking-process .fa-chevron-down.rotate-180 {
            transform: rotate(180deg);
            color: #3b82f6;
        }

        /* æ€è€ƒå†…å®¹åŒºåŸŸ */
        .thinking-content {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(8px);
            padding: 20px;
            border-top: 2px solid rgba(59, 130, 246, 0.1);
        }

        .dark .thinking-content {
            background: rgba(15, 23, 42, 0.6);
            border-top: 2px solid rgba(148, 163, 184, 0.1);
        }

        /* æ€è€ƒå†…å®¹æ–‡æœ¬ */
        .thinking-content div {
            line-height: 1.8;
            color: #475569;
            background: rgba(255, 255, 255, 0.8);
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .dark .thinking-content div {
            color: #cbd5e0;
            background: rgba(30, 41, 59, 0.8);
            border-left: 4px solid #60a5fa;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* ç´«è‰²æ€è€ƒç‰¹æ®Šæ ·å¼ (Post Thinking) */
        .thinking-process:has(.fa-brain.text-purple-500) {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-color: #d8b4fe;
        }

        .dark .thinking-process:has(.fa-brain.text-purple-500) {
            background: linear-gradient(135deg, #2e1065 0%, #4c1d95 100%);
            border-color: #7c3aed;
        }

        .thinking-process:has(.fa-brain.text-purple-500) .thinking-content div {
            border-left-color: #a855f7;
        }

        .thinking-process:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        .dark .thinking-process {
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .dark .thinking-process:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* ÃƒÂ¦Ã¢â€šÂ¬Ã‚ÂÃƒÂ¨Ã¢â€šÂ¬Ã†â€™ÃƒÂ¨Ã‚Â¿Ã¢â‚¬Â¡ÃƒÂ§Ã‚Â¨Ã¢â‚¬Â¹ÃƒÂ¦ Ã¢â‚¬Â¡ÃƒÂ©Ã‚Â¢Ã‹Å“ÃƒÂ¦ Ã‚Â */
        .thinking-process .flex.items-center.justify-between {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: background 0.3s ease;
        }

        .dark .thinking-process .flex.items-center.justify-between {
            background: rgba(45, 55, 72, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .thinking-process .flex.items-center.justify-between:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .dark .thinking-process .flex.items-center.justify-between:hover {
            background: rgba(45, 55, 72, 0.9);
        }

        /* ÃƒÂ¦Ã¢â€šÂ¬Ã‚ÂÃƒÂ¨Ã¢â€šÂ¬Ã†â€™ÃƒÂ¥Ã¢â‚¬ÂºÃ‚Â¾ÃƒÂ¦ Ã¢â‚¬Â¡ÃƒÂ¥Ã… Ã‚Â¨ÃƒÂ§Ã¢â‚¬ÂÃ‚Â» */
        .thinking-process .fa-brain {
            animation: brainPulse 2s ease-in-out infinite;
        }

        @keyframes brainPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        /* ÃƒÂ¥Ã‚Â±Ã¢â‚¬Â¢ÃƒÂ¥Ã‚Â¼Ã¢â€šÂ¬ÃƒÂ§Ã‚Â®Ã‚Â­ÃƒÂ¥Ã‚Â¤Ã‚Â´ÃƒÂ¦Ã¢â‚¬â€Ã¢â‚¬Â¹ÃƒÂ¨Ã‚Â½Ã‚Â¬ÃƒÂ¥Ã… Ã‚Â¨ÃƒÂ§Ã¢â‚¬ÂÃ‚Â» */
        .thinking-process .fa-chevron-down {
            transition: transform 0.3s ease;
        }

        .thinking-process .fa-chevron-down.rotate-180 {
            transform: rotate(180deg);
        }

        /* ÃƒÂ¦Ã¢â€šÂ¬Ã‚ÂÃƒÂ¨Ã¢â€šÂ¬Ã†â€™ÃƒÂ¥Ã¢â‚¬ Ã¢â‚¬Â¦ÃƒÂ¥Ã‚Â®Ã‚Â¹ÃƒÂ¥Ã…â€™Ã‚ÂºÃƒÂ¥Ã…Â¸Ã…Â¸ */
        .thinking-content {
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(5px);
            padding: 16px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }

        .dark .thinking-content {
            background: rgba(26, 32, 44, 0.5);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* ÃƒÂ¦Ã¢â€šÂ¬Ã‚ÂÃƒÂ¨Ã¢â€šÂ¬Ã†â€™ÃƒÂ¥Ã¢â‚¬ Ã¢â‚¬Â¦ÃƒÂ¥Ã‚Â®Ã‚Â¹ÃƒÂ¦Ã¢â‚¬â€œÃ¢â‚¬Â¡ÃƒÂ¥Ã‚Â­Ã¢â‚¬â€ */
        .thinking-content div {
            line-height: 1.8;
            color: #4a5568;
            background: rgba(255, 255, 255, 0.6);
            padding: 12px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .dark .thinking-content div {
            color: #cbd5e0;
            background: rgba(45, 55, 72, 0.6);
            border-left: 3px solid #764ba2;
        }

        /* ÃƒÂ¤Ã‚ÂºÃ…â€™ÃƒÂ¦Ã‚Â¬Ã‚Â¡ÃƒÂ¦Ã¢â€šÂ¬Ã‚ÂÃƒÂ¨Ã¢â€šÂ¬Ã†â€™ÃƒÂ§Ã¢â‚¬Â°Ã‚Â¹ÃƒÂ¦Ã‚Â®Ã… ÃƒÂ¦ Ã‚Â·ÃƒÂ¥Ã‚Â¼Ã‚Â */
        .thinking-process:has(.fa-brain.text-purple-500) {
            background: linear-gradient(135deg, #faf5ff 0%, #e9d5ff 100%);
        }

        .dark .thinking-process:has(.fa-brain.text-purple-500) {
            background: linear-gradient(135deg, #2d1b4e 0%, #4c1d95 100%);
        }
        
        /* Achievement Animation */
        .achievement-popup {
            animation: slideInRight 0.5s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        /* Progress Bar */
        .progress-bar {
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
        }
        
        /* Suggestion Animation */
        .suggestion-fade {
            animation: fadeInOut 2s ease-in-out;
        }
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        
        /* Level Badge */
        .level-badge {
            background: linear-gradient(45deg, #fbbf24, #f59e0b);
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
        }

        /* Prism Connect Button Styles */
        #prismConnectBtn {
            position: relative;
        }

        #prismConnectBtn.connected #prismIcon {
            content: url('prism-blue.png');
        }

        /* Prism First Connect Modal */
        #prismFirstConnectModal {
            backdrop-filter: blur(8px);
        }

        .prism-modal-content {
            animation: prismFadeIn 0.3s ease-out;
        }

        @keyframes prismFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Adjust indicator positions when Prism is active */
        .indicators-with-prism {
            margin-left: 8px;
        }
        
        /* Rotation utility */
        .rotate-180 {
            transform: rotate(180deg);
        }

        .transition-transform {
            transition: transform 0.2s ease;
        }

        /* Media generation loading */
        .media-generating {
            background: linear-gradient(45deg, #f3f4f6, #e5e7eb);
            background-size: 400% 400%;
            animation: gradientShift 2s ease-in-out infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Art style selector */
        .art-style-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .art-style-option, .music-style-option {
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .art-style-option.selected, .music-style-option.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }

        /* Video player styles */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 512px;
            margin: 0 auto;
        }

        .video-container video {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        /* Audio player styles */
        .audio-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            text-align: center;
        }

        .audio-container audio {
            width: 100%;
            margin-top: 15px;
        }

        /* File upload preview */
        .file-preview {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 8px 12px;
            margin: 4px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .dark .file-preview {
            background: #374151;
            border-color: #6b7280;
        }

        /* Aria submenu styles */
        .aria-submenu {
            position: absolute;
            left: 100%;
            top: 0;
            min-width: 200px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transform: translateX(-10px);
            transition: all 0.3s ease;
        }
        .dark .aria-submenu {
            background: #374151;
            border-color: #6b7280;
        }
        .aria-parent:hover .aria-submenu {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        /* Artifact styles */
        .artifact-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            color: white;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .artifact-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }
        .artifact-animation {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        /* Canvas styles */
        .canvas-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
        }
        .canvas-container {
            position: relative;
            width: 90vw;
            height: 90vh;
            max-width: 1200px;
            margin: 5vh auto;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .dark .canvas-container {
            background: #1f2937;
        }
        .canvas-header {
            background: #f8f9fa;
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dark .canvas-header {
            background: #374151;
            border-color: #6b7280;
        }
        .canvas-content {
            flex: 1;
            display: flex;
        }
        .canvas-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .canvas-iframe {
            flex: 1;
            border: none;
            background: white;
        }
        .canvas-console {
            height: 200px;
            background: #1a1a1a;
            color: #e5e5e5;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 12px;
            overflow-y: auto;
            border-top: 1px solid #444;
        }
        .canvas-tabs {
            display: flex;
            background: #e5e7eb;
            border-bottom: 1px solid #d1d5db;
        }
        .dark .canvas-tabs {
            background: #4b5563;
            border-color: #6b7280;
        }
        .canvas-tab {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .canvas-tab.active {
            background: white;
            border-bottom-color: #3b82f6;
        }
        .dark .canvas-tab.active {
            background: #1f2937;
        }
        .code-editor {
            flex: 1;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: none;
            outline: none;
            padding: 16px;
            background: white;
            resize: none;
        }
        .dark .code-editor {
            background: #1f2937;
            color: #e5e5e5;
        }

        /* Agent styles */
        .agent-view {
            position: fixed;
            inset: 0;
            background: white;
            z-index: 100;
        }
        .dark .agent-view {
            background: #111827;
        }
        .agent-columns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            height: calc(100vh - 200px);
            overflow: hidden;
        }
        .agent-column {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            overflow-y: auto;
            border: 2px solid #e5e7eb;
        }
        .dark .agent-column {
            background: #1f2937;
            border-color: #374151;
        }
        .agent-column h3 {
            font-weight: bold;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }
        .dark .agent-column h3 {
            border-color: #4b5563;
        }

        /* Font families */
        .font-sans { font-family: system-ui, -apple-system, sans-serif; }
        .font-serif { font-family: Georgia, serif; }
        .font-mono { font-family: 'Courier New', monospace; }

        /* Custom backgrounds */
        .bg-custom {
            background-image: var(--custom-bg);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* ÃƒÂ©Ã‚Â»Ã‹Å“ÃƒÂ¨Ã‚Â®Ã‚Â¤ÃƒÂ¨Ã‚ÂÃ… ÃƒÂ¥Ã‚Â¤Ã‚Â©ÃƒÂ¨Ã†â€™Ã…â€™ÃƒÂ¦Ã¢â€žÂ¢Ã‚Â¯ */
        #chatContainer {
            background-image: url('background.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Quick action buttons */
        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }
        .quick-action-btn {
            padding: 10px 20px;  /* ÃƒÂ¤Ã‚Â»Ã…Â½ 6px 12px ÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¹ÃƒÂ¤Ã‚Â¸Ã‚Âº 10px 20px */
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            background: #f9fafb;
            color: #6b7280;
            font-size: 14px;  /* ÃƒÂ¤Ã‚Â»Ã…Â½ 12px ÃƒÂ¦Ã¢â‚¬ÂÃ‚Â¹ÃƒÂ¤Ã‚Â¸Ã‚Âº 14px */
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;  /* ÃƒÂ¦Ã¢â‚¬â€œÃ‚Â°ÃƒÂ¥Ã‚Â¢Ã…Â¾ÃƒÂ¯Ã‚Â¼Ã…Â¡ÃƒÂ¨Ã‚Â®Ã‚Â©ÃƒÂ¦Ã¢â‚¬â€œÃ¢â‚¬Â¡ÃƒÂ¥Ã‚Â­Ã¢â‚¬â€ÃƒÂ¦Ã¢â‚¬ÂºÃ‚Â´ÃƒÂ§Ã‚Â²Ã¢â‚¬â€ÃƒÂ¤Ã‚Â¸Ã¢â€šÂ¬ÃƒÂ§Ã¢â‚¬Å¡Ã‚Â¹ */
        }
        .quick-action-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        .dark .quick-action-btn {
            background: #374151;
            border-color: #4b5563;
            color: #9ca3af;
        }
        .dark .quick-action-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100vw;
            }
            .canvas-container {
                width: 95vw;
                height: 95vh;
                margin: 2.5vh auto;
            }
            .agent-columns {
                grid-template-columns: 1fr;
                height: auto;
            }
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {}
            }
        }
    </script>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-white min-h-screen flex flex-col">
    <!-- Debug Overlay (Ctrl+Shift+D) -->
    <div id="debugOverlay" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden overflow-auto">
        <div class="p-6 text-green-400 font-mono text-sm">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl">Debug Console</h2>
                <button id="closeDebug" class="text-white hover:text-red-400">x</button>
            </div>
            <div id="debugContent" class="whitespace-pre-wrap"></div>
        </div>
    </div>

    <div id="youtubePopup" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-8 max-w-3xl w-full mx-4 transform transition-all duration-500 scale-95 hover:scale-100 shadow-2xl flex items-center gap-8">
            <div class="flex-1 text-left">
                <i class="fab fa-youtube text-5xl text-red-600 mb-4"></i>
                <h2 class="text-3xl font-bold mb-3">TyloAI YouTube Channel is Live!</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6 text-lg">
                    Join our official YouTube channel for tutorials, feature showcases, and exciting AI content!
                </p>
                <div class="flex flex-col space-y-3">
                    <a href="https://www.youtube.com/channel/UCHYEPXnBtHmaLF3pOIGhwUw" target="_blank" 
                    class="bg-red-600 text-white py-3 px-6 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center text-base font-semibold transform hover:scale-105">
                        <i class="fab fa-youtube mr-2"></i>
                        Visit Our Channel
                    </a>
                    <button id="dontShowToday" class="bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        Don't show today
                    </button>
                </div>
            </div>
            <div class="flex-1 hidden md:flex items-center justify-center">
                <lottie-player src="https://assets7.lottiefiles.com/packages/lf20_sF7uci.json" background="transparent" speed="1" style="width: 300px; height: 300px;" loop autoplay></lottie-player>
            </div>
            <button id="closeYoutubePopup" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorialOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden items-center justify-center overflow-y-auto">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-2xl mx-4 my-8">
            <h3 class="text-2xl font-bold mb-6 text-center">Welcome to TyloAI!</h3>
            <div id="tutorialContent">
                <!-- Step 1: User Information -->
                <div id="tutorialStep1" class="tutorial-step">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Your Name / Username</label>
                            <input id="tutorialUsername" type="text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" placeholder="Enter your name" maxlength="30">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Select Your Region</label>
                            <select id="tutorialRegion" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                                <option value="">-- Select Region --</option>
                                <option value="cn">China (including Hong Kong, Macau, Taiwan)</option>
                                <option value="us">United States</option>
                                <option value="eu">Europe</option>
                                <option value="jp">Japan</option>
                                <option value="kr">South Korea</option>
                                <option value="sea">Southeast Asia</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        
                        <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg space-y-3">
                            <label class="flex items-start cursor-pointer">
                                <input type="checkbox" id="tutorialPrivacy" class="mt-1 mr-3">
                                <span class="text-sm">
                                    I have read and agree to the 
                                    <a href="https://protoetic.com/privacy" target="_blank" class="text-blue-500 hover:underline">Privacy Policy</a> 
                                    and 
                                    <a href="https://protoetic.com/terms" target="_blank" class="text-blue-500 hover:underline">Terms of Service</a>
                                </span>
                            </label>
                            
                            <label class="flex items-start cursor-pointer">
                                <input type="checkbox" id="tutorialAge" class="mt-1 mr-3">
                                <span class="text-sm font-semibold text-red-600 dark:text-red-400">
                                    I confirm that I am 18 years of age or older (or have reached the legal age of majority in my jurisdiction)
                                </span>
                            </label>
                        </div>
                        
                        <p id="tutorialError" class="text-red-500 text-sm hidden">Please complete all required fields and agreements</p>
                        
                        <button id="tutorialNextBtn1" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed" disabled onclick="validateAndNextStep()">Next</button>
                    </div>
                </div>

                <!-- Step 2: Feature Introduction -->
                <div id="tutorialStep2" class="tutorial-step hidden">
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold">Quick Tour</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-blue-50 dark:bg-blue-900 rounded-lg">
                                <i class="fas fa-robot text-2xl text-blue-500 mb-2"></i>
                                <h5 class="font-semibold mb-1">AI Models</h5>
                                <p class="text-sm">Choose from multiple AI models including Ode-6 and Ode-6-Flash for different use cases</p>
                            </div>
                            <div class="p-4 bg-green-50 dark:bg-green-900 rounded-lg">
                                <i class="fas fa-coins text-2xl text-green-500 mb-2"></i>
                                <h5 class="font-semibold mb-1">Points System</h5>
                                <p class="text-sm">Earn and use points for AI interactions. Daily check-ins and achievements reward you!</p>
                            </div>
                            <div class="p-4 bg-purple-50 dark:bg-purple-900 rounded-lg">
                                <i class="fas fa-brain text-2xl text-purple-500 mb-2"></i>
                                <h5 class="font-semibold mb-1">Extended Thinking</h5>
                                <p class="text-sm">Enable deep reasoning and post-thinking for comprehensive analysis</p>
                            </div>
                            <div class="p-4 bg-orange-50 dark:bg-orange-900 rounded-lg">
                                <i class="fas fa-trophy text-2xl text-orange-500 mb-2"></i>
                                <h5 class="font-semibold mb-1">Achievements</h5>
                                <p class="text-sm">Level up, unlock achievements, and track your progress</p>
                            </div>
                        </div>
                        <button class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600" onclick="nextTutorialStep()">Next</button>
                    </div>
                </div>

                <!-- Step 3: Plans Overview -->
                <div id="tutorialStep3" class="tutorial-step hidden">
                    <div class="space-y-4">
                        <h4 class="text-lg font-semibold">Choose Your Plan</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 border-2 border-gray-300 rounded-lg">
                                <h5 class="font-bold text-lg mb-2">Free</h5>
                                <p class="text-2xl font-bold mb-3">$0<span class="text-sm">/mo</span></p>
                                <ul class="text-sm space-y-1 mb-4">
                                    <li>✔ 3,000 points/day</li>
                                    <li>✔ 5 Post Thinking/month</li>
                                    <li>✔ Ode-6-Flash: 50pts/msg</li>
                                    <li>✔ Ode-6: 300pts/msg</li>
                                </ul>
                            </div>
                            <div class="p-4 border-2 border-blue-500 rounded-lg bg-blue-50 dark:bg-blue-900">
                                <h5 class="font-bold text-lg mb-2">Pro</h5>
                                <p class="text-2xl font-bold mb-3">$9.99<span class="text-sm">/mo</span></p>
                                <ul class="text-sm space-y-1 mb-4">
                                    <li>✔ 6,000 points/day</li>
                                    <li>✔ 15 Post Thinking/month</li>
                                    <li>✔ Ode-6-Flash: Unlimited</li>
                                    <li>✔ Monthly restore once</li>
                                </ul>
                            </div>
                            <div class="p-4 border-2 border-purple-500 rounded-lg bg-purple-50 dark:bg-purple-900">
                                <h5 class="font-bold text-lg mb-2">Max</h5>
                                <p class="text-2xl font-bold mb-3">$29.99<span class="text-sm">/mo</span></p>
                                <ul class="text-sm space-y-1 mb-4">
                                    <li>✔ Unlimited everything</li>
                                    <li>✔ No point limits</li>
                                    <li>✔ Priority support</li>
                                    <li>✔ Early access</li>
                                </ul>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-400 text-center">You can upgrade anytime from settings</p>
                        <button class="w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600" onclick="completeTutorial()">Start Using TyloAI</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Canvas Overlay -->
    <div id="canvasOverlay" class="canvas-overlay hidden">
        <div class="canvas-container">
            <div class="canvas-header">
                <div class="flex items-center">
                    <h3 id="canvasTitle" class="font-bold text-lg">Artifact Canvas</h3>
                    <span id="canvasLanguage" class="ml-3 px-2 py-1 bg-blue-500 text-white text-xs rounded">JavaScript</span>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="refreshCanvas" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                        <i class="fas fa-refresh"></i>
                    </button>
                    <button id="copyCanvasCode" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button id="closeCanvas" class="p-2 hover:bg-gray-200 dark:hover:bg-gray-600 rounded">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="canvas-tabs">
                <div class="canvas-tab active" data-tab="preview">
                    <i class="fas fa-eye mr-2"></i>Preview
                </div>
                <div class="canvas-tab" data-tab="code">
                    <i class="fas fa-code mr-2"></i>Code
                </div>
            </div>
            <div class="canvas-content">
                <div class="canvas-main">
                    <div id="canvasPreview" class="canvas-view">
                        <iframe id="canvasIframe" class="canvas-iframe" sandbox="allow-scripts allow-same-origin allow-forms"></iframe>
                    </div>
                    <div id="canvasCode" class="canvas-view hidden">
                        <textarea id="codeEditor" class="code-editor" placeholder="Code will appear here..."></textarea>
                    </div>
                    <div class="canvas-console">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-gray-400">Console</span>
                            <button id="clearConsole" class="text-xs text-gray-400 hover:text-white">Clear</button>
                        </div>
                        <div id="consoleContent"></div>
                        <div id="fixWithAI" class="hidden mt-2">
                            <button class="bg-red-500 text-white px-3 py-1 text-xs rounded hover:bg-red-600">
                                <i class="fas fa-magic mr-1"></i>Fix with TyloAI
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent View -->
    <div id="agentView" class="agent-view hidden">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center">
                <div>
                    <h2 id="agentTitle" class="text-xl font-bold">Project Title</h2>
                    <p id="agentObjective" class="text-gray-600 dark:text-gray-400 mt-1">Project objective...</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="viewDebateHistory" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">
                        <i class="fas fa-history mr-2"></i>View History
                    </button>
                    <button id="closeAgent" class="p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="flex-1 p-4">
            <div class="agent-columns">
                <div class="agent-column">
                    <h3 data-translate="agent_analysis">Analysis</h3>
                    <div id="agentColumn1" class="agent-content"></div>
                </div>
                <div class="agent-column">
                    <h3 data-translate="agent_synthesis">Synthesis</h3>
                    <div id="agentColumn2" class="agent-content"></div>
                </div>
                <div class="agent-column">
                    <h3 data-translate="agent_conclusion">Conclusion</h3>
                    <div id="agentColumn3" class="agent-content"></div>
                </div>
            </div>
        </div>
        <div class="p-4 border-t border-gray-200 dark:border-gray-700">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                    <textarea id="agentInput" placeholder="Ask your question..." class="w-full p-2 focus:outline-none bg-transparent text-base resize-none" rows="1"></textarea>
                    <div class="flex justify-end mt-2">
                        <button id="agentSendButton" class="bg-black text-white dark:bg-white dark:text-black p-2 rounded-md hover:opacity-80 transition-colors">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed left-0 top-0 h-full w-72 bg-gray-100 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 z-30">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h2 class="text-lg font-semibold" data-translate="chat_history">TyloAI</h2>
            <button id="closeBtn" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-4">
            <button id="newChatBtn" class="w-full py-2 px-4 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center mb-4">
                <i class="fas fa-plus mr-2"></i><span data-translate="new_chat">New Chat</span>
            </button>
            <button id="projectBtn" class="w-full py-2 px-4 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors flex items-center justify-center mb-4">
                <i class="fas fa-project-diagram mr-2"></i><span data-translate="project">Project</span>
            </button>
            <!-- Search Box -->
            <div class="relative mb-4">
                <input id="searchInput" type="text" placeholder="Search chats..." data-translate-placeholder="search_chats" class="w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md text-sm">
                <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
            </div>
        </div>
        <div id="chatHistory" class="p-4 overflow-y-auto custom-scrollbar" style="max-height: calc(100vh - 300px);">
            <div class="space-y-2">
                <p class="text-gray-500 dark:text-gray-400 text-sm" data-translate="no_chat_history">No chat history yet</p>
            </div>
        </div>
        <!-- User Panel -->
        <div id="userPanel" class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
            <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-gray-300 dark:bg-gray-600 flex items-center justify-center mr-3 relative">
                    <img id="userAvatar" src="https://via.placeholder.com/40" alt="User" class="w-full h-full rounded-full object-cover">
                    <div id="levelBadge" class="level-badge absolute -top-1 -right-1 w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold text-white">1</div>
                </div>
                <div class="flex-1">
                    <div class="flex items-center">
                        <span id="userNickname" class="font-medium">User</span>
                        <span id="membershipStatus" class="ml-2 px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs rounded-full" data-translate="free_plan">Free Plan</span>
                    </div>
                    <div class="flex items-center mt-1">
                        <div class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-full h-1 mr-2">
                            <div id="xpProgress" class="progress-bar h-1 rounded-full" style="width: 0%"></div>
                        </div>
                        <span id="xpText" class="text-xs text-gray-500">0/100 XP</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-coins mr-1"></i>
                        <span id="pointsDisplay">3000</span> <span data-translate="points">points</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex flex-col h-screen" id="mainContent">
        <!-- Header -->
        <!-- ä¾§è¾¹æ æŒ‰é’®ç‹¬ç«‹æ”¾ç½® -->
        <div class="fixed top-4 left-4 z-50">
            <button class="sidebar-toggle w-8 h-8 flex items-center justify-center text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md transition-all duration-300 bg-white dark:bg-gray-800 shadow-md mb-4" id="sidebarToggle">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform duration-300">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="9" y1="3" x2="9" y2="21"></line>
                </svg>
            </button>

            <!-- å¯éšè—çš„æŒ‰é’®ç»„ -->
            <div id="collapsibleButtons" class="flex flex-col gap-3 transition-all duration-300">
                <button onclick="startNewChat()" class="w-10 h-10 bg-blue-500 text-white rounded-full flex items-center justify-center shadow-lg hover:bg-blue-600 transform hover:scale-110 transition-all duration-300" aria-label="New Chat">
                    <i class="fas fa-plus"></i>
                </button>
                
                <button onclick="openProjectModal()" class="w-10 h-10 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-full flex items-center justify-center border border-gray-200 dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-600 transform hover:scale-110 transition-all duration-300" aria-label="New Project">
                    <i class="fas fa-project-diagram"></i>
                </button>
            </div>
        </div>

        <!-- åž‚ç›´åˆ†å‰²çº¿ - ç‹¬ç«‹å…ƒç´  -->
        <div id="verticalDivider" class="fixed left-[72px] top-0 h-screen w-px bg-gray-200 dark:bg-gray-700 z-40 transition-opacity duration-300"></div>

        <div class="flex items-center justify-between p-4 pl-16">
            <div class="flex items-center">
                    <style>
                    /* 修复为 */
                    .sidebar-toggle {
                        position: relative !important;
                        z-index: 50 !important;
                        overflow: hidden;
                        width: 32px !important;  /* 从40px减小到32px */
                        height: 32px !important;
                        margin-bottom: 16px !important; /* 增加与下方按钮的距离 */
                    }

                    /* 调整按钮容器间距 */
                    #collapsibleButtons {
                        margin-top: 8px; /* 增加顶部间距 */
                    }

                    #collapsibleButtons button {
                        width: 36px !important;  /* 从40px减小到36px */
                        height: 36px !important;
                    }

                    /* 确保图标尺寸匹配 */
                    #collapsibleButtons button i {
                        font-size: 14px; /* 减小图标 */
                    }

                    /* æŒ‰é’®éšè—åŠ¨ç”» */
                    #collapsibleButtons {
                        opacity: 1;
                        transform: scale(1);
                        pointer-events: auto;
                    }

                    #collapsibleButtons.hidden {
                        opacity: 0;
                        transform: scale(0.8);
                        pointer-events: none;
                        height: 0;
                        overflow: hidden;
                    }

                    /* åˆ†å‰²çº¿åŠ¨ç”» */
                    #verticalDivider {
                        opacity: 1;
                    }

                    #verticalDivider.hidden {
                        opacity: 0;
                    }

                    .sidebar-toggle:hover svg {
                        transform: scale(1.1);
                    }

                    .sidebar-toggle:active svg {
                        transform: scale(0.95);
                    }

                    .sidebar-toggle:hover {
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
                    }

                    .dark .sidebar-toggle:hover {
                        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                    }

                    .sidebar-toggle.active svg {
                        stroke: #3b82f6;
                    }

                    .sidebar-toggle.active {
                        background-color: #dbeafe;
                    }

                    .dark .sidebar-toggle.active {
                        background-color: #1e3a8a;
                    }
                </style>
                <button id="darkModeToggle" class="text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md mr-4">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:block"></i>
                </button>
                <div id="currentChatTitle" class="font-medium hidden"></div>
            </div>
            <div class="flex items-center space-x-2">
                <button id="newsBtn" class="relative text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-all" onclick="window.open('update.html', '_blank')">
                    <i class="fas fa-bell text-xl"></i>
                    <!-- Red dot notification indicator (optional) -->
                    <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                </button>
                <!-- Points Container -->
                <div id="pointsContainer" class="flex items-center bg-white dark:bg-gray-800 border-2 border-gray-300 dark:border-gray-600 px-3 py-1 rounded-lg">
                    <i class="fas fa-coins mr-2 text-gray-600 dark:text-gray-400"></i>
                    <span id="headerPointsDisplay" class="font-bold text-gray-800 dark:text-gray-200">3000</span>
                    <button id="addPointsBtn" class="ml-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded w-6 h-6 flex items-center justify-center transition-all">
                        <i class="fas fa-plus text-sm text-gray-600 dark:text-gray-400"></i>
                    </button>
                </div>
                <!-- Settings Button -->
                <button id="settingsBtn" class="text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chatContainer" class="flex-grow overflow-auto p-4 custom-scrollbar">
            <div class="max-w-4xl mx-auto">
                <!-- Initial View -->
                <div id="initialView" class="flex flex-col items-center justify-center" style="margin-top: 12vh;">
                    <!-- Plan Status -->
                    <div id="planStatus" class="mb-4 cursor-pointer" onclick="openUpgradeModal()">
                        <div class="flex items-center text-sm text-gray-600 dark:text-gray-400">
                            <span id="planText" data-translate="free_plan">Free Plan</span>
                            <span class="ml-2 text-blue-500 hover:text-blue-600" data-translate="upgrade">Upgrade</span>
                        </div>
                    </div>
                    
                    <!-- Greeting -->
                    <div class="text-3xl font-semibold mb-8 flex items-center text-center">
                        <img src="logo.png" alt="TyloAI Logo" class="w-10 h-10 mr-3 rounded-full"> 
                        <span id="timeGreeting">TyloAI is ready</span>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="w-full max-w-2xl">
                        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4 mb-4 input-container transition-all">
                            <textarea id="userInput" placeholder="Ask TyloAI anything..." data-translate-placeholder="ask_anything" class="w-full p-2 focus:outline-none bg-transparent text-base resize-none" rows="1"></textarea>
                            
                            <!-- File Previews -->
                            <div id="filePreviewContainer" class="hidden mt-3 max-h-32 overflow-y-auto">
                            </div>
                            
                            <!-- AI Suggestions -->
                            <div id="aiSuggestions" class="hidden mt-2 text-sm text-gray-500 suggestion-fade">
                                <i class="fas fa-lightbulb mr-1"></i>
                                <span id="suggestionText">Try asking about: "Explain quantum computing" or "Help me write an email"</span>
                            </div>
                            
                            
                            
                            <!-- Media Generation Options -->
                            <div id="mediaOptions" class="hidden mt-4 space-y-4">
                                <!-- Image Options -->
                                <div id="imageOptions" class="hidden space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2" data-translate="art_style">Art Style</label>
                                        <div class="art-style-grid">
                                            <div class="art-style-option selected p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="photorealistic">
                                                <i class="fas fa-camera text-lg mb-1"></i>
                                                <div class="text-xs">Photo</div>
                                            </div>
                                            <div class="art-style-option p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="digital_art">
                                                <i class="fas fa-palette text-lg mb-1"></i>
                                                <div class="text-xs">Digital</div>
                                            </div>
                                            <div class="art-style-option p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="oil_painting">
                                                <i class="fas fa-paint-brush text-lg mb-1"></i>
                                                <div class="text-xs">Oil Paint</div>
                                            </div>
                                            <div class="art-style-option p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="watercolor">
                                                <i class="fas fa-tint text-lg mb-1"></i>
                                                <div class="text-xs">Watercolor</div>
                                            </div>
                                            <div class="art-style-option p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="anime">
                                                <i class="fas fa-star text-lg mb-1"></i>
                                                <div class="text-xs">Anime</div>
                                            </div>
                                            <div class="art-style-option p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="sketch">
                                                <i class="fas fa-pencil-alt text-lg mb-1"></i>
                                                <div class="text-xs">Sketch</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2" data-translate="number_of_images">Number of Images</label>
                                        <div class="flex space-x-2">
                                            <button id="imageCount1" class="flex-1 py-2 px-3 bg-blue-500 text-white rounded-md text-sm">1 Image</button>
                                            <button id="imageCount2" class="flex-1 py-2 px-3 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md text-sm">2 Images</button>
                                        </div>
                                        <div id="imageCountInfo" class="text-xs text-gray-500 mt-1" data-translate="image_limit_info">Free users: 1 generation of 2 images per day, then 1 image per generation</div>
                                    </div>
                                </div>

                                <!-- Music Options -->
                                <div id="musicOptions" class="hidden space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2" data-translate="music_style">Music Style</label>
                                        <div class="art-style-grid">
                                            <div class="music-style-option selected p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="pop">
                                                <i class="fas fa-music text-lg mb-1"></i>
                                                <div class="text-xs">Pop</div>
                                            </div>
                                            <div class="music-style-option p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="rock">
                                                <i class="fas fa-guitar text-lg mb-1"></i>
                                                <div class="text-xs">Rock</div>
                                            </div>
                                            <div class="music-style-option p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="jazz">
                                                <i class="fas fa-saxophone text-lg mb-1"></i>
                                                <div class="text-xs">Jazz</div>
                                            </div>
                                            <div class="music-style-option p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="classical">
                                                <i class="fas fa-violin text-lg mb-1"></i>
                                                <div class="text-xs">Classical</div>
                                            </div>
                                            <div class="music-style-option p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="electronic">
                                                <i class="fas fa-headphones text-lg mb-1"></i>
                                                <div class="text-xs">Electronic</div>
                                            </div>
                                            <div class="music-style-option p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer text-center" data-style="acoustic">
                                                <i class="fas fa-guitar text-lg mb-1"></i>
                                                <div class="text-xs">Acoustic</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center mt-2">
                                <div class="flex items-center space-x-2">
                                    <div id="normalInputButtons" class="flex items-center space-x-2"></div>
                                <!-- File Upload Button -->
                                <button id="uploadBtn" class="p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                                    <i class="fas fa-paperclip"></i>
                                </button>
                                <input type="file" id="fileInput" class="hidden" multiple accept=".txt,.pdf,.docx,.png,.jpg,.jpeg">
                                
                                <!-- Advanced Options Button Container -->
                                <div class="relative">
                                    <button id="advancedOptionsBtn" class="p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <!-- Prism Connect Button -->
                                    <button id="prismConnectBtn" class="p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-all" title="Connect to Prism">
                                        <img id="prismIcon" src="prism.png" alt="Prism" class="w-5 h-5">
                                    </button>

                                    <div id="advancedOptionsMenu" class="dropdown-options absolute bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg w-48" style="top: 40px; left: 0; z-index: 1000;">
                                        <div class="p-2">
                                            <div id="deepThinkingOption" class="dropdown-option aria-parent relative p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded">
                                                <div class="flex items-center justify-between">
                                                    <span><i class="fas fa-brain mr-2"></i>Extended Thinking</span>
                                                    <i class="fas fa-chevron-right text-xs ml-2"></i>
                                                </div>
                                                <div class="aria-submenu" style="left: 100%; top: 0;">
                                                    <div class="p-2">
                                                        <div id="normalThinkingOption" class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded">
                                                            <i class="fas fa-lightbulb mr-2"></i>Extended Thinking <span class="option-cost text-xs">(+100 pts)</span>
                                                        </div>
                                                        <div id="postThinkingOption" class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded">
                                                            <i class="fas fa-brain mr-2"></i>Post Thinking <span class="option-limit">(<span id="postThinkingCount">5</span>/month)</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="webSearchOption" class="dropdown-option p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded">
                                                <i class="fas fa-search mr-2"></i>Web Search <span class="option-cost text-xs">(+100 pts)</span>
                                            </div>
                                            <div id="codingModeOption" class="dropdown-option p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded">
                                                <i class="fas fa-terminal mr-2"></i>Coding Mode <span class="option-cost text-xs">(+100 pts)</span>
                                            </div>
                                            <div class="border-t border-gray-200 dark:border-gray-600 my-2"></div>
                                            <div id="skillModeOption" class="dropdown-option aria-parent relative p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded">
                                                <div class="flex items-center justify-between">
                                                    <span><i class="fas fa-star mr-2"></i>Skills</span>
                                                    <i class="fas fa-chevron-right text-xs ml-2"></i>
                                                </div>
                                                <div class="aria-submenu" style="left: 100%; top: 0;">
                                                    <div class="p-2">
                                                        <div id="skillWritingOption" class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-skill="writing">
                                                            <i class="fas fa-feather-alt mr-2"></i>Writing
                                                        </div>
                                                        <div id="skillStudyOption" class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-skill="study">
                                                            <i class="fas fa-graduation-cap mr-2"></i>Work & Study
                                                        </div>
                                                        <div id="skillCreativeOption" class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-skill="creative">
                                                            <i class="fas fa-palette mr-2"></i>Creative Support
                                                        </div>
                                                        <div id="skillLifeOption" class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-skill="life">
                                                            <i class="fas fa-heart mr-2"></i>Life Companion
                                                        </div>
                                                        <div id="skillPlanningOption" class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-skill="planning">
                                                            <i class="fas fa-tasks mr-2"></i>Smart Planning
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="styleSelector" class="relative aria-parent">
                                                <div class="dropdown-option p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded flex items-center justify-between">
                                                    <span><i class="fas fa-feather mr-2"></i>Style: <span id="currentStyle">Normal</span></span>
                                                    <i class="fas fa-chevron-right text-xs ml-2"></i>
                                                </div>
                                                <div class="aria-submenu" style="left: 100%; top: 0;">
                                                    <div class="p-2">
                                                        <div class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-style="normal">
                                                            Normal
                                                        </div>
                                                        <div class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-style="concise">
                                                            Concise
                                                        </div>
                                                        <div class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-style="formal">
                                                            Formal
                                                        </div>
                                                        <div class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-style="explanatory">
                                                            Explanatory
                                                        </div>
                                                        <div class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-style="casual">
                                                            Casual/Forum Style
                                                        </div>
                                                        <div class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-style="artistic">
                                                            Artistic Style
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Thinking Indicators -->
                                <div id="normalThinkingIndicator" class="hidden p-2 bg-blue-500 text-white rounded cursor-pointer hover:bg-red-500" onclick="cancelNormalThinking()">
                                    <i class="fas fa-lightbulb"></i>
                                </div>
                                <div id="postThinkingIndicator" class="hidden p-2 bg-purple-500 text-white rounded cursor-pointer hover:bg-red-500" onclick="cancelPostThinking()">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <!-- Style Indicator -->
                                <div id="styleIndicator" class="hidden p-2 bg-gray-500 text-white rounded text-xs">
                                    <span id="styleIndicatorText">Normal</span>
                                </div>
                                
                                <!-- Search Indicator -->
                                <div id="searchIndicator" class="hidden p-2 bg-green-500 text-white rounded">
                                    <i class="fas fa-globe"></i>
                                </div>
                                <!-- Coding Mode Indicator -->
                                <div id="codingIndicator" class="hidden p-2 bg-purple-500 text-white rounded cursor-pointer" onclick="cancelCodingMode()">
                                    <i class="fas fa-laptop-code"></i>
                                </div>
                                <!-- Skill Mode Indicator -->
                                <div id="skillIndicator" class="hidden p-2 bg-pink-500 text-white rounded cursor-pointer" onclick="cancelSkillMode()">
                                    <i class="fas fa-feather-alt"></i>
                                </div>
                                <!-- Coding mode tools section -->
                                <div id="codingModeTools" class="hidden items-center space-x-3">
                                    <span class="text-sm text-gray-600 dark:text-gray-400">Connect your tools to TyloAI</span>
                                    <button class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center transition-colors" onclick="showToolModal('github')">
                                        <i class="fab fa-github"></i>
                                    </button>
                                    <button class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center transition-colors" onclick="showToolModal('canvas')">
                                        <i class="fas fa-palette"></i>
                                    </button>
                                    <button class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center transition-colors" onclick="showToolModal('google')">
                                        <i class="fab fa-google"></i>
                                    </button>
                                    <button class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 flex items-center justify-center transition-colors" onclick="showToolModal('prism')">
                                        <img src="prism.png" alt="Prism" class="w-5 h-5">
                                    </button>
                                </div>
                                </div>
                                <div class="flex items-center">
                                    <!-- Model Selector -->
                                    <div id="modelSelector" class="relative mr-2">
                                        <div class="dropdown-selected cursor-pointer p-2 border border-gray-300 dark:border-gray-600 rounded-lg">
                                            <span id="modelDisplayName">Ode-6-Flash</span>
                                            <i class="fas fa-chevron-down ml-2 text-xs"></i>
                                        </div>
                                        <div id="modelOptions" class="dropdown-options absolute top-full right-0 mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-2 w-56" style="z-index: 100;">
                                            <div class="dropdown-option selected p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-value="ode-6-flash" data-cost="50">
                                                Ode-6-Flash <span class="model-cost text-xs text-blue-500">50 pts</span>
                                            </div>
                                            <div class="dropdown-option p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-value="ode-6" data-cost="300">
                                                Ode-6 <span class="model-cost text-xs text-blue-500">300 pts</span>
                                            </div>
                                            <div class="dropdown-option aria-parent relative p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded flex items-center justify-between">
                                                <span>Aria Series <i class="fas fa-chevron-right text-xs ml-2"></i></span>
                                                <div class="aria-submenu">
                                                    <div class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-value="tylo-aria-image" data-cost="1000">
                                                        <i class="fas fa-image mr-2"></i>Tylo-Aria-Image
                                                        <div class="text-xs text-purple-500 mt-1">Visual (1000pts)</div>
                                                    </div>
                                                    <div class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-value="tylo-aria-video" data-cost="3000">
                                                        <i class="fas fa-video mr-2"></i>Tylo-Aria-Video
                                                        <div class="text-xs text-red-500 mt-1">Video (3000pts)</div>
                                                    </div>
                                                    <div class="dropdown-option p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-value="tylo-aria-music" data-cost="3000">
                                                        <i class="fas fa-music mr-2"></i>Tylo-Aria-Music
                                                        <div class="text-xs text-pink-500 mt-1">Music (3000pts)</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button id="sendButton" class="bg-black text-white dark:bg-white dark:text-black p-2 rounded-md hover:opacity-80 transition-colors relative">
                                        <i id="sendIcon" class="fas fa-arrow-up"></i>
                                        <i id="stopIcon" class="fas fa-stop hidden"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Quick Actions Section -->
                        <div class="mt-4">
                            <div class="flex space-x-2 mb-3">
                                <button id="agentBtn" class="quick-action-button px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm hover:border-blue-500 hover:text-blue-500 transition-colors relative">
                                    Agent - Multimodal Collaboration
                                    <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs px-1 rounded">New</span>
                                </button>
                                <button id="programmingBtn" class="quick-action-button px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm hover:border-blue-500 hover:text-blue-500 transition-colors">
                                    <i class="fas fa-code mr-1"></i>Programming
                                </button>
                                <button id="writingBtn" class="quick-action-button px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm hover:border-blue-500 hover:text-blue-500 transition-colors">
                                    <i class="fas fa-pen mr-1"></i>Writing
                                </button>
                                <button id="analysisBtn" class="quick-action-button px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm hover:border-blue-500 hover:text-blue-500 transition-colors">
                                    <i class="fas fa-list-ol mr-1"></i>Analysis
                                </button>
                                <button id="callBtn" class="quick-action-button px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded-md text-sm hover:border-blue-500 hover:text-blue-500 transition-colors">
                                    <i class="fas fa-phone mr-1"></i>Call
                                </button>
                            </div>
                            
                            <!-- Content Cards for Agent/Programming -->
                            <div id="quickActionContent" class="hidden">
                                <!-- Programming Cards -->
                                <div id="programmingCards" class="hidden grid grid-cols-3 gap-3">
                                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 cursor-pointer hover:shadow-lg transition-shadow" onclick="window.open('feedback.html', '_blank')">
                                        <img src="https://p3-flow-imagex-sign.byteimg.com/ocean-cloud-tos/image_generation/b4c1d9839348c28d36ca4b760374875d_1756985490247598204.png~tplv-a9rns2rl98-image.png?rk3s=25bff839&x-expires=2072345490&x-signature=N32OOWsbBzWLz9sVXkCV%2BvmIJpU%3D" alt="Feedback" class="w-full h-32 object-cover rounded mb-2">
                                        <p class="text-sm text-center" title="Join Now">Share Your Thoughts</p>
                                    </div>
                                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 cursor-pointer hover:shadow-lg transition-shadow" onclick="sendPresetMessage('Help me program a Gomoku game')">
                                        <img src="https://p3-flow-imagex-sign.byteimg.com/ocean-cloud-tos/image_generation/c93ed2820063b71db01b7726a88de808_1752461681262187757.png~tplv-a9rns2rl98-image.png?rk3s=25bff839&x-expires=1783997681&x-signature=ZEv5AhMUosurpCs5Uw9uIgtAepI%3D" alt="Gomoku" class="w-full h-32 object-cover rounded mb-2">
                                        <p class="text-sm text-center">Gomoku Game</p>
                                    </div>
                                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-3 cursor-pointer hover:shadow-lg transition-shadow" onclick="sendPresetMessage('Help me create a SaaS website')">
                                        <img src="https://p9-flow-imagex-sign.byteimg.com/ocean-cloud-tos/image_generation/0df90499a96a18a0257fdd81adb902b7_1751944995022103460.png~tplv-a9rns2rl98-image.png?rk3s=25bff839&x-expires=1783480995&x-signature=BXvpnA%2BlO0QpMRE%2Fqa%2FErdIUWas%3D" alt="SaaS" class="w-full h-32 object-cover rounded mb-2">
                                        <p class="text-sm text-center">SaaS Website</p>
                                    </div>
                                </div>
                                
                                <!-- Writing Options -->
                                <div id="writingOptions" class="hidden space-y-2">
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Help me write a clear and well-structured email')">
                                        <i class="fas fa-envelope mr-2"></i>Write a clear email
                                    </div>
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Help me write a letter to my teacher about my absence today')">
                                        <i class="fas fa-edit mr-2"></i>Write an absence letter
                                    </div>
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Help me write a deep and insightful review of Avatar 2')">
                                        <i class="fas fa-film mr-2"></i>Write a movie review
                                    </div>
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Help me write a concise and organized meeting minutes, including key discussion points and action items')">
                                        <i class="fas fa-sticky-note mr-2"></i>Write meeting minutes
                                    </div>
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Help me write a polite email to my professor asking for clarification on the recent homework requirements')">
                                        <i class="fas fa-question-circle mr-2"></i>Write homework inquiry
                                    </div>
                                    <!-- ç¤¾äº¤åœºæ™¯ï¼šç¤¾äº¤åª’ä½“æ–‡æ¡ˆï¼ˆäº§å“æŽ¨å¹¿/ç”Ÿæ´»åˆ†äº«ï¼‰ -->
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Help me write an engaging social media post to promote my handcrafted products, including key features and purchase links')">
                                        <i class="fas fa-share-alt mr-2"></i>Write social post
                                    </div>
                                </div>
                                
                                <!-- Analysis Options -->
                                <div id="analysisOptions" class="hidden space-y-2">
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Analyze this data and provide insights')">
                                        <i class="fas fa-chart-bar mr-2"></i>Data Analysis
                                    </div>
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Help me analyze market trends')">
                                        <i class="fas fa-chart-line mr-2"></i>Market Trends
                                    </div>
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Help me analyze how to visualize this sales data including monthly revenue and regional distribution and recommend suitable charts e.g., line chart, bar chart')">
                                        <i class="fas fa-chart-pie mr-2"></i>Data Visualization
                                    </div>
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Help me analyze the Excel data including user retention rate and activity frequency and extract key conclusions to support product optimization')">
                                        <i class="fas fa-file-excel mr-2"></i>Excel Data Insights
                                    </div>
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Help me analyze the core data of 3 competitors including market share, pricing strategy, and user reviews and summarize our competitive advantages')">
                                        <i class="fas fa-users-viewfinder mr-2"></i>Competitor Data Analysis
                                    </div>
                                </div>
                                
                                <!-- Learning Options -->
                                <div id="learningOptions" class="hidden space-y-2">
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Explain quantum computing in simple terms')">
                                        <i class="fas fa-atom mr-2"></i>Learn Quantum Computing
                                    </div>
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Teach me Python programming basics')">
                                        <i class="fas fa-code mr-2"></i>Learn Python
                                    </div>
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Teach me JavaScript basics, including variables, functions, and DOM manipulation with simple examples')">
                                        <i class="fas fa-file-code mr-2"></i>Learn JavaScript
                                    </div>
                                    <div class="p-2 border border-gray-200 dark:border-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-800" onclick="sendPresetMessage('Teach me advanced Excel skills, such as VLOOKUP, PivotTables, and conditional formatting for data analysis')">
                                        <i class="fas fa-table mr-2"></i>Learn Advanced Excel
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Chat View -->
                <div id="chatView" class="hidden">
                    <!-- Messages will be added here -->
                </div>
            </div>
        </div>
        
        <!-- Bottom Input Area -->
        <div id="bottomInputArea" class="hidden p-4">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-4">
                    <textarea id="replyInput" placeholder="Reply to TyloAI..." data-translate-placeholder="reply_to" class="w-full p-2 focus:outline-none bg-transparent text-base resize-none" rows="1"></textarea>
                    
                    <!-- File Previews for Reply -->
                    <div id="replyFilePreviewContainer" class="hidden mt-3 max-h-32 overflow-y-auto">
                    </div>
                    
                    <div class="flex justify-between items-center mt-2">
                        <div class="flex items-center space-x-2">
                            <button id="replyUploadBtn" class="p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="file" id="replyFileInput" class="hidden" multiple accept=".txt,.pdf,.docx,.png,.jpg,.jpeg">
                            <button class="p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                                <i class="fas fa-feather"></i>
                            </button>
                        </div>
                        <div class="flex items-center">
                            <div class="relative mr-2">
                                <div class="dropdown-selected cursor-pointer p-2 border border-gray-300 dark:border-gray-600 rounded-lg">
                                    <span id="replyModelName">Ode-6-Flash</span>
                                    <i class="fas fa-chevron-down ml-2 text-xs"></i>
                                </div>
                            </div>
                            <button id="replySendButton" class="bg-black text-white dark:bg-white dark:text-black p-2 rounded-md hover:opacity-80 transition-colors">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedbackModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4" data-translate="feedback_title">Help us improve</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4" data-translate="feedback_description">What wasn't helpful about this response?</p>
            
            <div class="space-y-2 mb-4">
                <label class="flex items-center">
                    <input type="radio" name="feedbackType" value="harmful" class="mr-2">
                    <span data-translate="feedback_harmful">Harmful or inappropriate content</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="feedbackType" value="false" class="mr-2">
                    <span data-translate="feedback_false">False or misleading information</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="feedbackType" value="unhelpful" class="mr-2">
                    <span data-translate="feedback_unhelpful">Not helpful</span>
                </label>
                <label class="flex items-center">
                    <input type="radio" name="feedbackType" value="other" class="mr-2">
                    <span data-translate="feedback_other">Other</span>
                </label>
            </div>
            
            <textarea id="feedbackText" class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" rows="3" placeholder="Additional details (optional)" data-translate-placeholder="feedback_details"></textarea>
            
            <div class="flex space-x-2 mt-4">
                <button id="submitFeedback" class="flex-1 bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600" data-translate="submit">Submit</button>
                <button id="closeFeedbackModal" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-md hover:bg-gray-400 dark:hover:bg-gray-700" data-translate="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Project Creation Modal -->
    <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4" data-translate="create_project">Create New Project</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2" data-translate="project_title">Project Title</label>
                <input id="projectTitle" type="text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" placeholder="Enter project title" data-translate-placeholder="enter_project_title">
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2" data-translate="project_objective">Project Objective</label>
                <textarea id="projectObjective" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" rows="3" placeholder="Describe the main goal and objective of this project" data-translate-placeholder="enter_project_objective"></textarea>
            </div>
            
            <div class="flex space-x-2">
                <button id="createProject" class="flex-1 bg-purple-500 text-white py-2 rounded-md hover:bg-purple-600" data-translate="create">Create</button>
                <button id="closeProjectModal" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-md hover:bg-gray-400 dark:hover:bg-gray-700" data-translate="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Points Redemption Modal -->
    <div id="pointsModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-sm mx-4 transform transition-all duration-300 scale-95 hover:scale-100">
            <h3 class="text-xl font-bold mb-4 flex items-center">
                <i class="fas fa-coins text-yellow-500 mr-2"></i>
                <span id="pointsModalTitle" data-translate="redeem_points">Redeem Points</span>
            </h3>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2" data-translate="redemption_code">Enter Redemption Code</label>
                <input id="pointsCodeInput" type="text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" placeholder="Please enter redemption code" data-translate-placeholder="enter_redemption_code">
            </div>
            <div class="flex space-x-2">
                <button id="redeemPointsBtn" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 text-white py-2 rounded-md hover:from-green-600 hover:to-emerald-600 transition-all transform hover:scale-105">
                    <i class="fas fa-check mr-2"></i><span data-translate="redeem">Redeem</span>
                </button>
                <button id="closePointsModal" class="px-4 py-2 bg-gray-300 dark:bg-gray-600 rounded-md hover:bg-gray-400 dark:hover:bg-gray-700" data-translate="cancel">Cancel</button>
            </div>
            <div id="pointsMessage" class="mt-3 text-sm hidden"></div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div id="upgradeModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-8 max-w-4xl mx-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold mb-2" data-translate="choose_plan">Choose Your Plan</h2>
                <p class="text-gray-600 dark:text-gray-400" data-translate="plan_description">Select the plan that works best for you</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <!-- Free Plan -->
                <div class="border border-gray-200 dark:border-gray-700 rounded-xl p-6">
                    <h3 class="text-xl font-bold mb-2">Free</h3>
                    <div class="text-3xl font-bold mb-4">$0<span class="text-lg text-gray-500">/month</span></div>
                    <ul class="space-y-2 mb-6 text-sm">
                        <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>3,000 points/day</li>
                        <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>5 Post Thinking/month</li>
                        <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Ode-6-Flash: 50 pts/msg</li>
                        <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Ode-6: 300 pts/msg</li>
                        <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Extended Thinking: +100 pts</li>
                        <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Web Search: +100 pts</li>
                        <li class="flex items-center"><i class="fas fa-check text-green-500 mr-2"></i>Daily check-in streak bonus</li>
                    </ul>
                    <button class="w-full bg-gray-300 text-gray-700 py-2 rounded-md" disabled>Current Plan</button>
                </div>

                <!-- Pro Plan -->
                <div class="border border-blue-200 dark:border-blue-700 rounded-xl p-6 bg-blue-50 dark:bg-blue-900">
                    <h3 class="text-xl font-bold mb-2">Pro</h3>
                    <div class="text-3xl font-bold mb-4">$9.99<span class="text-lg text-gray-500">/month</span></div>
                    <ul class="space-y-2 mb-6 text-sm">
                        <li class="flex items-center"><i class="fas fa-check text-blue-500 mr-2"></i>6,000 points/day</li>
                        <li class="flex items-center"><i class="fas fa-check text-blue-500 mr-2"></i>15 Post Thinking/month (3 periods)</li>
                        <li class="flex items-center"><i class="fas fa-check text-blue-500 mr-2"></i>Ode-6-Flash: Unlimited</li>
                        <li class="flex items-center"><i class="fas fa-check text-blue-500 mr-2"></i>Ode-6: 400 pts/msg</li>
                        <li class="flex items-center"><i class="fas fa-check text-blue-500 mr-2"></i>Unlimited Extended Thinking</li>
                        <li class="flex items-center"><i class="fas fa-check text-blue-500 mr-2"></i>Web Search: +100 pts</li>
                        <li class="flex items-center"><i class="fas fa-star text-blue-500 mr-2"></i>Monthly restore: 1x/month</li>
                        <li class="flex items-center"><i class="fas fa-check text-blue-500 mr-2"></i>Priority support</li>
                    </ul>
                    <button id="proUpgradeBtn" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">Upgrade to Pro</button>
                </div>

                <!-- Max Plan -->
                <div class="border border-purple-200 dark:border-purple-700 rounded-xl p-6 bg-purple-50 dark:bg-purple-900">
                    <h3 class="text-xl font-bold mb-2">Max</h3>
                    <div class="text-3xl font-bold mb-4">$29.99<span class="text-lg text-gray-500">/month</span></div>
                    <ul class="space-y-2 mb-6 text-sm">
                        <li class="flex items-center"><i class="fas fa-infinity text-purple-500 mr-2"></i>Unlimited everything</li>
                        <li class="flex items-center"><i class="fas fa-check text-purple-500 mr-2"></i>No point system (hidden)</li>
                        <li class="flex items-center"><i class="fas fa-check text-purple-500 mr-2"></i>Unlimited Ode-6</li>
                        <li class="flex items-center"><i class="fas fa-check text-purple-500 mr-2"></i>Unlimited Post Thinking</li>
                        <li class="flex items-center"><i class="fas fa-check text-purple-500 mr-2"></i>Unlimited Extended Thinking</li>
                        <li class="flex items-center"><i class="fas fa-check text-purple-500 mr-2"></i>Unlimited Web Search</li>
                        <li class="flex items-center"><i class="fas fa-crown text-purple-500 mr-2"></i>VIP Priority Support</li>
                        <li class="flex items-center"><i class="fas fa-star text-purple-500 mr-2"></i>Early access to features</li>
                    </ul>
                    <button id="maxUpgradeBtn" class="w-full bg-purple-500 text-white py-2 rounded-md hover:bg-purple-600">Upgrade to Max</button>
                </div>
            </div>
            
            <div class="text-center">
                <div class="text-sm text-gray-500 mb-2" data-translate="or">or</div>
                <div class="flex justify-center space-x-2">
                    <input id="codeInput" type="text" placeholder="Enter redemption code" data-translate-placeholder="enter_redemption_code" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                    <button id="redeemBtn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600" data-translate="redeem_code">Redeem Code</button>
                </div>
            </div>
            
            <button id="closeUpgradeModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <!-- Payment Method Modal -->
        <div id="paymentMethodModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md mx-4">
                <h3 class="text-xl font-bold mb-4">Choose Payment Method</h3>
                <div class="space-y-3">
                    <button id="cardPaymentBtn" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all flex items-center justify-center space-x-3">
                        <i class="fas fa-credit-card text-2xl"></i>
                        <span>Pay with Card</span>
                    </button>
                    <button id="wechatPaymentBtn" class="w-full p-4 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition-all flex items-center justify-center space-x-3">
                        <i class="fab fa-weixin text-2xl text-green-500"></i>
                        <span>Pay with WeChat</span>
                    </button>
                </div>
                <button id="closePaymentMethodModal" class="mt-4 w-full py-2 bg-gray-300 dark:bg-gray-600 rounded-md hover:bg-gray-400 dark:hover:bg-gray-700">Cancel</button>
            </div>
        </div>

        <!-- Card Payment Modal -->
        <div id="cardPaymentModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-900 rounded-2xl p-8 max-w-md mx-4 shadow-2xl">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold">Payment Details</h3>
                    <div class="flex space-x-2">
                        <i class="fab fa-cc-visa text-3xl text-gray-400"></i>
                        <i class="fab fa-cc-mastercard text-3xl text-gray-400"></i>
                    </div>
                </div>
                
                <div class="mb-6">
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-4 rounded-lg">
                        <div class="text-sm opacity-75">Amount to pay</div>
                        <div class="text-3xl font-bold">$9.99</div>
                    </div>
                </div>
                
                <form id="stripePaymentForm">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Expiry Date</label>
                            <input id="cardExpiry" type="text" placeholder="MM/YY" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 focus:outline-none" maxlength="5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">CVC</label>
                            <input id="cardCvc" type="text" placeholder="123" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 focus:outline-none" maxlength="3">
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2">Cardholder Name</label>
                        <input id="cardholderName" type="text" placeholder="John Doe" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 focus:ring-2 focus:ring-blue-500 focus:outline-none">
                    </div>
                    
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105">
                        <span id="payButtonText">Complete Payment</span>
                    </button>
                </form>
                
                <div class="mt-4 text-center text-sm text-gray-500">
                    <i class="fas fa-lock mr-1"></i>Secure payment powered by Stripe
                </div>
                
                <button id="closeCardPaymentModal" class="mt-4 w-full py-2 bg-gray-300 dark:bg-gray-600 rounded-md hover:bg-gray-400 dark:hover:bg-gray-700">Cancel</button>
            </div>
        </div>

        <!-- WeChat Payment Form (Hidden) -->
        <form id="wechatPaymentForm" action="https://code.lfk.cc/submit.php" method="POST" style="display: none;">
            <input type="hidden" name="pid" value="1480">
            <input type="hidden" name="type" value="wxpay">
            <input type="hidden" name="out_trade_no" id="wechat_out_trade_no">
            <input type="hidden" name="notify_url" id="wechat_notify_url">
            <input type="hidden" name="return_url" id="wechat_return_url">
            <input type="hidden" name="name" value="TyloAI Pro Plan">
            <input type="hidden" name="money" value="0.01">
            <input type="hidden" name="sitename" value="TyloAI">
            <input type="hidden" name="sign" id="wechat_sign">
            <input type="hidden" name="sign_type" value="MD5">
        </form>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 w-full max-w-6xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold" data-translate="settings">Settings</h2>
                <button id="closeSettingsModal" class="text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Column 1: Profile & Language -->
                <div class="space-y-6">
                    <!-- User Profile -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2" data-translate="user_profile">Profile</h3>
                        <div>
                            <label class="block text-sm font-medium mb-2" data-translate="nickname">Nickname</label>
                            <input id="nicknameInput" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" placeholder="Enter nickname" data-translate-placeholder="enter_nickname">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" data-translate="avatar_url">Avatar URL</label>
                            <input id="avatarUrlInput" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" placeholder="Enter avatar URL" data-translate-placeholder="enter_avatar_url">
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-sm">
                                <div class="font-medium"><span data-translate="level">Level</span> <span id="settingsLevel">1</span></div>
                                <div class="text-gray-500"><span id="settingsXP">0</span> / <span id="settingsMaxXP">100</span> XP</div>
                            </div>
                            <div class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                                <div id="settingsXPBar" class="progress-bar h-2 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Language Selection -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2" data-translate="language">Language</h3>
                        <div>
                            <label class="block text-sm font-medium mb-2" data-translate="select_language">Select Language</label>
                            <div class="relative">
                                <button id="languageDropdown" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-left flex justify-between items-center">
                                    <span id="languageDisplay">English</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div id="languageOptions" class="hidden absolute top-full left-0 mt-1 w-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg z-20">
                                    <div class="language-option p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" data-lang="en">English</div>
                                    <div class="language-option p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" data-lang="zh-cn">中文（简体）</div>
                                    <div class="language-option p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" data-lang="zh-tw">中文（繁体）</div>
                                    <div class="language-option p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" data-lang="ja">日本語</div>
                                    <div class="language-option p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" data-lang="ko">한국어</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Customization -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2" data-translate="customization">Customization</h3>
                        <div>
                            <label class="block text-sm font-medium mb-2" data-translate="font_family">Font Family</label>
                            <select id="fontSelector" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700">
                                <option value="sans" data-translate="font_sans">Sans Serif</option>
                                <option value="serif" data-translate="font_serif">Serif</option>
                                <option value="mono" data-translate="font_mono">Monospace</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2" data-translate="chat_background">Chat Background</label>
                            <select id="backgroundSelector" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 mb-2">
                                <option value="default" data-translate="bg_default">Default (White)</option>
                                <option value="coffee" data-translate="bg_coffee">Coffee Theme</option>
                                <option value="custom" data-translate="bg_custom">Custom URL</option>
                            </select>
                            <input id="customBgUrl" type="url" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 hidden" placeholder="Enter background image URL" data-translate-placeholder="enter_bg_url">
                            <p id="bgUrlError" class="text-red-500 text-xs mt-1 hidden" data-translate="url_invalid">URL is invalid or image failed to load</p>
                        </div>
                    </div>

                    <!-- Usage Stats -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2" data-translate="usage_stats">Usage Stats</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <span data-translate="ode6_usage">Ode-6 this month:</span>
                                <span id="odeUsage">0/5</span>
                            </div>
                            <div class="flex justify-between">
                                <span data-translate="agent_usage">Agent projects:</span>
                                <span id="agentUsage">0/5</span>
                            </div>
                            <div class="flex justify-between">
                                <span data-translate="images_today">Images generated today:</span>
                                <span id="imageUsage">0/2</span>
                            </div>
                            <div class="flex justify-between">
                                <span data-translate="videos_generated">Videos generated:</span>
                                <span id="videoUsage">0/1</span>
                            </div>
                            <div class="flex justify-between">
                                <span data-translate="total_conversations">Total conversations:</span>
                                <span id="totalChats">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Column 2: Memory & Achievements -->
                <div class="space-y-6">
                    <!-- AI Memory -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2" data-translate="ai_memory">AI Memory</h3>
                        <div id="memoryList" class="space-y-2 max-h-40 overflow-y-auto custom-scrollbar">
                            <p class="text-gray-500 text-sm" data-translate="no_memories">No memories stored yet</p>
                        </div>
                        <button id="clearMemoryBtn" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600" data-translate="clear_memories">Clear All Memories</button>
                    </div>

                    <!-- Achievements -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2" data-translate="achievements">Achievements</h3>
                        <div id="achievementsList" class="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                            <!-- Achievements will be populated here -->
                        </div>
                    </div>

                    <!-- Social Media -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2" data-translate="social_media">Follow Us</h3>
                        <div class="flex space-x-2">
                            <a href="https://www.youtube.com/channel/UCHYEPXnBtHmaLF3pOIGhwUw" target="_blank" class="flex items-center px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">
                                <i class="fab fa-youtube mr-2"></i>
                                <span data-translate="youtube">YouTube</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Column 3: Preferences & Tasks -->
                <div class="space-y-6">
                    <!-- Preferences -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2" data-translate="preferences">Preferences</h3>
                        <div>
                            <label class="block text-sm font-medium mb-2" data-translate="personal_preferences">Personal Preferences</label>
                            <textarea id="preferencesInput" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700" rows="3" placeholder="What should TyloAI consider in responses?" data-translate-placeholder="preferences_placeholder"></textarea>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="checkbox" id="tutorialReset" class="rounded">
                            <label for="tutorialReset" class="text-sm" data-translate="reset_tutorial">Reset tutorial (restart guide)</label>
                        </div>
                    </div>

                    <!-- Daily Tasks -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2" data-translate="daily_tasks">Daily Tasks</h3>
                        <div id="dailyTasksList" class="space-y-2">
                            <!-- Daily tasks will be populated here -->
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold border-b border-gray-200 dark:border-gray-700 pb-2" data-translate="data_management">Data Management</h3>
                        <div class="flex space-x-2">
                            <button id="exportDataBtn" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                <i class="fas fa-download mr-2"></i><span data-translate="export_data">Export Data</span>
                            </button>
                            <button id="importDataBtn" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                                <i class="fas fa-upload mr-2"></i><span data-translate="import_data">Import Data</span>
                            </button>
                            <button id="monthlyRestoreBtn" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 pro-only hidden">
                                <i class="fas fa-redo mr-2"></i>Monthly Restore (Pro)
                            </button>
                            <script>
                                document.getElementById('monthlyRestoreBtn').addEventListener('click', useMonthlyRestore);
                            </script>
                        </div>
                        <input type="file" id="importFileInput" class="hidden" accept=".json">
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end space-x-2 mt-6 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button id="cancelSettings" class="px-4 py-2 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-md" data-translate="cancel">Cancel</button>
                <button id="saveSettings" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600" data-translate="save_changes">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Tool Development Modal -->
<div id="toolDevModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-sm mx-4 text-center">
        <i class="fas fa-tools text-4xl text-blue-500 mb-4"></i>
        <h3 class="text-xl font-bold mb-2">Under Development</h3>
        <p class="text-gray-600 dark:text-gray-400 mb-4">We're still working on this feature. Stay tuned!</p>
        <button id="closeToolDevModal" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600">OK</button>
    </div>
</div>

<!-- Prism First Connect Modal -->
<div id="prismFirstConnectModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50">
    <div class="prism-modal-content bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md mx-4 relative">
        <button id="closePrismModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300">
            <i class="fas fa-times"></i>
        </button>
        
        <div class="text-center mb-6">
            <img src="prism.png" alt="Prism" class="w-16 h-16 mx-auto mb-4">
            <h3 class="text-2xl font-bold mb-2">Connect to Prism</h3>
            <p class="text-gray-600 dark:text-gray-400">
                This is your first time connecting to Prism. Would you like to link your TyloAI with Prism's learning platform?
            </p>
        </div>
        
        <div class="bg-blue-50 dark:bg-blue-900 rounded-lg p-4 mb-6">
            <h4 class="font-semibold mb-2 flex items-center">
                <i class="fas fa-info-circle mr-2 text-blue-500"></i>
                What you'll get:
            </h4>
            <ul class="text-sm space-y-1 text-gray-700 dark:text-gray-300">
                <li>• Personalized AI responses based on your learning preferences</li>
                <li>• Course progress tracking and reminders</li>
                <li>• Skill-based code generation tailored to your expertise</li>
                <li>• Career path recommendations aligned with your courses</li>
            </ul>
        </div>
        
        <button id="connectPrismBtn" class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 mb-3">
            <i class="fas fa-link mr-2"></i>Connect to Prism
        </button>
        
        <p class="text-xs text-gray-500 text-center">
            By connecting, you agree to our 
            <a href="https://protoetic.com/terms" target="_blank" class="text-blue-500 hover:underline">Terms of Service</a> 
            and 
            <a href="https://protoetic.com/privacy" target="_blank" class="text-blue-500 hover:underline">Privacy Policy</a>
        </p>
    </div>
</div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-sm mx-4 text-center">
            <i class="fas fa-check-circle text-4xl text-green-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-2" id="successTitle">Success!</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4" id="successMessage">Operation completed successfully</p>
            <button id="closeSuccessModal" class="w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600" data-translate="ok">OK</button>
        </div>
    </div>

    <!-- Achievement Popup -->
    <div id="achievementPopup" class="fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50 hidden achievement-popup">
        <div class="flex items-center">
            <i class="fas fa-trophy mr-2"></i>
            <div>
                <div class="font-bold" data-translate="achievement_unlocked">Achievement Unlocked!</div>
                <div id="achievementText" class="text-sm"></div>
            </div>
        </div>
    </div>

    <!-- Daily Check-in Modal -->
    <div id="checkinModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-sm mx-4 text-center">
            <i class="fas fa-calendar-check text-4xl text-green-500 mb-4"></i>
            <h3 class="text-xl font-bold mb-2" data-translate="daily_checkin">Daily Check-in</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4" data-translate="welcome_back">Welcome back! Here's your daily bonus:</p>
            <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-4">
                <div class="text-2xl font-bold text-green-500">+<span id="checkinBonus">3000</span></div>
                <div class="text-sm text-gray-500" data-translate="points">Points</div>
                <div class="text-xs text-gray-400 mt-1">Day <span id="checkinStreak">1</span> streak</div>
            </div>
            <button id="claimCheckin" class="w-full bg-green-500 text-white py-2 rounded-md hover:bg-green-600" data-translate="claim_reward">Claim Reward</button>
        </div>
    </div>

    <!-- Artifact Panel -->
    <div id="artifactPanel" class="artifact-panel">
        <div class="artifact-header">
            <div>
                <h3 id="artifactTitle" class="font-bold text-lg">Artifact</h3>
                <span id="artifactType" class="text-sm text-gray-500"></span>
            </div>
            <div class="flex items-center space-x-2">
                <button id="downloadArtifact" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                    <i class="fas fa-download"></i>
                </button>
                <button id="copyArtifactCode" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                    <i class="fas fa-copy"></i>
                </button>
                <button id="closeArtifact" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="artifact-tabs">
            <div class="artifact-tab active" data-tab="preview">
                <i class="fas fa-eye mr-2"></i>Preview
            </div>
            <div class="artifact-tab" data-tab="code">
                <i class="fas fa-code mr-2"></i>Code
            </div>
        </div>
        <div class="artifact-content">
            <div id="artifactPreviewPane" class="artifact-view">
                <iframe id="artifactPreview" class="artifact-preview"></iframe>
            </div>
            <div id="artifactCodePane" class="artifact-view hidden">
                <textarea id="artifactEditor" class="artifact-editor"></textarea>
            </div>
        </div>
    </div>

    <script>
        // Translation system
        const TRANSLATIONS = {
            'en': {
                'memory_saved': 'Saved to Memory',
                'how_we_use_memory': 'How do we use your memory?',
                'view_memory_details': 'Click to view details',
                'youtube_channel_live': 'TyloAI YouTube Channel is Live!',
                'youtube_channel_desc': 'Join our official YouTube channel for tutorials, updates, and exciting AI content!',
                'visit_channel': 'Visit Our Channel',
                'dont_show_today': "Don't show today",
                'must_search_web': 'Performing web search for latest information...',
                'creating_mindmap': 'Creating mind map...',
                'normal_thinking': 'Normal Thinking',
                'post_thinking': 'Post Thinking',
                'secondary_reasoning': 'Secondary Reasoning...',
                'post_thinking_limit': 'Monthly Post Thinking limit reached (5/5). Upgrade for unlimited access.',
                'secondary_analysis': 'Secondary Analysis',
                'performing_secondary': 'Performing secondary analysis...',
                'secondary_complete': 'Secondary Analysis Complete',
                'critical_evaluation': 'Critical Evaluation',
                'agent_multimodal': 'Agent - Multimodal Collaboration',
                'programming': 'Programming',
                'writing': 'Writing',
                'analysis': 'Analysis',
                'learning': 'Learning',
                'deep_thinking': 'Deep Thinking',
                'web_search': 'Web Search',
                'style': 'Style',
                'share_thoughts': 'Share Your Thoughts',
                'gomoku_game': 'Gomoku Game',
                'saas_website': 'SaaS Website',
                'clear_email': 'Write a clear email',
                'absence_letter': 'Write an absence letter',
                'movie_review': 'Write a movie review',
                'data_analysis': 'Data Analysis',
                'market_trends': 'Market Trends',
                'learn_quantum': 'Learn Quantum Computing',
                'learn_python': 'Learn Python',
                'payment_successful': 'Payment Successful!',
                'welcome_pro': 'Welcome to TyloAI Pro! Enjoy unlimited access to all features.',
                'complete_payment': 'Complete Payment',
                'card_information': 'Card Information',
                'test_card_info': 'Test Card: 4242 4242 4242 4242',
                'processing': 'Processing...',
                // Basic UI
                'chat_history': 'TyloAI',
                'new_chat': 'New Chat',
                'project': 'Project',
                'search_chats': 'Search chats...',
                'free_plan': 'Free Plan',
                'student_plan': 'Student Plan',
                'pro_plan': 'Pro Plan',
                'upgrade': 'Upgrade',
                'settings': 'Settings',
                'stop': 'Stop',
                'ask_anything': 'Ask TyloAI anything...',
                'reply_to': 'Reply to TyloAI...',
                
                // Styles
                'normal': 'Normal',
                'concise': 'Concise',
                'formal': 'Formal',
                'explanatory': 'Explanatory',
                'casual': 'Casual/Forum Style',
                'artistic': 'Artistic Style',
                
                // Models
                'free_unlimited': 'Free (Unlimited)',
                'smart_monthly': 'Smart (5/month)',
                'general_cost': 'General (300pts)',
                'reasoning_cost': 'Reasoning (300pts)',
                
                // Common
                'points': 'points',
                'level': 'Level',
                'xp': 'XP',
                'language': 'Language',
                'select_language': 'Select Language',
                'cancel': 'Cancel',
                'save_changes': 'Save Changes',
                'submit': 'Submit',
                'create': 'Create',
                'verify': 'Verify',
                'redeem': 'Redeem',
                'ok': 'OK',
                'or': 'or',
                'next': 'Next',
                
                // Quick Actions
                'writing': 'Writing',
                // Change to:
                'call': 'Call',
                'choose_payment_method': 'Choose Payment Method',
                'pay_with_card': 'Pay with Card', 
                'pay_with_wechat': 'Pay with WeChat',
                'payment_details': 'Payment Details',
                'amount_to_pay': 'Amount to pay',
                'test_payment_notice': 'Test payment - Change to $9.99 for production',
                'card_number': 'Card Number',
                'expiry_date': 'Expiry Date',
                'cardholder_name': 'Cardholder Name',
                'complete_payment': 'Complete Payment',
                'secure_payment': 'Secure payment powered by Stripe',
                'processing': 'Processing...',
                'payment_successful': 'Payment Successful!',
                'welcome_pro': 'Welcome to TyloAI Pro! Enjoy unlimited access to all features.',
                'code': 'Code',
                'life': 'Life',
                
                // Profile
                'user_profile': 'User Profile',
                'nickname': 'Nickname',
                'avatar_url': 'Avatar URL',
                'enter_nickname': 'Enter nickname',
                'enter_avatar_url': 'Enter avatar URL',
                
                // AI Memory
                'ai_memory': 'AI Memory',
                'no_memories': 'No memories stored yet',
                'clear_memories': 'Clear All Memories',
                
                // Achievements
                'achievements': 'Achievements',
                'achievement_unlocked': 'Achievement Unlocked!',
                
                // Preferences
                'preferences': 'Preferences',
                'personal_preferences': 'Personal Preferences',
                'preferences_placeholder': 'What should TyloAI consider in responses?',
                'reset_tutorial': 'Reset tutorial (restart guide)',
                
                // Daily Tasks
                'daily_tasks': 'Daily Tasks',
                'daily_checkin': 'Daily Check-in',
                'welcome_back': 'Welcome back! Here is your daily bonus:',
                'claim_reward': 'Claim Reward',
                'complete': 'Complete',
                
                // Data Management
                'data_management': 'Data Management',
                'export_data': 'Export Data',
                'import_data': 'Import Data',
                
                // Usage Stats
                'usage_stats': 'Usage Stats',
                'ode6_usage': 'Ode-6 this month:',
                'agent_usage': 'Agent projects:',
                'research_usage': 'Research usage:',
                'images_today': 'Images generated today:',
                'videos_generated': 'Videos generated:',
                'total_conversations': 'Total conversations:',
                
                // Tutorial
                'welcome_tutorial': 'Welcome to TyloAI!',
                'tutorial_step1': 'Let\'s start with a quick tour. This is your AI assistant that can help with various tasks.',
                'tutorial_step2': 'You can choose different AI models and conversation styles using the dropdown menus.',
                'tutorial_step3': 'Your progress is tracked with levels and achievements. Complete the tutorial to earn 100 XP!',
                'complete_tutorial': 'Complete Tutorial',
                
                // Feedback
                'feedback_title': 'Help us improve',
                'feedback_description': 'What wasn\'t helpful about this response?',
                'feedback_harmful': 'Harmful or inappropriate content',
                'feedback_false': 'False or misleading information',
                'feedback_unhelpful': 'Not helpful',
                'feedback_other': 'Other',
                'feedback_details': 'Additional details (optional)',
                
                // Project
                'create_project': 'Create New Project',
                'project_title': 'Project Title',
                'project_objective': 'Project Objective',
                'enter_project_title': 'Enter project title',
                'enter_project_objective': 'Describe the main goal and objective of this project',
                'agent_analysis': 'Analysis',
                'agent_synthesis': 'Synthesis',
                'agent_conclusion': 'Conclusion',
                
                // Student Plan
                'student_requirements': 'Requirements: Must be 18+ student from China (Guizhou, Yunnan, Tibet), USA, UK, Japan, Brazil, or Indonesia with valid .edu email',
                'edu_email': 'Educational Email (.edu)',
                'enter_edu_email': 'your.email@university.edu',
                'email_error': 'Must be a valid .edu email address',
                'verify_student': 'Verify Student Status',
                'student_activated': 'Student Plan activated for 1 year!',
                
                // Plans
                'choose_plan': 'Choose Your Plan',
                'plan_description': 'Select the plan that works best for you',
                'current_plan': 'Current Plan',
                'free_ode_flash': 'Unlimited Ode-6-Flash',
                'free_ode_monthly': 'Ode-6: 5/month',
                'free_points': '3000 points daily',
                'free_agent': 'Agent: 5/month',
                'free_research': 'Research: 10/month',
                'unlimited_everything': 'Unlimited everything',
                'unlimited_usage': 'Unlimited usage',
                'unlimited_media': 'Unlimited media generation',
                'priority_support': 'Priority support',
                'early_access': 'Early access to new models',
                'student_only': 'Students only',
                'upgrade_pro': 'Upgrade to Pro',
                
                // Points and Redemption
                'redeem_points': 'Redeem Points',
                'redemption_code': 'Enter Redemption Code',
                'enter_redemption_code': 'Please enter redemption code',
                'redeem_code': 'Redeem Code',
                
                // Media
                'art_style': 'Art Style',
                'music_style': 'Music Style',
                'number_of_images': 'Number of Images',
                'image_limit_info': 'Free users: 1 generation of 2 images per day, then 1 image per generation',
                
                // Customization
                'customization': 'Customization',
                'font_family': 'Font Family',
                'font_sans': 'Sans Serif',
                'font_serif': 'Serif',
                'font_mono': 'Monospace',
                'chat_background': 'Chat Background',
                'bg_default': 'Default (White)',
                'bg_coffee': 'Coffee Theme',
                'bg_custom': 'Custom URL',
                'enter_bg_url': 'Enter background image URL',
                'url_invalid': 'URL is invalid or image failed to load',
                
                // Social Media
                'social_media': 'Follow Us',
                'youtube': 'YouTube',
                
                // Messages
                'may_make_mistakes': 'TyloAI may make mistakes. Please verify important information.',
                'thinking_process': 'Thinking Process',
                'file_uploaded': 'File uploaded: {0}',
                'generation_stopped': 'Generation stopped by user.',
                'try_asking': 'Try asking about: "{0}"',
                'no_chat_history': 'No chat history yet',
                'good_morning': 'Rise and shine! Ready to conquer the day?',
                'good_afternoon': 'Afternoon! how\'s that project coming along?',
                'good_evening': 'Evening! Finally clocking out? Any plans for the night?',
                'working_late': 'Hey! What\'s up? What are you getting into tonight?',
                'burning_midnight': 'Everything alright? It\'s not like you to be up this late.'
            },
            'zh-cn': {
                                'memory_saved': '已保存至记忆库',
                'how_we_use_memory': '我们如何使用您的记忆库？',
                'view_memory_details': '点击查看详情',
                'youtube_channel_live': 'TyloAI YouTube 频道正在直播！',
                'youtube_channel_desc': '订阅我们的官方 YouTube 频道，获取教程、更新及精彩 AI 内容！',
                'visit_channel': '访问我们的频道',
                'dont_show_today': '今日不再显示',
                'must_search_web': '正在执行网络搜索以获取最新信息...',
                'creating_mindmap': '正在创建思维导图...',
                'normal_thinking': '常规思考',
                'post_thinking': '深度思考',
                'secondary_reasoning': '二次推理...',
                'post_thinking_limit': '月度深度思考次数已用尽（5/5）。升级可解锁无限次使用权限。',
                'secondary_analysis': '二次分析',
                'performing_secondary': '正在执行二次分析...',
                'secondary_complete': '二次分析完成',
                'critical_evaluation': '批判性评估',
                'agent_multimodal': '智能体 - 多模态协作',
                'programming': '编程',
                'writing': '写作',
                'analysis': '分析',
                'learning': '学习',
                'deep_thinking': '深度思考',
                'web_search': '网络搜索',
                'style': '风格',
                'share_thoughts': '分享您的想法',
                'gomoku_game': '五子棋游戏',
                'saas_website': 'SaaS 网站',
                'clear_email': '撰写条理清晰的邮件',
                'absence_letter': '撰写请假条',
                'movie_review': '撰写电影评论',
                'data_analysis': '数据分析',
                'market_trends': '市场趋势',
                'learn_quantum': '学习量子计算',
                'learn_python': '学习 Python',
                'payment_successful': '支付成功！',
                'welcome_pro': '欢迎加入 TyloAI Pro！畅享所有功能的无限次使用权限。',
                'complete_payment': '完成支付',
                'card_information': '银行卡信息',
                'test_card_info': '测试卡：4242 4242 4242 4242',
                'processing': '处理中...',
                // Basic UI
                'chat_history': 'TyloAI',
                'new_chat': '新建对话',
                'project': '项目',
                'search_chats': '搜索对话...',
                'free_plan': '免费套餐',
                'student_plan': '学生套餐',
                'pro_plan': '专业套餐',
                'upgrade': '升级',
                'settings': '设置',
                'stop': '停止',
                'ask_anything': '向 TyloAI 提问...',
                'reply_to': '回复 TyloAI...',
                
                // Styles
                'normal': '常规',
                'concise': '简洁',
                'formal': '正式',
                'explanatory': '解释性',
                'casual': '随意/论坛风格',
                'artistic': '文艺风格',
                
                // Models
                'free_unlimited': '免费（无限次）',
                'smart_monthly': '智能版（每月5次）',
                'general_cost': '通用版（300积分）',
                'reasoning_cost': '推理版（300积分）',
                
                // Common
                'points': '积分',
                'level': '等级',
                'xp': '经验值',
                'language': '语言',
                'select_language': '选择语言',
                'cancel': '取消',
                'save_changes': '保存更改',
                'submit': '提交',
                'create': '创建',
                'verify': '验证',
                'redeem': '兑换',
                'ok': '确定',
                'or': '或',
                'next': '下一步',
                
                // Quick Actions
                'writing': '写作',
                // Change to:
                'call': '通话',
                'choose_payment_method': '选择支付方式',
                'pay_with_card': '银行卡支付', 
                'pay_with_wechat': '微信支付',
                'payment_details': '支付详情',
                'amount_to_pay': '支付金额',
                'test_payment_notice': '测试支付 - 正式环境需改为 9.99 美元',
                'card_number': '银行卡号',
                'expiry_date': '有效期',
                'cardholder_name': '持卡人姓名',
                'complete_payment': '完成支付',
                'secure_payment': '由 Stripe 提供支持的安全支付',
                'processing': '处理中...',
                'payment_successful': '支付成功！',
                'welcome_pro': '欢迎加入 TyloAI Pro！畅享所有功能的无限次使用权限。',
                'code': '代码',
                'life': '生活',
                
                // Profile
                'user_profile': '用户资料',
                'nickname': '昵称',
                'avatar_url': '头像链接',
                'enter_nickname': '输入昵称',
                'enter_avatar_url': '输入头像链接',
                
                // AI Memory
                'ai_memory': 'AI 记忆库',
                'no_memories': '暂无存储的记忆内容',
                'clear_memories': '清空所有记忆',
                
                // Achievements
                'achievements': '成就',
                'achievement_unlocked': '解锁新成就！',
                
                // Preferences
                'preferences': '偏好设置',
                'personal_preferences': '个人偏好设置',
                'preferences_placeholder': 'TyloAI 在回复时应考虑哪些因素？',
                'reset_tutorial': '重置教程（重新开始引导）',
                
                // Daily Tasks
                'daily_tasks': '每日任务',
                'daily_checkin': '每日签到',
                'welcome_back': '欢迎回来！以下是您的每日奖励：',
                'claim_reward': '领取奖励',
                'complete': '完成',
                
                // Data Management
                'data_management': '数据管理',
                'export_data': '导出数据',
                'import_data': '导入数据',
                
                // Usage Stats
                'usage_stats': '使用统计',
                'ode6_usage': '本月 Ode-6 使用次数：',
                'agent_usage': '智能体项目数：',
                'research_usage': '研究功能使用次数：',
                'images_today': '今日生成图片数：',
                'videos_generated': '生成视频数：',
                'total_conversations': '总对话数：',
                
                // Tutorial
                'welcome_tutorial': '欢迎使用 TyloAI！',
                'tutorial_step1': '让我们快速了解一下。这是您的 AI 助手，可协助完成各类任务。',
                'tutorial_step2': '您可以通过下拉菜单选择不同的 AI 模型和对话风格。',
                'tutorial_step3': '您的进度会通过等级和成就进行跟踪。完成教程可获得 100 经验值！',
                'complete_tutorial': '完成教程',
                
                // Feedback
                'feedback_title': '帮助我们改进',
                'feedback_description': '此回复在哪些方面对您没有帮助？',
                'feedback_harmful': '包含有害或不当内容',
                'feedback_false': '包含虚假或误导性信息',
                'feedback_unhelpful': '无帮助',
                'feedback_other': '其他',
                'feedback_details': '补充说明（可选）',
                
                // Project
                'create_project': '创建新项目',
                'project_title': '项目标题',
                'project_objective': '项目目标',
                'enter_project_title': '输入项目标题',
                'enter_project_objective': '描述此项目的主要目标和目的',
                'agent_analysis': '分析',
                'agent_synthesis': '综合',
                'agent_conclusion': '结论',
                
                // Student Plan
                'student_requirements': '申请要求：需为 18 岁以上学生，所在国家/地区包括中国（贵州、云南、西藏）、美国、英国、日本、巴西或印度尼西亚，且需提供有效的 .edu 邮箱',
                'edu_email': '教育邮箱（.edu）',
                'enter_edu_email': '您的邮箱@大学域名.edu',
                'email_error': '必须是有效的 .edu 邮箱地址',
                'verify_student': '验证学生身份',
                'student_activated': '学生套餐已激活，有效期 1 年！',
                
                // Plans
                'choose_plan': '选择您的套餐',
                'plan_description': '选择最适合您的套餐',
                'current_plan': '当前套餐',
                'free_ode_flash': '无限次使用 Ode-6-Flash',
                'free_ode_monthly': 'Ode-6：每月 5 次',
                'free_points': '每日 3000 积分',
                'free_agent': '智能体：每月 5 次',
                'free_research': '研究功能：每月 10 次',
                'unlimited_everything': '所有功能无限次使用',
                'unlimited_usage': '无限次使用',
                'unlimited_media': '无限次媒体生成',
                'priority_support': '优先客服支持',
                'early_access': '优先体验新模型',
                'student_only': '仅限学生',
                'upgrade_pro': '升级至专业版',
                
                // Points and Redemption
                'redeem_points': '积分兑换',
                'redemption_code': '输入兑换码',
                'enter_redemption_code': '请输入兑换码',
                'redeem_code': '兑换代码',
                
                // Media
                'art_style': '艺术风格',
                'music_style': '音乐风格',
                'number_of_images': '图片数量',
                'image_limit_info': '免费用户：每日可生成 1 组（2 张）图片，之后每次生成 1 张图片',
                
                // Customization
                'customization': '自定义设置',
                'font_family': '字体 - 部分语言可能不适配',
                'font_sans': '无衬线字体',
                'font_serif': '衬线字体',
                'font_mono': '等宽字体',
                'chat_background': '对话背景',
                'bg_default': '默认（白色）',
                'bg_coffee': '咖啡主题',
                'bg_custom': '自定义链接',
                'enter_bg_url': '输入背景图片链接',
                'url_invalid': '链接无效或图片加载失败',
                
                // Social Media
                'social_media': '关注我们',
                'youtube': 'YouTube',
                
                // Messages
                'may_make_mistakes': 'TyloAI 可能会出现错误。请核实重要信息。',
                'thinking_process': '思考过程',
                'file_uploaded': '文件已上传：{0}',
                'generation_stopped': '生成已被用户停止。',
                'try_asking': '尝试询问："{0}"',
                'no_chat_history': '暂无对话历史',
                'good_morning': '早上好！准备好迎接新的一天了吗？',
                'good_afternoon': '下午好！您的项目进展如何？',
                'good_evening': '晚上好！终于要结束一天的工作了吗？今晚有什么计划？',
                'working_late': '嘿！最近怎么样？今晚在忙些什么呢？',
                'burning_midnight': '一切都还好吗？这么晚还没休息可不太像你的风格。'
            },
            'ja': {
                                'memory_saved': 'メモリーに保存しました',
                'how_we_use_memory': 'ユーザーのメモリーの使用方法について',
                'view_memory_details': 'クリックして詳細を表示',
                'youtube_channel_live': 'TyloAI YouTubeチャンネル配信中！',
                'youtube_channel_desc': 'チュートリアル、アップデート、魅力的なAIコンテンツを得るため、公式YouTubeチャンネルに登録してください！',
                'visit_channel': 'チャンネルを訪問',
                'dont_show_today': '今日は表示しない',
                'must_search_web': '最新情報を取得するためにWeb検索を実行中...',
                'creating_mindmap': 'マインドマップ作成中...',
                'normal_thinking': '通常思考',
                'post_thinking': '深度思考',
                'secondary_reasoning': '二次推論中...',
                'post_thinking_limit': '月間深度思考回数上限に達しました（5/5）。アップグレードすると無制限で利用可能です。',
                'secondary_analysis': '二次分析',
                'performing_secondary': '二次分析実行中...',
                'secondary_complete': '二次分析完了',
                'critical_evaluation': '批判的評価',
                'agent_multimodal': 'エージェント - マルチモーダル連携',
                'programming': 'プログラミング',
                'writing': 'ライティング',
                'analysis': '分析',
                'learning': '学習',
                'deep_thinking': '深層思考',
                'web_search': 'Web検索',
                'style': 'スタイル',
                'share_thoughts': 'ご意見を共有',
                'gomoku_game': '五目並べゲーム',
                'saas_website': 'SaaSウェブサイト',
                'clear_email': '明確なメールを作成',
                'absence_letter': '欠席届を作成',
                'movie_review': '映画レビューを作成',
                'data_analysis': 'データ分析',
                'market_trends': '市場動向',
                'learn_quantum': '量子コンピューティングを学ぶ',
                'learn_python': 'Pythonを学ぶ',
                'payment_successful': '支払い成功！',
                'welcome_pro': 'TyloAI Proへようこそ！すべての機能を無制限で利用できます。',
                'complete_payment': '支払いを完了',
                'card_information': 'カード情報',
                'test_card_info': 'テストカード：4242 4242 4242 4242',
                'processing': '処理中...',
                // Basic UI
                'chat_history': 'TyloAI',
                'new_chat': '新しいチャット',
                'project': 'プロジェクト',
                'search_chats': 'チャットを検索...',
                'free_plan': '無料プラン',
                'student_plan': '学生プラン',
                'pro_plan': 'プロプラン',
                'upgrade': 'アップグレード',
                'settings': '設定',
                'stop': '停止',
                'ask_anything': 'TyloAIになんでも質問してください...',
                'reply_to': 'TyloAIに返信...',
                
                // Styles
                'normal': '通常',
                'concise': '簡潔',
                'formal': 'フォーマル',
                'explanatory': '説明的',
                'casual': 'カジュアル/フォーラムスタイル',
                'artistic': '芸術的スタイル',
                
                // Models
                'free_unlimited': '無料（無制限）',
                'smart_monthly': 'スマート（月5回）',
                'general_cost': 'ジェネラル（300ポイント）',
                'reasoning_cost': '推論（300ポイント）',
                
                // Common
                'points': 'ポイント',
                'level': 'レベル',
                'xp': 'XP（経験値）',
                'language': '言語',
                'select_language': '言語を選択',
                'cancel': 'キャンセル',
                'save_changes': '変更を保存',
                'submit': '送信',
                'create': '作成',
                'verify': '検証',
                'redeem': '交換',
                'ok': 'OK',
                'or': 'または',
                'next': '次へ',
                
                // Quick Actions
                'writing': 'ライティング',
                // Change to:
                'call': '通話',
                'choose_payment_method': '支払い方法を選択',
                'pay_with_card': 'カードで支払う', 
                'pay_with_wechat': 'WeChatで支払う',
                'payment_details': '支払い詳細',
                'amount_to_pay': '支払い金額',
                'test_payment_notice': 'テスト支払い - 本番環境では9.99ドルに変更してください',
                'card_number': 'カード番号',
                'expiry_date': '有効期限',
                'cardholder_name': 'カード名義人',
                'complete_payment': '支払いを完了',
                'secure_payment': 'Stripeによる安全な支払い',
                'processing': '処理中...',
                'payment_successful': '支払い成功！',
                'welcome_pro': 'TyloAI Proへようこそ！すべての機能を無制限で利用できます。',
                'code': 'コード',
                'life': '生活',
                
                // Profile
                'user_profile': 'ユーザープロフィール',
                'nickname': 'ニックネーム',
                'avatar_url': 'アバターURL',
                'enter_nickname': 'ニックネームを入力',
                'enter_avatar_url': 'アバターURLを入力',
                
                // AI Memory
                'ai_memory': 'AIメモリー',
                'no_memories': 'まだ保存されたメモリーはありません',
                'clear_memories': 'すべてのメモリーをクリア',
                
                // Achievements
                'achievements': 'アチーブメント',
                'achievement_unlocked': 'アチーブメントを解除！',
                
                // Preferences
                'preferences': '環境設定',
                'personal_preferences': '個人環境設定',
                'preferences_placeholder': 'TyloAIが応答する際に考慮すべき事項は？',
                'reset_tutorial': 'チュートリアルをリセット（ガイドを再開）',
                
                // Daily Tasks
                'daily_tasks': 'デイリータスク',
                'daily_checkin': 'デイリーチェックイン',
                'welcome_back': 'おかえりなさい！今日のボーナスはこちらです：',
                'claim_reward': '報酬を受け取る',
                'complete': '完了',
                
                // Data Management
                'data_management': 'データ管理',
                'export_data': 'データをエクスポート',
                'import_data': 'データをインポート',
                
                // Usage Stats
                'usage_stats': '使用状況統計',
                'ode6_usage': '今月のOde-6使用回数：',
                'agent_usage': 'エージェントプロジェクト数：',
                'research_usage': 'リサーチ使用回数：',
                'images_today': '今日生成した画像数：',
                'videos_generated': '生成した動画数：',
                'total_conversations': '総チャット数：',
                
                // Tutorial
                'welcome_tutorial': 'TyloAIへようこそ！',
                'tutorial_step1': '簡単なツアーから始めましょう。これは様々なタスクを支援するAIアシスタントです。',
                'tutorial_step2': 'ドロップダウンメニューから、様々なAIモデルとチャットスタイルを選択できます。',
                'tutorial_step3': 'レベルとアチーブメントで進捗状況を追跡できます。チュートリアルを完了すると100XPを獲得！',
                'complete_tutorial': 'チュートリアルを完了',
                
                // Feedback
                'feedback_title': '改善に役立てていただくため',
                'feedback_description': 'この応答はどの点で役に立たなかったですか？',
                'feedback_harmful': '有害または不適切なコンテンツ',
                'feedback_false': '虚偽または誤解を招く情報',
                'feedback_unhelpful': '役に立たない',
                'feedback_other': 'その他',
                'feedback_details': '追加情報（任意）',
                
                // Project
                'create_project': '新しいプロジェクトを作成',
                'project_title': 'プロジェクトタイトル',
                'project_objective': 'プロジェクト目標',
                'enter_project_title': 'プロジェクトタイトルを入力',
                'enter_project_objective': 'このプロジェクトの主な目標と目的を記述',
                'agent_analysis': '分析',
                'agent_synthesis': '統合',
                'agent_conclusion': '結論',
                
                // Student Plan
                'student_requirements': '要件：中国（貴州省、雲南省、チベット自治区）、アメリカ、イギリス、日本、ブラジル、インドネシア在住の18歳以上の学生で、有効な.eduメールアドレスを保有',
                'edu_email': '教育用メール（.edu）',
                'enter_edu_email': 'your.email@university.edu',
                'email_error': '有効な.eduメールアドレスである必要があります',
                'verify_student': '学生認証を行う',
                'student_activated': '学生プランを1年間活性化しました！',
                
                // Plans
                'choose_plan': 'プランを選択',
                'plan_description': '最も適したプランを選択',
                'current_plan': '現在のプラン',
                'free_ode_flash': 'Ode-6-Flash無制限',
                'free_ode_monthly': 'Ode-6：月5回',
                'free_points': '毎日3000ポイント',
                'free_agent': 'エージェント：月5回',
                'free_research': 'リサーチ：月10回',
                'unlimited_everything': 'すべての機能を無制限',
                'unlimited_usage': '無制限使用',
                'unlimited_media': '無制限メディア生成',
                'priority_support': '優先サポート',
                'early_access': '新しいモデルの早期アクセス',
                'student_only': '学生限定',
                'upgrade_pro': 'プロプランにアップグレード',
                
                // Points and Redemption
                'redeem_points': 'ポイント交換',
                'redemption_code': '交換コードを入力',
                'enter_redemption_code': '交換コードを入力してください',
                'redeem_code': 'コードを交換',
                
                // Media
                'art_style': 'アートスタイル',
                'music_style': 'ミュージックスタイル',
                'number_of_images': '画像枚数',
                'image_limit_info': '無料ユーザー：毎日1回（2枚）画像生成可、その後は1回1枚生成可',
                
                // Customization
                'customization': 'カスタマイズ',
                'font_family': 'フォントファミリー',
                'font_sans': 'サンセリフ',
                'font_serif': 'セリフ',
                'font_mono': '等幅フォント',
                'chat_background': 'チャット背景',
                'bg_default': 'デフォルト（白色）',
                'bg_coffee': 'コーヒーテーマ',
                'bg_custom': 'カスタムURL',
                'enter_bg_url': '背景画像URLを入力',
                'url_invalid': 'URLが無効または画像の読み込みに失敗しました',
                
                // Social Media
                'social_media': 'フォローしてください',
                'youtube': 'YouTube',
                
                // Messages
                'may_make_mistakes': 'TyloAIは誤りを犯す可能性があります。重要な情報は必ず確認してください。',
                'thinking_process': '思考プロセス',
                'file_uploaded': 'ファイルをアップロードしました：{0}',
                'generation_stopped': 'ユーザーにより生成を停止しました。',
                'try_asking': '"{0}"について質問してみてください',
                'no_chat_history': 'まだチャット履歴がありません',
                'good_morning': 'おはようございます！今日も一日頑張りましょう！',
                'good_afternoon': 'こんにちは！プロジェクトの進捗はどうですか？',
                'good_evening': 'こんばんは！やっと仕事が終わりましたか？夜の予定はありますか？',
                'working_late': 'やあ！調子はどうですか？今夜は何をしていますか？',
                'burning_midnight': '大丈夫ですか？こんな時間まで起きているのは普段と違いますね。'
            },
            'ko': {
                                'memory_saved': '메모리에 저장됨',
                'how_we_use_memory': '귀하의 메모리를 어떻게 사용하나요?',
                'view_memory_details': '클릭하여 세부 정보 보기',
                'youtube_channel_live': 'TyloAI YouTube 채널 라이브 중!',
                'youtube_channel_desc': '튜토리얼, 업데이트 및 흥미로운 AI 콘텐츠를 받아보려면 공식 YouTube 채널 구독하세요!',
                'visit_channel': '채널 방문',
                'dont_show_today': '오늘은 보이지 않기',
                'must_search_web': '최신 정보를 얻기 위해 웹 검색 중...',
                'creating_mindmap': '마인드맵 생성 중...',
                'normal_thinking': '일반적 사고',
                'post_thinking': '심층 사고',
                'secondary_reasoning': '이차 추론 중...',
                'post_thinking_limit': '월간 심층 사고 횟수 초과 (5/5). 업그레이드하면 무제한 사용 가능.',
                'secondary_analysis': '이차 분석',
                'performing_secondary': '이차 분석 실행 중...',
                'secondary_complete': '이차 분석 완료',
                'critical_evaluation': '비판적 평가',
                'agent_multimodal': '에이전트 - 멀티모달 협업',
                'programming': '프로그래밍',
                'writing': '글쓰기',
                'analysis': '분석',
                'learning': '학습',
                'deep_thinking': '깊은 사고',
                'web_search': '웹 검색',
                'style': '스타일',
                'share_thoughts': '의견 공유',
                'gomoku_game': '오목 게임',
                'saas_website': 'SaaS 웹사이트',
                'clear_email': '명확한 이메일 작성',
                'absence_letter': '결근 통지서 작성',
                'movie_review': '영화 리뷰 작성',
                'data_analysis': '데이터 분석',
                'market_trends': '시장 트렌드',
                'learn_quantum': '양자 컴퓨팅 학습',
                'learn_python': '파이썬 학습',
                'payment_successful': '결제 성공!',
                'welcome_pro': 'TyloAI Pro에 오신 것을 환영합니다! 모든 기능을 무제한으로 사용하세요.',
                'complete_payment': '결제 완료',
                'card_information': '카드 정보',
                'test_card_info': '테스트 카드: 4242 4242 4242 4242',
                'processing': '처리 중...',
                // Basic UI
                'chat_history': 'TyloAI',
                'new_chat': '새 채팅',
                'project': '프로젝트',
                'search_chats': '채팅 검색...',
                'free_plan': '무료 플랜',
                'student_plan': '학생 플랜',
                'pro_plan': '프로 플랜',
                'upgrade': '업그레이드',
                'settings': '설정',
                'stop': '중지',
                'ask_anything': 'TyloAI에 무엇이든 물어보세요...',
                'reply_to': 'TyloAI에 답장...',
                
                // Styles
                'normal': '일반',
                'concise': '간결',
                'formal': '정식',
                'explanatory': '설명형',
                'casual': '평이한/포럼 스타일',
                'artistic': '예술적 스타일',
                
                // Models
                'free_unlimited': '무료 (무제한)',
                'smart_monthly': '스마트 (월 5회)',
                'general_cost': '일반형 (300포인트)',
                'reasoning_cost': '추론형 (300포인트)',
                
                // Common
                'points': '포인트',
                'level': '레벨',
                'xp': '경험치(XP)',
                'language': '언어',
                'select_language': '언어 선택',
                'cancel': '취소',
                'save_changes': '변경 사항 저장',
                'submit': '제출',
                'create': '생성',
                'verify': '인증',
                'redeem': '교환',
                'ok': '확인',
                'or': '또는',
                'next': '다음',
                
                // Quick Actions
                'writing': '글쓰기',
                // Change to:
                'call': '통화',
                'choose_payment_method': '결제 방법 선택',
                'pay_with_card': '카드로 결제', 
                'pay_with_wechat': '위챗으로 결제',
                'payment_details': '결제 세부 정보',
                'amount_to_pay': '결제 금액',
                'test_payment_notice': '테스트 결제 - 프로덕션 환경에서는 9.99달러로 변경',
                'card_number': '카드 번호',
                'expiry_date': '유효 기간',
                'cardholder_name': '카드 소지자 이름',
                'complete_payment': '결제 완료',
                'secure_payment': 'Stripe 제공 보안 결제',
                'processing': '처리 중...',
                'payment_successful': '결제 성공!',
                'welcome_pro': 'TyloAI Pro에 오신 것을 환영합니다! 모든 기능을 무제한으로 사용하세요.',
                'code': '코드',
                'life': '생활',
                
                // Profile
                'user_profile': '사용자 프로필',
                'nickname': '닉네임',
                'avatar_url': '아바타 URL',
                'enter_nickname': '닉네임 입력',
                'enter_avatar_url': '아바타 URL 입력',
                
                // AI Memory
                'ai_memory': 'AI 메모리',
                'no_memories': '아직 저장된 메모리가 없습니다',
                'clear_memories': '모든 메모리 지우기',
                
                // Achievements
                'achievements': '업적',
                'achievement_unlocked': '업적 해금 완료!',
                
                // Preferences
                'preferences': '기본 설정',
                'personal_preferences': '개인 기본 설정',
                'preferences_placeholder': 'TyloAI가 응답할 때 고려해야 할 사항은 무엇인가요?',
                'reset_tutorial': '튜토리얼 초기화 (가이드 재시작)',
                
                // Daily Tasks
                'daily_tasks': '일일 과제',
                'daily_checkin': '일일 체크인',
                'welcome_back': '다시 오신 것을 환영합니다! 오늘의 보너스는 다음과 같습니다:',
                'claim_reward': '보상 받기',
                'complete': '완료',
                
                // Data Management
                'data_management': '데이터 관리',
                'export_data': '데이터 내보내기',
                'import_data': '데이터 가져오기',
                
                // Usage Stats
                'usage_stats': '사용 통계',
                'ode6_usage': '이달의 Ode-6 사용 횟수:',
                'agent_usage': '에이전트 프로젝트 수:',
                'research_usage': '연구 기능 사용 횟수:',
                'images_today': '오늘 생성한 이미지 수:',
                'videos_generated': '생성한 비디오 수:',
                'total_conversations': '총 채팅 수:',
                
                // Tutorial
                'welcome_tutorial': 'TyloAI에 오신 것을 환영합니다!',
                'tutorial_step1': '빠른 투어부터 시작하겠습니다. 이는 다양한 과제를 돕는 AI 어시스턴트입니다.',
                'tutorial_step2': '드롭다운 메뉴를 사용하여 다양한 AI 모델과 채팅 스타일을 선택할 수 있습니다.',
                'tutorial_step3': '레벨과 업적으로 진행 상황을 추적할 수 있습니다. 튜토리얼을 완료하면 100XP를 얻으세요!',
                'complete_tutorial': '튜토리얼 완료',
                
                // Feedback
                'feedback_title': '향상시키는 데 도움주세요',
                'feedback_description': '이 응답에서 어떤 부분이 도움이 되지 않았나요?',
                'feedback_harmful': '해로운 또는 부적절한 콘텐츠',
                'feedback_false': '거짓 또는 오도리는 정보',
                'feedback_unhelpful': '도움이 되지 않음',
                'feedback_other': '기타',
                'feedback_details': '추가 세부 정보 (선택 사항)',
                
                // Project
                'create_project': '새 프로젝트 생성',
                'project_title': '프로젝트 제목',
                'project_objective': '프로젝트 목표',
                'enter_project_title': '프로젝트 제목 입력',
                'enter_project_objective': '이 프로젝트의 주요 목표와 목적 설명',
                'agent_analysis': '분석',
                'agent_synthesis': '종합',
                'agent_conclusion': '결론',
                
                // Student Plan
                'student_requirements': '요건: 중국(구이저우성, 윈난성, 티베트자치구), 미국, 영국, 일본, 브라질, 인도네시아에 거주하는 18세 이상 학생이며, 유효한 .edu 이메일 보유',
                'edu_email': '교육용 이메일 (.edu)',
                'enter_edu_email': 'your.email@university.edu',
                'email_error': '유효한 .edu 이메일 주소여야 합니다',
                'verify_student': '학생 인증',
                'student_activated': '학생 플랜 1년간 활성화 완료!',
                
                // Plans
                'choose_plan': '플랜 선택',
                'plan_description': '자신에게 가장 적합한 플랜 선택',
                'current_plan': '현재 플랜',
                'free_ode_flash': 'Ode-6-Flash 무제한',
                'free_ode_monthly': 'Ode-6: 월 5회',
                'free_points': '매일 3000포인트',
                'free_agent': '에이전트: 월 5회',
                'free_research': '연구: 월 10회',
                'unlimited_everything': '모든 기능 무제한',
                'unlimited_usage': '무제한 사용',
                'unlimited_media': '무제한 미디어 생성',
                'priority_support': '우선 지원',
                'early_access': '신규 모델 조기 접근',
                'student_only': '학생 전용',
                'upgrade_pro': '프로 플랜으로 업그레이드',
                
                // Points and Redemption
                'redeem_points': '포인트 교환',
                'redemption_code': '교환 코드 입력',
                'enter_redemption_code': '교환 코드를 입력하세요',
                'redeem_code': '코드 교환',
                
                // Media
                'art_style': '아트 스타일',
                'music_style': '음악 스타일',
                'number_of_images': '이미지 개수',
                'image_limit_info': '무료 사용자: 하루 1회 (2장) 이미지 생성 가능, 이후 1회당 1장 이미지 생성',
                
                // Customization
                'customization': '사용자 정의',
                'font_family': '글꼴',
                'font_sans': '산세리프',
                'font_serif': '세리프',
                'font_mono': '고정폭 글꼴',
                'chat_background': '채팅 배경',
                'bg_default': '기본 (흰색)',
                'bg_coffee': '커피 테마',
                'bg_custom': '사용자 정의 URL',
                'enter_bg_url': '배경 이미지 URL 입력',
                'url_invalid': 'URL이 유효하지 않거나 이미지 로드에 실패했습니다',
                
                // Social Media
                'social_media': '팔로우하기',
                'youtube': 'YouTube',
                
                // Messages
                'may_make_mistakes': 'TyloAI는 오류를 발생시킬 수 있습니다. 중요한 정보는 반드시 확인하세요.',
                'thinking_process': '사고 과정',
                'file_uploaded': '파일 업로드 완료: {0}',
                'generation_stopped': '사용자에 의해 생성 중지됨.',
                'try_asking': '"{0}"에 대해 묻는 것을 시도해보세요',
                'no_chat_history': '아직 채팅 기록이 없습니다',
                'good_morning': '좋은 아침입니다! 오늘도 힘차게 시작하세요!',
                'good_afternoon': '좋은 오후입니다! 프로젝트 진행 상황은 어떤가요?',
                'good_evening': '좋은 저녁입니다! 드디어 퇴근하시나요? 저녁 계획이 있으세요?',
                'working_late': '안녕하세요! 잘 지내고 계신가요? 오늘 저녁은 무엇을 하고 계신가요?',
                'burning_midnight': '괜찮으세요? 이렇게 늦은 시간까지 깨어있는 건 평소와 다릅니다.'
            }
        };

        // Global variables
        let currentModel = 'ode-6-flash';
        let currentStyle = 'normal';
        let currentLanguage = 'en';
        let chatHistory = [];
        let currentChatMessages = [];
        let isSending = false;
        let isGenerating = false;
        let currentController = null;
        let suggestionTimeout = null;
        let userData = {};
        let aiMemory = [];
        let currentChatId = null;
        let selectedArtStyle = 'photorealistic';
        let selectedMusicStyle = 'pop';
        let selectedImageCount = 1;
        let currentProject = null;
        let agentHistory = [];
        let speechSynthesis = window.speechSynthesis;
        let currentFont = 'sans';
        let currentBackground = 'default';
        
        // Separate file management for main and reply inputs
        let uploadedFiles = [];
        let replyUploadedFiles = [];
        
        const API_CONFIG = {
            baseUrl: 'https://api-inference.modelscope.cn/v1',
            apiKey: 'ms-f5263761-e651-4695-a7dd-3e70410e8cb2',
            models: {
                'ode-6-flash': 'gemini-2.5-flash-lite-preview-09-2025-nothinking',
                'ode-6': 'gemini-1.5-flash-002',
                'memory-analyzer': 'gemini-1.5-flash-002',
                'ode-6-deep': 'deepseek-ai/DeepSeek-V3.2-Exp',
                'ode-6-search': 'gemini-2.5-flash-all',
                'ode-6-deep-search': 'deepseek-r1-searching',
                'tylo-aria-image': 'dall-e-3',
                'tylo-aria-video': 'luma_video_api',
                'tylo-aria-music': 'suno_music'
            }
        };
        let isNormalThinking = false;
        let isPostThinking = false;
        let currentStyleIndicator = 'normal';
        let isDeepThinking = false;
        let isWebSearch = false;
        let isCodingMode = false;
        let isSkillMode = false;
        let currentSkill = null;
        const CODING_MODELS = {
            'gpt-5': { name: 'GPT-5', cost: 300, api: 'gemini-2.5-flash-lite-preview-09-2025-nothinking' },
            'claude-sonnet-4.5': { name: 'Claude Sonnet 4.5', cost: 500, api: 'gemini-2.5-flash-lite-preview-09-2025-nothinking' },
            'claude-opus-4.1': { name: 'Claude Opus 4.1', cost: 1000, api: 'gemini-2.5-flash-lite-preview-09-2025-nothinking' },
            'gemini-2.5-pro': { name: 'Gemini 2.5 Pro', cost: 100, api: 'gemini-2.5-flash-lite-preview-09-2025-nothinking' },
            'ode-6-code': { name: 'ode-6-code', cost: 0, api: 'gemini-2.5-flash-lite-preview-09-2025-nothinking' }
        };

        document.getElementById('advancedOptionsBtn').addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            
            const menu = document.getElementById('advancedOptionsMenu');
            const modelOptions = document.getElementById('modelOptions');
            
            // Close model options if open
            if (modelOptions) {
                modelOptions.classList.remove('open');
            }
            
            // Toggle advanced options menu using 'open' class
            menu.classList.toggle('open');
        });

        // Deep Thinking parent option hover handling
        document.getElementById('deepThinkingOption').addEventListener('mouseenter', function() {
            const submenu = this.querySelector('.aria-submenu');
            if (submenu) {
                submenu.style.opacity = '1';
                submenu.style.visibility = 'visible';
                submenu.style.transform = 'translateX(0)';
            }
        });

        document.getElementById('deepThinkingOption').addEventListener('mouseleave', function() {
            const submenu = this.querySelector('.aria-submenu');
            if (submenu) {
                submenu.style.opacity = '0';
                submenu.style.visibility = 'hidden';
                submenu.style.transform = 'translateX(-10px)';
            }
        });

        // Normal Thinking Option
        // Normal Thinking Option
        const normalThinkingEl = document.getElementById('normalThinkingOption');
        if (normalThinkingEl) {
            normalThinkingEl.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Check points for non-pro users
                if (!userData.isPro && !userData.isStudent && !deductPoints(100)) {
                    return;
                }
                
                // Disable post thinking if active
                if (isPostThinking) {
                    isPostThinking = false;
                    document.getElementById('postThinkingIndicator').classList.add('hidden');
                }
                
                // Disable web search if active
                // Remove this part:
                // Disable web search if active
                // if (isWebSearch) {
                    // isWebSearch = false;
                    // document.getElementById('searchIndicator').classList.add('hidden');
                // }
                
                isNormalThinking = true;
                isDeepThinking = true; // Keep for compatibility
                document.getElementById('normalThinkingIndicator').classList.remove('hidden');
                document.getElementById('advancedOptionsMenu').classList.remove('open');
                updateIndicatorPositions();
            });
        }

        // Post Thinking Option
        // Post Thinking Option
        const postThinkingEl = document.getElementById('postThinkingOption');
        if (postThinkingEl) {
            postThinkingEl.addEventListener('click', function(e) {
                e.stopPropagation();
                
                // Maxç”¨æˆ·æ— é™åˆ¶
                if (userData.isMax) {
                    // ç»§ç»­æ‰§è¡Œï¼Œä¸æ˜¾ç¤ºä»»ä½•è®¡æ•°
                } else if (userData.isPro) {
                    // Proç”¨æˆ·ï¼šæ¯æœˆ15æ¬¡ï¼Œåˆ†3ä¸ªæ—¶æœŸ
                    const currentDate = new Date().getDate();
                    let period = 1;
                    if (currentDate >= 11 && currentDate <= 20) period = 2;
                    else if (currentDate >= 21) period = 3;
                    
                    // é‡ç½®æ—¶æœŸ
                    if (userData.postThinkingPeriod !== period) {
                        userData.postThinkingPeriod = period;
                        userData.postThinkingUsageThisMonth = 0;
                        saveAllData();
                    }
                    
                    const periodUsage = userData.postThinkingUsageThisMonth || 0;
                    if (periodUsage >= 5) {
                        alert(`Post Thinking limit for period ${period} reached (5/5). Next reset: Day ${period === 1 ? 11 : period === 2 ? 21 : 1} of ${period === 3 ? 'next month' : 'this month'}.`);
                        return;
                    }
                } else {
                    // Freeç”¨æˆ·ï¼šæ¯æœˆ5æ¬¡
                    const monthlyUsage = userData.postThinkingUsageThisMonth || 0;
                    if (monthlyUsage >= 5) {
                        alert('Monthly Post Thinking limit reached (5/5). Upgrade to Pro or Max for more access.');
                        return;
                    }
                }
    
                
                // Disable normal thinking if active
                if (isNormalThinking) {
                    isNormalThinking = false;
                    isDeepThinking = false;
                    document.getElementById('normalThinkingIndicator').classList.add('hidden');
                }
                
                // Disable web search if active
                if (isWebSearch) {
                    isWebSearch = false;
                    document.getElementById('searchIndicator').classList.add('hidden');
                }
                
                isPostThinking = true;
                document.getElementById('postThinkingIndicator').classList.remove('hidden');
                document.getElementById('advancedOptionsMenu').classList.remove('open');
                updateIndicatorPositions();
            });
        }

        // Add cancel functions
        function cancelNormalThinking() {
            isNormalThinking = false;
            isDeepThinking = false;
            document.getElementById('normalThinkingIndicator').classList.add('hidden');
            updateIndicatorPositions();
        }

        function cancelPostThinking() {
            isPostThinking = false;
            document.getElementById('postThinkingIndicator').classList.add('hidden');
            updateIndicatorPositions();
        }

        // Update indicator positions function
        function updateIndicatorPositions() {
            const indicators = [];
            
            // Check if Prism is connected
            const prismConnected = document.getElementById('prismConnectBtn')?.classList.contains('connected');
            
            if (isNormalThinking) indicators.push('normalThinkingIndicator');
            if (isPostThinking) indicators.push('postThinkingIndicator');
            if (isWebSearch) indicators.push('searchIndicator');
            if (isSkillMode) indicators.push('skillIndicator');
            
            // Show style indicator if any advanced option is active
            if (indicators.length > 0 && currentStyle !== 'normal') {
                document.getElementById('styleIndicator').classList.remove('hidden');
                document.getElementById('styleIndicatorText').textContent = currentStyle.charAt(0).toUpperCase() + currentStyle.slice(1);
                indicators.push('styleIndicator');
            } else {
                document.getElementById('styleIndicator').classList.add('hidden');
            }
            
            // Apply spacing class if Prism is connected
            if (prismConnected) {
                indicators.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.classList.add('indicators-with-prism');
                });
            }
        }

        const webSearchEl = document.getElementById('webSearchOption');
        if (webSearchEl) {
            webSearchEl.addEventListener('click', function() {
                // Check points for non-pro users
                if (!userData.isPro && !userData.isStudent && !deductPoints(100)) {
                    return;
                }
                
                // if (isNormalThinking) {
                    // isNormalThinking = false;
                    // isDeepThinking = false;
                    // document.getElementById('normalThinkingIndicator').classList.add('hidden');
                // }
                
                if (isPostThinking) {
                    isPostThinking = false;
                    document.getElementById('postThinkingIndicator').classList.add('hidden');
                }
                
                isWebSearch = !isWebSearch;
                if (isWebSearch) {
                    document.getElementById('searchIndicator').classList.remove('hidden');
                    this.innerHTML = '<i class="fas fa-search mr-2 text-green-500"></i>Web Search (Active)';
                } else {
                    document.getElementById('searchIndicator').classList.add('hidden');
                    this.innerHTML = '<i class="fas fa-search mr-2"></i>Web Search (+100 pts)';
                }
                document.getElementById('advancedOptionsMenu').classList.remove('open');
                updateIndicatorPositions();
            });
        }

        // Coding Mode Option
        const codingModeEl = document.getElementById('codingModeOption');
        if (codingModeEl) {
            codingModeEl.addEventListener('click', function() {
                if (isCodingMode) {
                    // Already in coding mode, toggle off
                    cancelCodingMode();
                } else {
                    // Enter coding mode
                    if (!userData.isMax && !deductPoints(100)) {
                        return;
                    }
                    
                    // Disable incompatible features
                    if (isWebSearch) {
                        isWebSearch = false;
                        document.getElementById('searchIndicator').classList.add('hidden');
                    }
                    if (isPostThinking) {
                        isPostThinking = false;
                        document.getElementById('postThinkingIndicator').classList.add('hidden');
                    }
                    
                    isCodingMode = true;
                    document.getElementById('codingIndicator').classList.remove('hidden');
                    document.getElementById('advancedOptionsMenu').classList.remove('open');
                    
                    // Switch to coding mode UI
                    switchToCodingMode();
                    
                    updateIndicatorPositions();
                }
            });
        }

        // Skill Mode Options
        const skillOptions = document.querySelectorAll('[data-skill]');
        skillOptions.forEach(option => {
            option.addEventListener('click', function(e) {
                e.stopPropagation();
                const skill = this.dataset.skill;
                
                if (isSkillMode && currentSkill === skill) {
                    // Toggle off
                    cancelSkillMode();
                } else {
                    // Disable incompatible features
                    if (isCodingMode) {
                        cancelCodingMode();
                    }
                    if (isPostThinking) {
                        isPostThinking = false;
                        document.getElementById('postThinkingIndicator').classList.add('hidden');
                    }
                    
                    isSkillMode = true;
                    currentSkill = skill;
                    document.getElementById('skillIndicator').classList.remove('hidden');
                    document.getElementById('advancedOptionsMenu').classList.remove('open');
                    
                    updateIndicatorPositions();
                }
            });
        });

        function cancelCodingMode() {
            isCodingMode = false;
            document.getElementById('codingIndicator').classList.add('hidden');
            switchToNormalMode();
            updateIndicatorPositions();
        }

        function cancelSkillMode() {
            isSkillMode = false;
            currentSkill = null;
            document.getElementById('skillIndicator').classList.add('hidden');
            updateIndicatorPositions();
        }

        function switchToCodingMode() {
            // Hide normal buttons
            document.getElementById('normalInputButtons').classList.add('hidden');
            // Show coding tools
            document.getElementById('codingModeTools').classList.remove('hidden');
            document.getElementById('codingModeTools').classList.add('flex');
            
            // Update model selector with coding models
            const modelOptions = document.getElementById('modelOptions');
            modelOptions.innerHTML = `
                <div class="p-2">
                    ${Object.entries(CODING_MODELS).map(([key, model]) => `
                        <div class="dropdown-option p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer rounded" data-value="${key}" data-cost="${model.cost}">
                            ${model.name} ${model.cost > 0 ? `<span class="model-cost text-xs text-blue-500">${model.cost} pts</span>` : '<span class="text-xs text-green-500">Free</span>'}
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Re-attach click handlers
            modelOptions.querySelectorAll('.dropdown-option').forEach(option => {
                option.addEventListener('click', function() {
                    currentModel = this.dataset.value;
                    document.getElementById('modelDisplayName').textContent = CODING_MODELS[currentModel].name;
                    modelOptions.classList.remove('open');
                });
            });
            
            // Set default to ode-6-code
            currentModel = 'ode-6-code';
            document.getElementById('modelDisplayName').textContent = 'ode-6-code';
        }

        function switchToNormalMode() {
            // Show normal buttons
            document.getElementById('normalInputButtons').classList.remove('hidden');
            // Hide coding tools
            document.getElementById('codingModeTools').classList.add('hidden');
            document.getElementById('codingModeTools').classList.remove('flex');
            
            // Restore original model selector (you'll need to call setupDropdowns again or store original HTML)
            location.reload(); // Simple solution - reload page to restore original state
        }

        function showToolModal(tool) {
            document.getElementById('toolDevModal').classList.remove('hidden');
            document.getElementById('toolDevModal').classList.add('flex');
        }

        document.getElementById('closeToolDevModal').addEventListener('click', function() {
            document.getElementById('toolDevModal').classList.add('hidden');
            document.getElementById('toolDevModal').classList.remove('flex');
        });

        document.getElementById('searchIndicator').addEventListener('click', function() {
            isWebSearch = false;
            this.classList.add('hidden');
            document.getElementById('webSearchOption').innerHTML = '<i class="fas fa-search mr-2"></i>Web Search (+100 pts)';
        });

        // AI suggestions pool with language support
        const AI_SUGGESTIONS_POOL = {
            'en': [
                "Explain quantum computing",
                "Help me write an email", 
                "Create a workout plan",
                "Explain machine learning",
                "Help me learn Python",
                "Plan a trip to Japan",
                "Write a story about space",
                "Solve this math problem",
                "Review my resume",
                "Cooking recipe ideas",
                "Generate a beautiful landscape image",
                "Create a short video about nature",
                "Compose a relaxing song"
            ],
            'zh-cn': [
                "è§£é‡Šé‡å­è®¡ç®—",
                "å¸®æˆ‘å†™ä¸€å°é‚®ä»¶",
                "åˆ¶å®šé”»ç‚¼è®¡åˆ’",
                "è§£é‡Šæœºå™¨å­¦ä¹ ",
                "å¸®æˆ‘å­¦ä¹ Python",
                "è§„åˆ’æ—¥æœ¬æ—…è¡Œ",
                "å†™ä¸€ä¸ªå…³äºŽå¤ªç©ºçš„æ•…äº‹",
                "è§£å†³è¿™ä¸ªæ•°å­¦é—®é¢˜",
                "å®¡æ ¸æˆ‘çš„ç®€åŽ†",
                "çƒ˜ç„™é£Ÿè°±åˆ›æ„",
                "ç”Ÿæˆç¾Žä¸½çš„é£Žæ™¯å›¾ç‰‡",
                "åˆ›å»ºå…³äºŽè‡ªç„¶çš„çŸ­è§†é¢‘",
                "åˆ¶ä½œè½»æ¾çš„æ­Œæ›²"
            ]
        };

        // Achievement definitions
        const ACHIEVEMENTS = {
            'first_chat': { name: 'First Steps', description: 'Send your first message', xp: 50, icon: 'fa-comments' },
            'tutorial_complete': { name: 'Tutorial Master', description: 'Complete the tutorial', xp: 100, icon: 'fa-graduation-cap' },
            'daily_checkin_1': { name: 'Consistent', description: 'Check in for 1 day', xp: 25, icon: 'fa-calendar-check' },
            'daily_checkin_7': { name: 'Dedicated', description: 'Check in for 7 days', xp: 100, icon: 'fa-fire' },
            'level_up_5': { name: 'Experienced', description: 'Reach level 5', xp: 200, icon: 'fa-star' },
            'chat_count_10': { name: 'Chatty', description: 'Send 10 messages', xp: 75, icon: 'fa-comment-dots' },
            'model_explorer': { name: 'Explorer', description: 'Try all AI models', xp: 150, icon: 'fa-compass' },
            'first_image': { name: 'Artist', description: 'Generate your first image', xp: 100, icon: 'fa-paint-brush' },
            'first_video': { name: 'Director', description: 'Generate your first video', xp: 200, icon: 'fa-video' },
            'first_music': { name: 'Composer', description: 'Create your first music', xp: 150, icon: 'fa-music' },
            'first_project': { name: 'Project Manager', description: 'Create your first Agent project', xp: 100, icon: 'fa-project-diagram' },
            'first_research': { name: 'Researcher', description: 'Use Research mode for the first time', xp: 75, icon: 'fa-search' }
        };

        // Canvas management
        let currentArtifact = null;
        let consoleMessages = [];

        // Quick action prompts
        const QUICK_ACTION_PROMPTS = {
            'writing': {
                'en': 'Help me with writing. I need assistance with',
                'zh-cn': 'å¸®æˆ‘å¤„ç†å†™ä½œç›¸å…³éœ€æ±‚ï¼Œæˆ‘éœ€è¦ä»¥ä¸‹æ–¹é¢çš„å¸®åŠ©ï¼š'
            },
            'learning': {
                'en': 'I want to learn about',
                'zh-cn': 'æˆ‘æƒ³å­¦ä¹ å…³äºŽ'
            },
            'code': {
                'en': 'Help me with programming. I need to',
                'zh-cn': 'å¸®æˆ‘è§£å†³ç¼–ç¨‹é—®é¢˜ï¼Œæˆ‘éœ€è¦'
            },
            'life': {
                'en': 'I need life advice about',
                'zh-cn': 'æˆ‘éœ€è¦å…³äºŽä»¥ä¸‹æ–¹é¢çš„ç”Ÿæ´»å»ºè®®ï¼š'
            }
        };

        // Translation system functions
        function translate(key, ...params) {
            let translation = TRANSLATIONS[currentLanguage]?.[key] || TRANSLATIONS['en'][key] || key;
            if (params.length > 0) {
                params.forEach((param, index) => {
                    translation = translation.replace(`{${index}}`, param);
                });
            }
            return translation;
        }

        function updateAllTranslations() {
            document.querySelectorAll('[data-translate]').forEach(element => {
                const key = element.getAttribute('data-translate');
                element.textContent = translate(key);
            });
            
            document.querySelectorAll('[data-translate-placeholder]').forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                element.placeholder = translate(key);
            });
            
            updateTimeGreeting();
            updateUIFromUserData();
        }

        function setLanguage(lang) {
            currentLanguage = lang;
            userData.language = lang;
            document.getElementById('languageDisplay').textContent = 
                document.querySelector(`[data-lang="${lang}"]`).textContent;
            
            const langMemory = {
                keyword: 'language',
                context: `User prefers ${lang} language`,
                message: `Language preference set to ${lang}`,
                timestamp: new Date().toISOString(),
                isUser: true
            };
            
            const existingLangIndex = aiMemory.findIndex(m => m.keyword === 'language');
            if (existingLangIndex !== -1) {
                aiMemory[existingLangIndex] = langMemory;
            } else {
                aiMemory.push(langMemory);
            }
            
            saveAllData();
            updateAllTranslations();
        }

        function saveAllData() {
            try {
                const completeUserData = {
                    ...userData,
                    language: currentLanguage,
                    currentModel: currentModel,
                    currentStyle: currentStyle,
                    darkMode: document.documentElement.classList.contains('dark'),
                    lastSaveTime: new Date().toISOString(),
                    currentFont: currentFont,
                    currentBackground: currentBackground
                };
                
                localStorage.setItem('tyloai_userdata', JSON.stringify(completeUserData));
                localStorage.setItem('tyloai_memory', JSON.stringify(aiMemory));
                localStorage.setItem('tyloai_chats', JSON.stringify(chatHistory));
                localStorage.setItem('tyloai_projects', JSON.stringify(agentHistory));
                localStorage.setItem('tyloai_settings', JSON.stringify({
                    language: currentLanguage,
                    model: currentModel,
                    style: currentStyle,
                    darkMode: document.documentElement.classList.contains('dark'),
                    selectedArtStyle: selectedArtStyle,
                    selectedMusicStyle: selectedMusicStyle,
                    selectedImageCount: selectedImageCount,
                    currentFont: currentFont,
                    currentBackground: currentBackground
                }));
                
                updateUIFromUserData();
                console.log('Data saved successfully');
            } catch (error) {
                console.error('Error saving data to localStorage:', error);
                showAchievement('Warning: Unable to save data to local storage. Your progress may not be preserved.');
            }
            // Ã¥Å“Â¨saveAllDataÃ¥â€¡Â½Ã¦â€¢Â°Ã¦Å“Â«Ã¥Â°Â¾Ã¦Â·Â»Ã¥Å  
            try {
                // Ã§Â¡Â®Ã¤Â¿ÂProÃ§Å Â¶Ã¦â‚¬ÂÃ§â€ºÂ¸Ã¥â€¦Â³Ã§Å¡â€žUIÃ¨Â®Â¾Ã§Â½Â®Ã¤Â¹Å¸Ã¨Â¢Â«Ã¤Â¿ÂÃ¥Â­Ëœ
                const uiSettings = {
                    // isResearchMode: isResearchMode,
                    pointsHidden: userData.isPro || userData.isStudent,
                    lastUIUpdate: new Date().toISOString()
                };
                localStorage.setItem('tyloai_ui_settings', JSON.stringify(uiSettings));
            } catch (error) {
                console.error('Error saving UI settings:', error);
            }
        }

        function loadUserData() {
            try {
                const saved = localStorage.getItem('tyloai_userdata');
                if (saved) {
                    userData = JSON.parse(saved);
                    if (userData.language) {
                        currentLanguage = userData.language;
                    }
                    if (userData.currentFont) {
                        currentFont = userData.currentFont;
                    }
                    if (userData.currentBackground) {
                        currentBackground = userData.currentBackground;
                    }
                } else {
                    userData = {
                        nickname: 'User',
                        avatar: 'https://via.placeholder.com/40',
                        preferences: '',
                        level: 1,
                        xp: 0,
                        points: 3000,
                        isPro: false,
                        isMax: false,
                        region: '',
                        timezone: 'UTC',
                        dailyStreak: 0,
                        lastCheckin: null,
                        tutorialCompleted: false,
                        achievements: [],
                        chatCount: 0,
                        modelsUsed: [],
                        joinDate: new Date().toISOString(),
                        language: 'en',
                        odeUsageThisMonth: 0,
                        agentProjectsThisMonth: 0,
                        researchUsageThisMonth: 0,
                        postThinkingUsageThisMonth: 0,
                        postThinkingPeriod: 1, // 1-10, 2-20, 3-31
                        imagesGeneratedToday: 0,
                        videosGenerated: 0,
                        musicGenerated: 0,
                        lastImageReset: null,
                        lastOdeReset: null,
                        lastAgentReset: null,
                        lastPostThinkingReset: null,
                        monthlyRestoreUsed: false,
                        lastRestoreReset: null,
                        membershipExpiry: null,
                        customBgUrl: ''
                    };
                }
                
                // Initialize missing fields
                if (!userData.odeUsageThisMonth) userData.odeUsageThisMonth = 0;
                if (!userData.agentProjectsThisMonth) userData.agentProjectsThisMonth = 0;
                if (!userData.researchUsageThisMonth) userData.researchUsageThisMonth = 0;
                if (!userData.postThinkingUsageThisMonth) userData.postThinkingUsageThisMonth = 0;
                if (!userData.imagesGeneratedToday) userData.imagesGeneratedToday = 0;
                if (!userData.videosGenerated) userData.videosGenerated = 0;
                if (!userData.musicGenerated) userData.musicGenerated = 0;
                if (!userData.isStudent) userData.isStudent = false;
                if (!userData.customBgUrl) userData.customBgUrl = '';

                // Reset daily counters based on user timezone
                function getUserLocalDate() {
                    if (!userData.timezone) return new Date().toDateString();
                    
                    const now = new Date();
                    const options = { timeZone: userData.timezone, year: 'numeric', month: '2-digit', day: '2-digit' };
                    return new Intl.DateTimeFormat('en-US', options).format(now);
                }

                const userToday = getUserLocalDate();
                const lastReset = userData.lastImageReset ? new Date(userData.lastImageReset).toDateString() : null;

                if (lastReset !== userToday) {
                    userData.imagesGeneratedToday = 0;
                    userData.lastImageReset = new Date().toISOString();
                    
                    // é‡ç½®æ¯æ—¥ç§¯åˆ†
                    if (userData.isMax) {
                        userData.points = 0; // Maxç”¨æˆ·ä¸æ˜¾ç¤ºç§¯åˆ†
                    } else if (userData.isPro) {
                        userData.points = 6000;
                    } else {
                        userData.points = 3000;
                    }
                }
                // Reset monthly counters
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;
                if (userData.lastOdeReset !== currentMonth) {
                    userData.odeUsageThisMonth = 0;
                    userData.lastOdeReset = currentMonth;
                }
                if (userData.lastAgentReset !== currentMonth) {
                    userData.agentProjectsThisMonth = 0;
                    userData.lastAgentReset = currentMonth;
                }
                if (userData.lastResearchReset !== currentMonth) {
                    if (!userData.lastPostThinkingReset || userData.lastPostThinkingReset !== currentMonth) {
                        userData.postThinkingUsageThisMonth = 0;
                        userData.lastPostThinkingReset = currentMonth;
                    }
                    userData.researchUsageThisMonth = 0;
                    userData.lastResearchReset = currentMonth;
                }
                
                const settings = localStorage.getItem('tyloai_settings');
                if (settings) {
                    const settingsData = JSON.parse(settings);
                    currentLanguage = settingsData.language || 'en';
                    currentModel = settingsData.model || 'ode-5-flash';
                    currentStyle = settingsData.style || 'normal';
                    selectedArtStyle = settingsData.selectedArtStyle || 'photorealistic';
                    selectedMusicStyle = settingsData.selectedMusicStyle || 'pop';
                    selectedImageCount = settingsData.selectedImageCount || 1;
                    currentFont = settingsData.currentFont || 'sans';
                    currentBackground = settingsData.currentBackground || 'default';
                    if (settingsData.darkMode) {
                        document.documentElement.classList.add('dark');
                    }
                }
                
                const memory = localStorage.getItem('tyloai_memory');
                if (memory) {
                    aiMemory = JSON.parse(memory);
                }

                const projects = localStorage.getItem('tyloai_projects');
                if (projects) {
                    agentHistory = JSON.parse(projects);
                }
                
                // Apply font and background
                applyFont(currentFont);
                applyBackground(currentBackground);
                
                console.log('User data loaded successfully');
            } catch (error) {
                console.error('Error loading data from localStorage:', error);
                userData = {
                    nickname: 'User',
                    avatar: 'https://via.placeholder.com/40',
                    preferences: '',
                    level: 1,
                    xp: 0,
                    points: 3000,
                    isPro: false,
                    isStudent: false,
                    dailyStreak: 0,
                    lastCheckin: null,
                    tutorialCompleted: false,
                    achievements: [],
                    chatCount: 0,
                    modelsUsed: [],
                    joinDate: new Date().toISOString(),
                    language: 'en',
                    odeUsageThisMonth: 0,
                    agentProjectsThisMonth: 0,
                    imagesGeneratedToday: 0,
                    videosGenerated: 0,
                    musicGenerated: 0,
                    lastImageReset: null,
                    lastOdeReset: null,
                    lastAgentReset: null,
                    studentPlanExpiry: null,
                    membershipExpiry: null,
                    customBgUrl: ''
                };
            }
        }

        function applyFont(fontFamily) {
            document.body.classList.remove('font-sans', 'font-serif', 'font-mono');
            document.body.classList.add(`font-${fontFamily}`);
        }

        function applyBackground(background) {
            const chatContainer = document.getElementById('chatContainer');
            const mainContent = document.getElementById('mainContent');
            
            chatContainer.classList.remove('bg-custom');
            mainContent.style.removeProperty('--custom-bg');
            
            if (background === 'coffee') {
                mainContent.style.setProperty('--custom-bg', 'linear-gradient(135deg, #8B4513, #D2691E, #F4A460)');
                chatContainer.classList.add('bg-custom');
            } else if (background === 'custom' && userData.customBgUrl) {
                mainContent.style.setProperty('--custom-bg', `url(${userData.customBgUrl})`);
                chatContainer.classList.add('bg-custom');
            }
        }

        // Text-to-Speech functionality
        function speakText(text, language = currentLanguage) {
            if ('speechSynthesis' in window) {
                // Stop any ongoing speech
                speechSynthesis.cancel();
                
                // Clean the text (remove markdown and HTML)
                const cleanText = text
                    .replace(/\*\*(.*?)\*\*/g, '$1') // Remove bold markdown
                    .replace(/\*(.*?)\*/g, '$1') // Remove italic markdown
                    .replace(/`(.*?)`/g, '$1') // Remove code markdown
                    .replace(/<[^>]*>/g, '') // Remove HTML tags
                    .replace(/#{1,6}\s/g, '') // Remove markdown headers
                    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1') // Convert links to just text
                    .trim();
                
                if (cleanText) {
                    const utterance = new SpeechSynthesisUtterance(cleanText);
                    
                    // Set language based on current language
                    switch(language) {
                        case 'zh-cn':
                            utterance.lang = 'zh-CN';
                            break;
                        case 'zh-tw':
                            utterance.lang = 'zh-TW';
                            break;
                        case 'ja':
                            utterance.lang = 'ja-JP';
                            break;
                        case 'ko':
                            utterance.lang = 'ko-KR';
                            break;
                        default:
                            utterance.lang = 'en-US';
                    }
                    
                    utterance.rate = 1;
                    utterance.pitch = 1;
                    utterance.volume = 1;
                    
                    speechSynthesis.speak(utterance);
                }
            } else {
                alert('Speech synthesis is not supported in your browser.');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
        checkPrismConnection();
            // YouTube popup logic
            setTimeout(() => {
                const today = new Date().toDateString();
                const lastDismissed = localStorage.getItem('tyloai_youtube_dismissed');
                
                if (lastDismissed !== today) {
                    document.getElementById('youtubePopup').classList.remove('hidden');
                    document.getElementById('youtubePopup').classList.add('flex');
                }
            }, 2000);

            document.getElementById('closeYoutubePopup').addEventListener('click', () => {
                document.getElementById('youtubePopup').classList.add('hidden');
                document.getElementById('youtubePopup').classList.remove('flex');
            });

            document.getElementById('dontShowToday').addEventListener('click', () => {
                const today = new Date().toDateString();
                localStorage.setItem('tyloai_youtube_dismissed', today);
                document.getElementById('youtubePopup').classList.add('hidden');
                document.getElementById('youtubePopup').classList.remove('flex');
            });
            // Check for payment return
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'return' || urlParams.get('trade_status')) {
                const pendingOrder = JSON.parse(localStorage.getItem('pendingOrder') || '{}');
                
                if (urlParams.get('trade_status') === 'TRADE_SUCCESS' || urlParams.get('trade_no')) {
                    // Payment successful
                    userData.isPro = true;
                    userData.membershipExpiry = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString();
                    saveAllData();
                    localStorage.removeItem('pendingOrder');
                    
                    showSuccessModal('Payment Successful!', 'Welcome to TyloAI Pro! Enjoy unlimited access to all features.');
                    updateUIFromUserData();
                    
                    // Clean URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
            try {
                loadUserData();
                
                if (userData.membershipExpiry) {
                    checkMembershipExpiry();
                }
                
                updateTimeGreeting();
                setupEventListeners();
                setupArtifactSystem(); // æ–°å¢ž
                setupDropdowns();
                setupAutoResize();
                setupFileUpload();
                setupMediaOptions();
                setupCanvasFeature();
                setupAgentFeature();
                initDarkMode();
                checkDailyTasks();
                loadChatHistory();
                updateUIFromUserData();
                updateAllTranslations();
                
                const initialLangOption = document.querySelector(`[data-lang="${currentLanguage}"]`);
                if (initialLangOption) {
                    document.getElementById('languageDisplay').textContent = initialLangOption.textContent;
                }
                
                if (!userData.tutorialCompleted) {
                    setTimeout(() => showTutorial(), 1000);
                }
                
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('data:text/javascript,console.log("PWA ready")');
                }
                
                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.shiftKey && e.key === 'D') {
                        toggleDebug();
                    }
                });

                const tutorialStyle = document.createElement('style');
                tutorialStyle.textContent = '.tutorial-highlight{box-shadow:0 0 0 3px #3b82f6,0 0 20px rgba(59,130,246,0.5)!important;animation:tutorialPulse 2s ease-in-out infinite!important}@keyframes tutorialPulse{0%,100%{box-shadow:0 0 0 3px #3b82f6,0 0 20px rgba(59,130,246,0.5)}50%{box-shadow:0 0 0 5px #3b82f6,0 0 30px rgba(59,130,246,0.7)}}';
                document.head.appendChild(tutorialStyle);
                
                setupAutoSuggestions();

                setTimeout(() => {
                    updateUIFromUserData();
                    updateMemoryList();
                    updateAchievementsList();
                    updateDailyTasks();
                    saveAllData();
                }, 100);
                
                console.log('TyloAI initialized successfully');
            } catch (error) {
                console.error('Error initializing TyloAI:', error);
                alert('Failed to initialize TyloAI. Please refresh the page and try again.');
            }
            // Re-bind payment buttons after full initialization
            setTimeout(() => {
                const proBtn = document.getElementById('proUpgradeBtn') || document.getElementById('paymentBtn');
                if (proBtn && !proBtn.hasAttribute('data-bound')) {
                    proBtn.setAttribute('data-bound', 'true');
                    proBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        handlePayment();
                    });
                }
            }, 500);
        });

        function setupAgentFeature() {
            document.getElementById('projectBtn').addEventListener('click', openProjectModal);
            document.getElementById('closeProjectModal').addEventListener('click', closeProjectModal);
            document.getElementById('createProject').addEventListener('click', createProject);
            document.getElementById('closeAgent').addEventListener('click', closeAgentView);
            document.getElementById('agentSendButton').addEventListener('click', sendAgentMessage);
            document.getElementById('viewDebateHistory').addEventListener('click', viewDebateHistory);
            
            // Auto-resize for agent input
            const agentInput = document.getElementById('agentInput');
            agentInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            });
            
            agentInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey && this.value.trim() !== '') {
                    e.preventDefault();
                    sendAgentMessage();
                }
            });
        }

        function openProjectModal() {
            if (!userData.isPro && !userData.isStudent && (userData.agentProjectsThisMonth || 0) >= 5) {
                alert('Monthly Agent project limit reached (5/5). Upgrade to Pro or Student plan for unlimited access.');
                return;
            }
            
            document.getElementById('projectModal').classList.remove('hidden');
            document.getElementById('projectModal').classList.add('flex');
        }

        function closeProjectModal() {
            document.getElementById('projectModal').classList.add('hidden');
            document.getElementById('projectModal').classList.remove('flex');
            document.getElementById('projectTitle').value = '';
            document.getElementById('projectObjective').value = '';
        }

        function createProject() {
            const title = document.getElementById('projectTitle').value.trim();
            const objective = document.getElementById('projectObjective').value.trim();
            
            if (!title || !objective) {
                alert('Please fill in both title and objective.');
                return;
            }
            
            currentProject = {
                id: Date.now().toString(),
                title: title,
                objective: objective,
                createdAt: new Date().toISOString(),
                debates: [],
                currentPhase: 'analysis'
            };
            
            agentHistory.push(currentProject);
            userData.agentProjectsThisMonth = (userData.agentProjectsThisMonth || 0) + 1;
            
            if (!(userData.achievements || []).includes('first_project')) {
                unlockAchievement('first_project');
            }
            
            saveAllData();
            closeProjectModal();
            openAgentView();
        }

        function openAgentView() {
            document.getElementById('agentTitle').textContent = currentProject.title;
            document.getElementById('agentObjective').textContent = currentProject.objective;
            document.getElementById('agentView').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            
            // Clear columns
            document.getElementById('agentColumn1').innerHTML = '';
            document.getElementById('agentColumn2').innerHTML = '';
            document.getElementById('agentColumn3').innerHTML = '';
        }

        function closeAgentView() {
            document.getElementById('agentView').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            currentProject = null;
        }

        async function sendAgentMessage() {
            const input = document.getElementById('agentInput');
            const message = input.value.trim();
            if (!message || !currentProject) return;
            
            input.value = '';
            input.style.height = 'auto';
            input.style.display = 'none'; // Ã©Å¡ÂÃ¨â€”ÂÃ¨Â¾â€œÃ¥â€¦Â¥Ã¦Â¡â€ 
            
            try {
                // Phase 1: Ã¥Ë†ÂÃ¥Â§â€¹Ã¥Ë†â€ Ã¦Å¾ÂÃ©ËœÂ¶Ã¦Â®Âµ - Ã¦ÂµÂÃ¥Â¼ÂÃ¨Â¾â€œÃ¥â€¡Âº
                await agentPhase1(message);
                
                // Phase 2: Ã¨Â¾Â©Ã¨Â®ÂºÃ©ËœÂ¶Ã¦Â®Âµ - Ã¦ÂµÂÃ¥Â¼ÂÃ¨Â¾â€œÃ¥â€¡Âº
                await agentPhase2(message);
                
                // Phase 3: Ã¦Å“â‚¬Ã§Â»Ë†Ã§Â­â€Ã¦Â¡Ë† - Ã¦ÂµÂÃ¥Â¼ÂÃ¨Â¾â€œÃ¥â€¡Âº
                await agentPhase3(message);
                
                // Ã¤Â¿ÂÃ¥Â­ËœÃ¥Ë†Â°Ã¥Å½â€ Ã¥ÂÂ²Ã¨Â®Â°Ã¥Â½â€¢
                saveAgentToHistory();
                
            } catch (error) {
                console.error('Error in agent processing:', error);
            } finally {
                input.style.display = 'block'; // Ã¦ÂÂ¢Ã¥Â¤ÂÃ¨Â¾â€œÃ¥â€¦Â¥Ã¦Â¡â€ 
            }
        }

        async function agentPhase1(message) {
            // Ã¦Â¸â€¦Ã§Â©ÂºÃ¥Â¹Â¶Ã¨Â®Â¾Ã§Â½Â®Ã¥Å  Ã¨Â½Â½Ã§Å Â¶Ã¦â‚¬Â
            document.getElementById('agentColumn1').innerHTML = '<div class="ai-typing"></div>';
            document.getElementById('agentColumn2').innerHTML = '<div class="ai-typing"></div>';
            document.getElementById('agentColumn3').innerHTML = '<div class="ai-typing"></div>';
            
            // Ã¦ÂµÂÃ¥Â¼ÂÃ¨Â¾â€œÃ¥â€¡ÂºÃ¥Ë†â€ Ã¦Å¾Â
            const analysisPrompt = `Project: ${currentProject.title}\nObjective: ${currentProject.objective}\n\nUser Question: ${message}\n\nAs an expert analyst, provide a thorough analysis of this question in the context of the project objective. Focus on breaking down the problem, identifying key components, and providing detailed insights.`;
            const analysis = await streamAgentAPI(analysisPrompt, 'agentColumn1');
            
            // Ã¦ÂµÂÃ¥Â¼ÂÃ¨Â¾â€œÃ¥â€¡ÂºÃ§Â»Â¼Ã¥ÂË†
            const synthesisPrompt = `Project: ${currentProject.title}\nObjective: ${currentProject.objective}\n\nUser Question: ${message}\n\nAnalysis: ${analysis}\n\nAs a synthesis expert, combine and synthesize the analysis with alternative perspectives. Provide a balanced view that considers different approaches and methodologies.`;
            const synthesis = await streamAgentAPI(synthesisPrompt, 'agentColumn2');
            
            // Ã¦ÂµÂÃ¥Â¼ÂÃ¨Â¾â€œÃ¥â€¡ÂºÃ§Â»â€œÃ¨Â®Âº
            const conclusionPrompt = `Project: ${currentProject.title}\nObjective: ${currentProject.objective}\n\nUser Question: ${message}\n\nAnalysis: ${analysis}\n\nSynthesis: ${synthesis}\n\nAs a decision expert, provide final conclusions and actionable recommendations based on the analysis and synthesis. Focus on practical next steps and clear outcomes.`;
            const conclusion = await streamAgentAPI(conclusionPrompt, 'agentColumn3');
            
            currentProject.phase1 = { analysis, synthesis, conclusion };
        }

        async function agentPhase2(message) {
            // Ã¦Â¸â€¦Ã§Â©ÂºÃ©Â¡ÂµÃ©ÂÂ¢
            document.getElementById('agentColumn1').innerHTML = '<h3 class="font-bold mb-4">AI Agent 1 - Ã¨Â¾Â©Ã¨Â®Âº</h3>';
            document.getElementById('agentColumn2').innerHTML = '<h3 class="font-bold mb-4">AI Agent 2 - Ã¨Â¾Â©Ã¨Â®Âº</h3>';
            document.getElementById('agentColumn3').innerHTML = '<h3 class="font-bold mb-4">AI Agent 3 - Ã¨Â¾Â©Ã¨Â®Âº</h3>';
            
            // Ã¨Â¾Â©Ã¨Â®ÂºÃ¨Â½Â®Ã¦Â¬Â¡
            const debatePrompt1 = `Based on the previous analysis, present your strongest argument for the best approach to: ${message}. Consider the project: ${currentProject.title}`;
            const debate1 = await streamAgentAPI(debatePrompt1, 'agentColumn1');
            
            const debatePrompt2 = `Respond to Agent 1's argument and present an alternative perspective: ${debate1}. Focus on potential weaknesses and propose better solutions.`;
            const debate2 = await streamAgentAPI(debatePrompt2, 'agentColumn2');
            
            const debatePrompt3 = `Consider both previous arguments and synthesize the best elements while addressing their limitations: Agent 1: ${debate1}\nAgent 2: ${debate2}`;
            const debate3 = await streamAgentAPI(debatePrompt3, 'agentColumn3');
            
            currentProject.phase2 = { debate1, debate2, debate3 };
        }

        async function agentPhase3(message) {
            // Ã¦Â¸â€¦Ã§Â©ÂºÃ©Â¡ÂµÃ©ÂÂ¢Ã¦ËœÂ¾Ã§Â¤ÂºÃ¦Å“â‚¬Ã§Â»Ë†Ã§Â­â€Ã¦Â¡Ë†
            document.getElementById('agentColumn1').innerHTML = '';
            document.getElementById('agentColumn2').innerHTML = '<h3 class="font-bold mb-4 text-center">Ã¦Å“â‚¬Ã§Â»Ë†Ã§Â­â€Ã¦Â¡Ë†</h3>';
            document.getElementById('agentColumn3').innerHTML = '';
            
            const finalPrompt = `Based on all previous analysis and debates, provide the definitive, comprehensive answer to: ${message}

        Project Context: ${currentProject.title} - ${currentProject.objective}

        Previous Analysis: ${currentProject.phase1.analysis}
        Previous Synthesis: ${currentProject.phase1.synthesis}
        Previous Conclusion: ${currentProject.phase1.conclusion}

        Debate Summary:
        Agent 1: ${currentProject.phase2.debate1}
        Agent 2: ${currentProject.phase2.debate2}
        Agent 3: ${currentProject.phase2.debate3}

        Provide a final, authoritative answer that incorporates the best insights from all previous phases.`;
            
            const finalAnswer = await streamAgentAPI(finalPrompt, 'agentColumn2');
            
            currentProject.debates.push({
                question: message,
                phase1: currentProject.phase1,
                phase2: currentProject.phase2,
                finalAnswer: finalAnswer,
                timestamp: new Date().toISOString()
            });
        }

        async function streamAgentAPI(prompt, targetElementId) {
            const targetElement = document.getElementById(targetElementId);
            let fullResponse = '';
            
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gemini-2.5-flash-lite-preview-09-2025-nothinking',
                        messages: [
                            { role: 'system', content: 'You are an expert AI assistant specialized in detailed analysis and problem-solving.' },
                            { role: 'user', content: prompt }
                        ],
                        stream: true,
                        temperature: 0.7
                    })
                });
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                const content = parsed.choices?.[0]?.delta?.content;
                                if (content) {
                                    fullResponse += content;
                                    targetElement.innerHTML = marked.parse(fullResponse);
                                    targetElement.scrollTop = targetElement.scrollHeight;
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    }
                }
                
                return fullResponse;
            } catch (error) {
                console.error('Error in stream agent API:', error);
                targetElement.innerHTML = '<p class="text-red-500">Error occurred</p>';
                return '';
            }
        }

        function saveAgentToHistory() {
            // Ã§â€Å¸Ã¦Ë†ÂÃ¨ÂÅ Ã¥Â¤Â©Ã¦ â€¡Ã©Â¢Ëœ
            const title = `[Agent] ${currentProject.title}`;
            
            // Ã¥Ë†â€ºÃ¥Â»ÂºÃ¨ÂÅ Ã¥Â¤Â©Ã¨Â®Â°Ã¥Â½â€¢Ã¦ Â¼Ã¥Â¼Â
            const agentChat = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                title: title,
                messages: [{
                    role: 'assistant',
                    content: `AgentÃ©Â¡Â¹Ã§â€ºÂ®Ã¥Â®Å’Ã¦Ë†Â\n\nÃ©Â¡Â¹Ã§â€ºÂ®: ${currentProject.title}\nÃ§â€ºÂ®Ã¦ â€¡: ${currentProject.objective}\n\nÃ¦Å“â‚¬Ã¦â€“Â°Ã©â€”Â®Ã§Â­â€Ã¥Â·Â²Ã¤Â¿ÂÃ¥Â­ËœÃ¥Ë†Â°Ã©Â¡Â¹Ã§â€ºÂ®Ã¥Å½â€ Ã¥ÂÂ²Ã¤Â¸Â­Ã£â‚¬â€š`
                }],
                timestamp: new Date().toISOString(),
                isAgent: true
            };
            
            // Ã¦Â·Â»Ã¥Å  Ã¥Ë†Â°Ã¨ÂÅ Ã¥Â¤Â©Ã¥Å½â€ Ã¥ÂÂ²
            chatHistory.unshift(agentChat);
            saveChatHistory();
            updateChatHistoryUI();
            saveAllData();
        }

        async function callAgentAPI(prompt, model) {
            const apiModel = API_CONFIG.models[model];
            
            const response = await fetch(`${API_CONFIG.baseUrl}/chat/completions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_CONFIG.apiKey}`
                },
                body: JSON.stringify({
                    model: apiModel,
                    messages: [
                        { role: 'system', content: 'You are an expert AI assistant specialized in detailed analysis and problem-solving.' },
                        { role: 'user', content: prompt }
                    ],
                    temperature: 0.7,
                    max_tokens: 1000
                })
            });
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        function viewDebateHistory() {
            if (!currentProject || !currentProject.debates.length) {
                alert('No debate history available for this project.');
                return;
            }
            
            const historyWindow = window.open('', '_blank', 'width=800,height=600');
            historyWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${currentProject.title} - Debate History</title>
                    <style>
                        body { font-family: system-ui, sans-serif; margin: 20px; line-height: 1.6; }
                        .debate { margin-bottom: 30px; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
                        .phase { margin: 15px 0; }
                        .phase h4 { color: #2563eb; margin-bottom: 8px; }
                        .timestamp { color: #6b7280; font-size: 0.875rem; }
                    </style>
                </head>
                <body>
                    <h1>${currentProject.title}</h1>
                    <p><strong>Objective:</strong> ${currentProject.objective}</p>
                    <hr>
                    ${currentProject.debates.map((debate, index) => `
                        <div class="debate">
                            <h3>Question ${index + 1}: ${debate.question}</h3>
                            <div class="timestamp">${new Date(debate.timestamp).toLocaleString()}</div>
                            
                            <div class="phase">
                                <h4>Analysis</h4>
                                <div>${marked.parse(debate.analysis)}</div>
                            </div>
                            
                            <div class="phase">
                                <h4>Synthesis</h4>
                                <div>${marked.parse(debate.synthesis)}</div>
                            </div>
                            
                            <div class="phase">
                                <h4>Conclusion</h4>
                                <div>${marked.parse(debate.conclusion)}</div>
                            </div>
                        </div>
                    `).join('')}
                </body>
                </html>
            `);
        }

        function setupCanvasFeature() {
            document.getElementById('closeCanvas').addEventListener('click', closeCanvas);
            document.getElementById('refreshCanvas').addEventListener('click', refreshCanvas);
            document.getElementById('copyCanvasCode').addEventListener('click', copyCanvasCode);
            document.getElementById('clearConsole').addEventListener('click', clearConsole);
            
            document.querySelectorAll('.canvas-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchCanvasTab(this.dataset.tab);
                });
            });
            
            document.getElementById('fixWithAI').addEventListener('click', function() {
                const lastError = consoleMessages[consoleMessages.length - 1];
                if (lastError && lastError.type === 'error') {
                    closeCanvas();
                    sendFixRequest(lastError.message);
                }
            });
            
            document.getElementById('codeEditor').addEventListener('input', function() {
                if (currentArtifact) {
                    currentArtifact.code = this.value;
                    refreshCanvas();
                }
            });
        }

        function openCanvas(artifact) {
            currentArtifact = artifact;
            document.getElementById('canvasTitle').textContent = artifact.title;
            document.getElementById('canvasLanguage').textContent = artifact.language || 'HTML';
            document.getElementById('codeEditor').value = artifact.code;
            document.getElementById('canvasOverlay').classList.remove('hidden');
            
            switchCanvasTab('preview');
            refreshCanvas();
        }

        function closeCanvas() {
            currentArtifact = null;
            document.getElementById('canvasOverlay').classList.add('hidden');
            clearConsole();
        }

        function refreshCanvas() {
            if (!currentArtifact) return;
            
            const iframe = document.getElementById('canvasIframe');
            const code = document.getElementById('codeEditor').value;
            
            let fullHTML = '';
            if (currentArtifact.language.toLowerCase() === 'html' || currentArtifact.type === 'html') {
                fullHTML = code;
            } else if (currentArtifact.language.toLowerCase() === 'javascript') {
                fullHTML = '<!DOCTYPE html><html><head><title>JavaScript Artifact</title><style>body{font-family:system-ui,-apple-system,sans-serif;margin:20px}.output{background:#f8f9fa;padding:15px;border-radius:8px;margin:10px 0}</style></head><body><div id="output" class="output">Output will appear here...</div><script>const output=document.getElementById("output");const originalConsole={...console};console.log=function(...args){output.innerHTML+="<div><strong>Log:</strong> "+args.join(" ")+"</div>";originalConsole.log(...args);parent.postMessage({type:"console",level:"log",args:args},"*")};console.error=function(...args){output.innerHTML+="<div style=\\"color:red\\"><strong>Error:</strong> "+args.join(" ")+"</div>";originalConsole.error(...args);parent.postMessage({type:"console",level:"error",args:args},"*")};console.warn=function(...args){output.innerHTML+="<div style=\\"color:orange\\"><strong>Warning:</strong> "+args.join(" ")+"</div>";originalConsole.warn(...args);parent.postMessage({type:"console",level:"warn",args:args},"*")};window.onerror=function(message,source,lineno,colno,error){output.innerHTML+="<div style=\\"color:red\\"><strong>Error:</strong> "+message+" (Line: "+lineno+")</div>";parent.postMessage({type:"console",level:"error",args:[message+" (Line: "+lineno+")]},"*");return false};try{' + code + '}catch(error){console.error("Execution error:",error.message)}</' + 'script></body></html>';
            } else {
                fullHTML = '<!DOCTYPE html><html><head><title>Code Preview</title></head><body><pre style="font-family:\'Courier New\',monospace;background:#f8f9fa;padding:20px;border-radius:8px;overflow-x:auto">' + code + '</pre></body></html>';
            }
            
            iframe.srcdoc = fullHTML;
        }

        function switchCanvasTab(tab) {
            document.querySelectorAll('.canvas-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            document.querySelectorAll('.canvas-view').forEach(view => view.classList.add('hidden'));
            
            if (tab === 'preview') {
                document.getElementById('canvasPreview').classList.remove('hidden');
            } else if (tab === 'code') {
                document.getElementById('canvasCode').classList.remove('hidden');
            }
        }

        function copyCanvasCode() {
            const code = document.getElementById('codeEditor').value;
            navigator.clipboard.writeText(code).then(() => {
                const copyBtn = document.getElementById('copyCanvasCode');
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
        }

        function clearConsole() {
            consoleMessages = [];
            document.getElementById('consoleContent').innerHTML = '';
            document.getElementById('fixWithAI').classList.add('hidden');
        }

        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'console') {
                const { level, args } = event.data;
                const message = args.join(' ');
                
                consoleMessages.push({
                    type: level,
                    message: message,
                    timestamp: new Date().toISOString()
                });
                
                const consoleContent = document.getElementById('consoleContent');
                const messageDiv = document.createElement('div');
                messageDiv.className = `console-message ${level}`;
                
                let color = '#e5e5e5';
                if (level === 'error') color = '#ff6b6b';
                else if (level === 'warn') color = '#feca57';
                else if (level === 'log') color = '#48dbfb';
                
                messageDiv.innerHTML = `<span style="color: ${color};">[${level.toUpperCase()}]</span> ${message}`;
                consoleContent.appendChild(messageDiv);
                consoleContent.scrollTop = consoleContent.scrollHeight;
                
                if (level === 'error') {
                    document.getElementById('fixWithAI').classList.remove('hidden');
                }
            }
        });

        function sendFixRequest(errorMessage) {
            const input = document.getElementById('userInput');
            const fixPrompt = `Help Me To Fix: ${errorMessage}\n\nCode:\n${currentArtifact ? currentArtifact.code : 'No code available'}`;
            input.value = fixPrompt;
            
            input.scrollIntoView({ behavior: 'smooth' });
            input.focus();
        }

        function setupMediaOptions() {
            document.querySelectorAll('.art-style-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.art-style-option').forEach(opt => 
                        opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedArtStyle = this.dataset.style;
                    saveAllData();
                });
            });

            document.querySelectorAll('.music-style-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.music-style-option').forEach(opt => 
                        opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMusicStyle = this.dataset.style;
                    saveAllData();
                });
            });

            document.getElementById('imageCount1').addEventListener('click', function() {
                this.classList.add('bg-blue-500', 'text-white');
                this.classList.remove('bg-gray-300', 'dark:bg-gray-600', 'text-gray-700', 'dark:text-gray-300');
                document.getElementById('imageCount2').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('imageCount2').classList.add('bg-gray-300', 'dark:bg-gray-600', 'text-gray-700', 'dark:text-gray-300');
                selectedImageCount = 1;
                saveAllData();
            });

            document.getElementById('imageCount2').addEventListener('click', function() {
                if (!userData.isPro && !userData.isStudent && userData.imagesGeneratedToday >= 1) {
                    alert(translate('insufficient_quota'));
                    return;
                }
                
                this.classList.add('bg-blue-500', 'text-white');
                this.classList.remove('bg-gray-300', 'dark:bg-gray-600', 'text-gray-700', 'dark:text-gray-300');
                document.getElementById('imageCount1').classList.remove('bg-blue-500', 'text-white');
                document.getElementById('imageCount1').classList.add('bg-gray-300', 'dark:bg-gray-600', 'text-gray-700', 'dark:text-gray-300');
                selectedImageCount = 2;
                saveAllData();
            });
        }

        function setupEventListeners() {
        // Prism Connect functionality
            document.getElementById('prismConnectBtn').addEventListener('click', handlePrismConnect);
            document.getElementById('closePrismModal').addEventListener('click', closePrismModal);
            document.getElementById('connectPrismBtn').addEventListener('click', connectToPrism);
            // Max upgrade button
            const maxUpgradeBtn = document.getElementById('maxUpgradeBtn');
            if (maxUpgradeBtn) {
                maxUpgradeBtn.addEventListener('click', function() {
                    closeUpgradeModal();
                    // è¿™é‡Œå¯ä»¥æŽ¥å…¥æ”¯ä»˜ç³»ç»Ÿ
                    alert('Max plan upgrade coming soon! Contact support@tyloai.com for early access.');
                });
            }
            // Ensure all modals are properly initialized
            const upgradeModal = document.getElementById('upgradeModal');
            const paymentMethodModal = document.getElementById('paymentMethodModal');
            const cardPaymentModal = document.getElementById('cardPaymentModal');

            // Add null checks before adding event listeners
            if (!upgradeModal || !paymentMethodModal || !cardPaymentModal) {
                console.error('Payment modals not properly initialized');
            }
            // Quick action buttons
            document.getElementById('agentBtn').addEventListener('click', function() {
                openProjectModal();
            });

            document.getElementById('programmingBtn').addEventListener('click', function() {
                document.querySelectorAll('.quick-action-button').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-500');
                });
                this.classList.add('border-blue-500', 'text-blue-500');
                
                document.getElementById('quickActionContent').classList.remove('hidden');
                document.getElementById('programmingCards').classList.remove('hidden');
                document.getElementById('writingOptions').classList.add('hidden');
                document.getElementById('analysisOptions').classList.add('hidden');
                document.getElementById('learningOptions').classList.add('hidden');
            });

            document.getElementById('writingBtn').addEventListener('click', function() {
                document.querySelectorAll('.quick-action-button').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-500');
                });
                this.classList.add('border-blue-500', 'text-blue-500');
                
                document.getElementById('quickActionContent').classList.remove('hidden');
                document.getElementById('programmingCards').classList.add('hidden');
                document.getElementById('writingOptions').classList.remove('hidden');
                document.getElementById('analysisOptions').classList.add('hidden');
                document.getElementById('learningOptions').classList.add('hidden');
            });

            document.getElementById('analysisBtn').addEventListener('click', function() {
                document.querySelectorAll('.quick-action-button').forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-500');
                });
                this.classList.add('border-blue-500', 'text-blue-500');
                
                document.getElementById('quickActionContent').classList.remove('hidden');
                document.getElementById('programmingCards').classList.add('hidden');
                document.getElementById('writingOptions').classList.add('hidden');
                document.getElementById('analysisOptions').classList.remove('hidden');
                document.getElementById('learningOptions').classList.add('hidden');
            });

            document.getElementById('callBtn').addEventListener('click', function() {
                window.open('tts.html', '_blank');
            });
            try {
                document.getElementById('addPointsBtn')?.addEventListener('click', openPointsModal);
                document.getElementById('closePointsModal')?.addEventListener('click', closePointsModal);
                document.getElementById('redeemPointsBtn')?.addEventListener('click', redeemPoints);

                // Feedback modal
                document.getElementById('closeFeedbackModal').addEventListener('click', closeFeedbackModal);
                document.getElementById('submitFeedback').addEventListener('click', submitFeedback);

                // Success modal
                document.getElementById('closeSuccessModal').addEventListener('click', closeSuccessModal);

                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closePointsModal();
                        closeUpgradeModal();
                        closeSettingsModal();
                        closeFeedbackModal();
                        closeProjectModal();
                        closeStudentModal();
                        closeSuccessModal();
                        closeCanvas();
                    }
                });
                
                document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
                document.getElementById('closeBtn').addEventListener('click', closeSidebar);
                
                document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
                
                document.getElementById('sendButton').addEventListener('click', () => {
                    if (isGenerating) {
                        stopGeneration();
                    } else {
                        sendMessage('userInput');
                    }
                });
                document.getElementById('replySendButton').addEventListener('click', () => sendMessage('replyInput'));
                
                document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
                document.getElementById('closeSettingsModal').addEventListener('click', closeSettingsModal);
                document.getElementById('cancelSettings').addEventListener('click', closeSettingsModal);
                document.getElementById('saveSettings').addEventListener('click', saveUserSettings);
                
                document.getElementById('languageDropdown').addEventListener('click', function(e) {
                    e.stopPropagation();
                    document.getElementById('languageOptions').classList.toggle('hidden');
                });

                document.querySelectorAll('.language-option').forEach(option => {
                    option.addEventListener('click', function() {
                        const lang = this.dataset.lang;
                        setLanguage(lang);
                        document.getElementById('languageDisplay').textContent = this.textContent;
                        document.getElementById('languageOptions').classList.add('hidden');
                    });
                });
                
                // Font selector
                document.getElementById('fontSelector').addEventListener('change', function() {
                    currentFont = this.value;
                    applyFont(currentFont);
                    saveAllData();
                });

                // Background selector
                document.getElementById('backgroundSelector').addEventListener('change', function() {
                    const bgSelector = this.value;
                    const customUrlInput = document.getElementById('customBgUrl');
                    const bgError = document.getElementById('bgUrlError');
                    
                    if (bgSelector === 'custom') {
                        customUrlInput.classList.remove('hidden');
                        if (!userData.isPro && !userData.isStudent) {
                            alert('Custom backgrounds are available for Pro and Student users only.');
                            this.value = 'default';
                            return;
                        }
                    } else {
                        customUrlInput.classList.add('hidden');
                        bgError.classList.add('hidden');
                    }
                    
                    currentBackground = bgSelector;
                    applyBackground(currentBackground);
                    saveAllData();
                });

                document.getElementById('customBgUrl').addEventListener('change', function() {
                    const url = this.value.trim();
                    const bgError = document.getElementById('bgUrlError');
                    
                    if (url) {
                        // Test if image loads
                        const img = new Image();
                        img.onload = () => {
                            userData.customBgUrl = url;
                            applyBackground('custom');
                            bgError.classList.add('hidden');
                            saveAllData();
                        };
                        img.onerror = () => {
                            bgError.classList.remove('hidden');
                            userData.customBgUrl = '';
                            saveAllData();
                        };
                        img.src = url;
                    }
                });
                
                document.getElementById('userPanel').addEventListener('click', openSettingsModal);
                
                document.getElementById('newChatBtn').addEventListener('click', startNewChat);
                
                document.getElementById('uploadBtn').addEventListener('click', () => document.getElementById('fileInput').click());
                document.getElementById('replyUploadBtn').addEventListener('click', () => document.getElementById('replyFileInput').click());
                
                document.getElementById('closeUpgradeModal').addEventListener('click', closeUpgradeModal);
                document.getElementById('closePaymentMethodModal').addEventListener('click', function() {
                    document.getElementById('paymentMethodModal').classList.add('hidden');
                    document.getElementById('paymentMethodModal').classList.remove('flex');
                });

                document.getElementById('cardPaymentBtn').addEventListener('click', function() {
                    document.getElementById('paymentMethodModal').classList.add('hidden');
                    document.getElementById('paymentMethodModal').classList.remove('flex');
                    document.getElementById('cardPaymentModal').classList.remove('hidden');
                    document.getElementById('cardPaymentModal').classList.add('flex');
                });

                document.getElementById('wechatPaymentBtn').addEventListener('click', function() {
                    document.getElementById('paymentMethodModal').classList.add('hidden');
                    document.getElementById('paymentMethodModal').classList.remove('flex');
                    initiateWechatPayment();
                });

                document.getElementById('closeCardPaymentModal').addEventListener('click', function() {
                    document.getElementById('cardPaymentModal').classList.add('hidden');
                    document.getElementById('cardPaymentModal').classList.remove('flex');
                });

                // Card payment form
                document.getElementById('stripePaymentForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                    const expiry = document.getElementById('cardExpiry').value;
                    const cvc = document.getElementById('cardCvc').value;
                    const cardholderName = document.getElementById('cardholderName').value;
                    
                    // Test card validation
                    if (cardNumber === '4242424242424242') {
                        // Simulate successful payment for test
                        document.getElementById('payButtonText').textContent = 'Processing...';
                        
                        setTimeout(() => {
                            // Mark user as Pro
                            userData.isPro = true;
                            userData.membershipExpiry = new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(); // 1 year
                            saveAllData();
                            
                            document.getElementById('cardPaymentModal').classList.add('hidden');
                            document.getElementById('cardPaymentModal').classList.remove('flex');
                            
                            showSuccessModal('Payment Successful!', 'Welcome to TyloAI Pro! Enjoy unlimited access to all features.');
                            updateUIFromUserData();
                        }, 2000);
                    } else {
                        alert('Please use test card number: 4242 4242 4242 4242');
                    }
                });

                // Format card number input
                document.getElementById('cardNumber').addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\s/g, '');
                    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                    e.target.value = formattedValue;
                });

                // Format expiry date
                document.getElementById('cardExpiry').addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length >= 2) {
                        value = value.substring(0, 2) + '/' + value.substring(2, 4);
                    }
                    e.target.value = value;
                });

                // WeChat payment function
                function initiateWechatPayment() {
                    const timestamp = new Date().getTime();
                    const orderNo = 'TYLOAI' + timestamp;
                    
                    // Set form values
                    document.getElementById('wechat_out_trade_no').value = orderNo;
                    document.getElementById('wechat_notify_url').value = window.location.origin + '/payment_notify';
                    document.getElementById('wechat_return_url').value = window.location.origin + '/payment_return';
                    
                    // Calculate sign using new merchant key
                    const params = {
                        money: '0.01', // Test amount - change to 9.99 for production
                        name: 'TyloAI Pro Plan',
                        notify_url: window.location.origin + '/payment_notify',
                        out_trade_no: orderNo,
                        pid: '1480',
                        return_url: window.location.origin + '/payment_return',
                        sitename: 'TyloAI',
                        type: 'wxpay'
                    };
                    
                    // Create sign string
                    const sortedKeys = Object.keys(params).sort();
                    let signStr = '';
                    sortedKeys.forEach(key => {
                        signStr += key + '=' + params[key] + '&';
                    });
                    signStr = signStr.substring(0, signStr.length - 1);
                    signStr += 'xPHKOZ7oTvKJQuy54oGDqUlNqSMkC0Fr'; // New merchant key
                    
                    const sign = MD5(signStr); // You'll need to include the MD5 function from pay.html
                    document.getElementById('wechat_sign').value = sign;
                    
                    // Store order info
                    localStorage.setItem('pendingOrder', JSON.stringify({
                        orderNo: orderNo,
                        amount: '0.01',
                        type: 'pro_upgrade'
                    }));
                    
                    // Submit form
                    document.getElementById('wechatPaymentForm').submit();
                }
                // Fix multiple payment button IDs issue
                const paymentBtn = document.getElementById('paymentBtn');
                if (paymentBtn) {
                    paymentBtn.addEventListener('click', handlePayment);
                }

                // Also add listener for the actual Pro upgrade button
                const upgradeBtns = document.querySelectorAll('[data-translate="upgrade_pro"]');
                upgradeBtns.forEach(btn => {
                    btn.addEventListener('click', handlePayment);
                });
                document.getElementById('redeemBtn').addEventListener('click', redeemCode);
                
                document.getElementById('searchInput').addEventListener('input', searchChats);
                
                // åˆ é™¤è¿™å‡ è¡Œï¼Œå› ä¸ºçŽ°åœ¨åœ¨ showDailyCheckin ä¸­ç»‘å®š
                // const claimBtn = document.getElementById('claimCheckin');
                // if (claimBtn) {
                //     claimBtn.addEventListener('click', claimDailyCheckin);
                // }else {
                //     console.warn('Claim check-in button not found');
                // }
                
                document.getElementById('exportDataBtn').addEventListener('click', exportData);
                document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importFileInput').click());
                document.getElementById('importFileInput').addEventListener('change', importData);
                
                document.getElementById('clearMemoryBtn').addEventListener('click', clearAIMemory);
                
                document.getElementById('tutorialReset').addEventListener('change', function() {
                    if (this.checked) {
                        userData.tutorialCompleted = false;
                        saveAllData();
                    }
                });
                
                console.log('Event listeners setup successfully');
            } catch (error) {
                console.error('Error setting up event listeners:', error);
            }
        }

        // Prism Connection Functions
function handlePrismConnect() {
    const prismConnected = localStorage.getItem('prism_connected') === 'true';
    
    if (!prismConnected) {
        // First time clicking - show modal
        document.getElementById('prismFirstConnectModal').classList.remove('hidden');
        document.getElementById('prismFirstConnectModal').classList.add('flex');
    } else {
        // Already connected - toggle connection
        const isActive = document.getElementById('prismConnectBtn').classList.contains('connected');
        if (isActive) {
            disconnectPrism();
        } else {
            activatePrismConnection();
        }
    }
}

function closePrismModal() {
    document.getElementById('prismFirstConnectModal').classList.add('hidden');
    document.getElementById('prismFirstConnectModal').classList.remove('flex');
}

function connectToPrism() {
    // Save to localStorage
    localStorage.setItem('prism_first_connect_time', new Date().toISOString());
    
    // Redirect to connect page with return URL
    const returnUrl = encodeURIComponent(window.location.href);
    window.location.href = `prism-connect-with-tyloai.html?return=${returnUrl}&userId=${userData.nickname || 'user'}&action=connect`;
}

function activatePrismConnection() {
    const btn = document.getElementById('prismConnectBtn');
    btn.classList.add('connected');
    
    // Add indicator class to shift other indicators
    document.querySelectorAll('#normalThinkingIndicator, #postThinkingIndicator, #styleIndicator, #searchIndicator')
        .forEach(el => el.classList.add('indicators-with-prism'));
    
    showAchievement('Prism connection activated!');
}

function disconnectPrism() {
    if (confirm('Are you sure you want to disconnect from Prism? Your learning data will no longer be synced.')) {
        const btn = document.getElementById('prismConnectBtn');
        btn.classList.remove('connected');
        
        // Remove indicator class
        document.querySelectorAll('#normalThinkingIndicator, #postThinkingIndicator, #styleIndicator, #searchIndicator')
            .forEach(el => el.classList.remove('indicators-with-prism'));
        
        localStorage.removeItem('prism_connected');
        localStorage.removeItem('prism_access_token');
        localStorage.removeItem('prism_user_data');
        
        showAchievement('Prism disconnected successfully');
    }
}

// Check Prism connection status on load
function checkPrismConnection() {
    const prismConnected = localStorage.getItem('prism_connected') === 'true';
    if (prismConnected) {
        document.getElementById('prismConnectBtn').classList.add('connected');
    }
    
    // Handle return from Prism connect page
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('prism_connected') === 'true') {
        const accessToken = urlParams.get('access_token');
        const userData = urlParams.get('user_data');
        
        if (accessToken) {
            localStorage.setItem('prism_connected', 'true');
            localStorage.setItem('prism_access_token', accessToken);
            localStorage.setItem('prism_user_data', userData);
            
            activatePrismConnection();
            
            // Clean URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }
}

        // Past Chats Tools
        const MEMORY_TRIGGER_KEYWORDS = [
            'yesterday', 'earlier', 'before', 'previous', 'last time',
            'we talked about', 'you mentioned', 'remember when',
        ];

        function shouldSearchPastChats(message) {
            const lowerMessage = message.toLowerCase();
            return MEMORY_TRIGGER_KEYWORDS.some(keyword => lowerMessage.includes(keyword));
        }

        function searchConversationHistory(query, timeRange = null) {
            const results = [];
            
            chatHistory.forEach(chat => {
                if (timeRange) {
                    const chatDate = new Date(chat.timestamp);
                    const now = new Date();
                    const daysDiff = (now - chatDate) / (1000 * 60 * 60 * 24);
                    
                    if (timeRange === 'today' && daysDiff > 1) return;
                    if (timeRange === 'week' && daysDiff > 7) return;
                    if (timeRange === 'month' && daysDiff > 30) return;
                }
                
                chat.messages.forEach(msg => {
                    if (msg.content.toLowerCase().includes(query.toLowerCase())) {
                        results.push({
                            chatId: chat.id,
                            chatTitle: chat.title,
                            timestamp: chat.timestamp,
                            content: msg.content.substring(0, 200),
                            role: msg.role
                        });
                    }
                });
            });
            
            return results.slice(0, 5); // Return top 5 results
        }

        function getRecentChats(days = 7) {
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - days);
            
            return chatHistory
                .filter(chat => new Date(chat.timestamp) > cutoffDate)
                .slice(0, 10)
                .map(chat => ({
                    id: chat.id,
                    title: chat.title,
                    timestamp: chat.timestamp,
                    messageCount: chat.messages.length
                }));
        }

        // Artifact System
        let currentArtifactData = null;

        function setupArtifactSystem() {
            document.getElementById('closeArtifact').addEventListener('click', closeArtifactPanel);
            document.getElementById('downloadArtifact').addEventListener('click', downloadArtifact);
            document.getElementById('copyArtifactCode').addEventListener('click', copyArtifactCode);
            
            document.querySelectorAll('.artifact-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchArtifactTab(this.dataset.tab);
                });
            });
            
            document.getElementById('artifactEditor').addEventListener('input', function() {
                if (currentArtifactData) {
                    currentArtifactData.content = this.value;
                    updateArtifactPreview();
                }
            });
        }

        function openArtifactPanel(artifactData) {
            currentArtifactData = artifactData;
            
            document.getElementById('artifactTitle').textContent = artifactData.title || 'Untitled Artifact';
            document.getElementById('artifactType').textContent = artifactData.type || 'code';
            document.getElementById('artifactEditor').value = artifactData.content || '';
            
            document.getElementById('artifactPanel').classList.add('open');
            
            switchArtifactTab('preview');
            updateArtifactPreview();
        }

        function closeArtifactPanel() {
            document.getElementById('artifactPanel').classList.remove('open');
            currentArtifactData = null;
        }

        function switchArtifactTab(tab) {
            document.querySelectorAll('.artifact-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            if (tab === 'preview') {
                document.getElementById('artifactPreviewPane').classList.remove('hidden');
                document.getElementById('artifactCodePane').classList.add('hidden');
            } else {
                document.getElementById('artifactPreviewPane').classList.add('hidden');
                document.getElementById('artifactCodePane').classList.remove('hidden');
            }
        }

        function updateArtifactPreview() {
            if (!currentArtifactData) return;
            
            var preview = document.getElementById('artifactPreview');
            var content = currentArtifactData.content;
            var type = currentArtifactData.type;
            var html = '';
            
            if (type === 'text/html' || type === 'html') {
                preview.srcdoc = content;
                return;
            }
            
            if (type === 'image/svg+xml' || type === 'svg') {
                html = [
                    '<!DOCTYPE html>',
                    '<html>',
                    '<body style="margin:0;padding:20px;">',
                    content,
                    '</body>',
                    '</html>'
                ].join('');
            } else if (type === 'application/vnd.ant.mermaid' || type === 'mermaid') {
                html = [
                    '<!DOCTYPE html>',
                    '<html>',
                    '<head>',
                    '<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"><\/script>',
                    '</head>',
                    '<body>',
                    '<div class="mermaid">',
                    content,
                    '</div>',
                    '<script>mermaid.initialize({ startOnLoad: true });<\/script>',
                    '</body>',
                    '</html>'
                ].join('');
            } else {
                html = [
                    '<!DOCTYPE html>',
                    '<html>',
                    '<body>',
                    '<pre style="padding:20px;font-family:monospace;">',
                    escapeHtml(content),
                    '</pre>',
                    '</body>',
                    '</html>'
                ].join('');
            }
            
            preview.srcdoc = html;
        }

        // è¾…åŠ©å‡½æ•°ï¼šè½¬ä¹‰HTML
        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function downloadArtifact() {
            if (!currentArtifactData) return;
            
            const blob = new Blob([currentArtifactData.content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentArtifactData.identifier || 'artifact'}.${getFileExtension(currentArtifactData.type)}`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyArtifactCode() {
            if (!currentArtifactData) return;
            
            navigator.clipboard.writeText(currentArtifactData.content).then(() => {
                const btn = document.getElementById('copyArtifactCode');
                btn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    btn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
        }

        function getFileExtension(type) {
            const extensions = {
                'text/html': 'html',
                'html': 'html',
                'application/vnd.ant.code': 'txt',
                'text/markdown': 'md',
                'image/svg+xml': 'svg',
                'svg': 'svg',
                'application/vnd.ant.mermaid': 'mmd',
                'mermaid': 'mmd',
                'application/vnd.ant.react': 'jsx'
            };
            return extensions[type] || 'txt';
        }

        // Call this in DOMContentLoaded
        setupArtifactSystem();

        function sendPresetMessage(message) {
            document.getElementById('userInput').value = message;
            sendMessage('userInput');
        }


        function showSuccessModal(title, message) {
            document.getElementById('successTitle').textContent = title;
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.remove('hidden');
            document.getElementById('successModal').classList.add('flex');
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
        }

        function openFeedbackModal() {
            document.getElementById('feedbackModal').classList.remove('hidden');
            document.getElementById('feedbackModal').classList.add('flex');
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').classList.add('hidden');
            document.getElementById('feedbackModal').classList.remove('flex');
            
            // Reset form
            document.querySelectorAll('input[name="feedbackType"]').forEach(radio => radio.checked = false);
            document.getElementById('feedbackText').value = '';
        }

        function submitFeedback() {
            const selectedType = document.querySelector('input[name="feedbackType"]:checked');
            const additionalText = document.getElementById('feedbackText').value.trim();
            
            if (!selectedType) {
                alert('Please select a feedback type.');
                return;
            }
            
            // Simulate submission
            console.log('Feedback submitted:', {
                type: selectedType.value,
                text: additionalText,
                timestamp: new Date().toISOString()
            });
            
            closeFeedbackModal();
            showSuccessModal('Feedback Submitted', 'Thank you for your feedback! We\'ve received your input and will use it to improve TyloAI.');
        }

        function updateTimeGreeting() {
            let hours;
            
            if (userData.timezone) {
                // ä½¿ç”¨ç”¨æˆ·æ—¶åŒº
                const now = new Date();
                const options = { timeZone: userData.timezone, hour: 'numeric', hour12: false };
                hours = parseInt(new Intl.DateTimeFormat('en-US', options).format(now));
            } else {
                hours = new Date().getHours();
            }
            
            let greeting;
            
            if (hours >= 5 && hours < 12) {
                greeting = translate('good_morning');
            } else if (hours >= 12 && hours < 17) {
                greeting = translate('good_afternoon');
            } else if (hours >= 17 && hours < 22) {
                greeting = translate('good_evening');
            } else if (hours >= 22 || hours < 2) {
                greeting = translate('working_late');
            } else {
                greeting = translate('burning_midnight');
            }
            
            if (userData.nickname && userData.nickname !== 'User') {
                greeting = greeting.replace('!', `, ${userData.nickname}!`);
            }
            
            document.getElementById('timeGreeting').textContent = greeting;
        }

        function setupDropdowns() {
        // Ã¥Å“Â¨setupDropdownsÃ¥â€¡Â½Ã¦â€¢Â°Ã¥â€ â€¦Ã¦Â·Â»Ã¥Å  
            document.querySelectorAll('#styleSelector .aria-submenu .dropdown-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const style = this.dataset.style;
                    currentStyle = style;
                    document.getElementById('currentStyle').textContent = this.textContent.trim();
                    document.getElementById('advancedOptionsMenu').classList.remove('open');
                    saveAllData();
                });
            });
            try {
                // document.getElementById('styleToggle').addEventListener('click', function(e) {
                    // e.stopPropagation();
                    // document.getElementById('styleOptions').classList.toggle('open');
                // });
                // Comment out or remove this entire block since styleToggle doesn't exist in the HTML
                // The style selector is now part of the advanced options menu
                
                document.querySelectorAll('#styleOptions .dropdown-option').forEach(option => {
                    option.addEventListener('click', function() {
                        document.querySelectorAll('#styleOptions .dropdown-option').forEach(opt => 
                            opt.classList.remove('selected'));
                        this.classList.add('selected');
                        currentStyle = this.dataset.value;
                        document.getElementById('styleOptions').classList.remove('open');
                        
                        // Ã¦â€ºÂ´Ã¦â€“Â°Ã¥Â½â€œÃ¥â€°ÂÃ¨Â¯Â­Ã¦Â°â€Ã¦ËœÂ¾Ã§Â¤Âº
                        const styleDisplay = document.getElementById('currentStyleDisplay');
                        if (currentStyle === 'normal') {
                            styleDisplay.classList.add('hidden');
                        } else {
                            styleDisplay.textContent = this.textContent.trim();
                            styleDisplay.classList.remove('hidden');
                        }
                        
                        updateMediaOptionsVisibility();
                        saveAllData();
                    });
                });
                
                document.querySelector('#modelSelector .dropdown-selected').addEventListener('click', function(e) {
                    e.stopPropagation();
                    const modelOptions = document.getElementById('modelOptions');
                    const advancedMenu = document.getElementById('advancedOptionsMenu');
                    
                    // Close advanced options if open
                    if (advancedMenu) {
                        advancedMenu.classList.remove('open');
                    }
                    
                    // Toggle model options
                    if (modelOptions.classList.contains('open')) {
                        modelOptions.classList.remove('open');
                    } else {
                        modelOptions.classList.add('open');
                        modelOptions.style.zIndex = '999';
                    }
                });
                
                document.querySelectorAll('#modelOptions .dropdown-option').forEach(option => {
                    if (option.classList.contains('aria-parent')) return;
                    
                    option.addEventListener('click', function() {
                        if (this.dataset.value) {
                            document.querySelectorAll('#modelOptions .dropdown-option').forEach(opt => 
                                opt.classList.remove('selected'));
                            this.classList.add('selected');

                            // Update deep thinking option text when model changes
                            if (isDeepThinking) {
                                const deepThinkOption = document.getElementById('deepThinkingOption');
                                if (deepThinkOption) {
                                    deepThinkOption.innerHTML = '<i class="fas fa-brain mr-2 text-blue-500"></i>Deep Thinking' + 
                                        (currentModel === 'ode-6' ? ' + Secondary Analysis' : '') + ' (Active)';
                                }
                            }
                            
                            currentModel = this.dataset.value;
                            
                            const fullText = this.textContent.trim();
                            const modelName = fullText.split(' ')[0];
                            
                            document.getElementById('modelDisplayName').textContent = modelName;
                            document.getElementById('replyModelName').textContent = modelName;
                            
                            // Reset research mode if switching away from research
                            if (currentModel !== 'tylo-research') {
                                isResearchMode = false;
                                document.getElementById('researchToggle').classList.remove('active');
                            }
                            
                            updateMediaOptionsVisibility();
                            
                            if (!userData.modelsUsed.includes(currentModel)) {
                                userData.modelsUsed.push(currentModel);
                                if (userData.modelsUsed.length >= 6) {
                                    unlockAchievement('model_explorer');
                                }
                            }
                            
                            document.getElementById('modelOptions').classList.remove('open');
                            saveAllData();
                        }
                    });
                });
                
                document.addEventListener('click', function(e) {
                    // Close advanced options menu
                    if (!e.target.closest('#advancedOptionsBtn') && !e.target.closest('#advancedOptionsMenu')) {
                        const advancedMenu = document.getElementById('advancedOptionsMenu');
                        if (advancedMenu) {
                            advancedMenu.classList.remove('open');
                        }
                    }
                    
                    // Close model options
                    if (!e.target.closest('#modelSelector')) {
                        const modelOptions = document.getElementById('modelOptions');
                        if (modelOptions) {
                            modelOptions.classList.remove('open');
                        }
                    }
                    
                    // Close language options
                    if (!e.target.closest('#languageDropdown')) {
                        const langOptions = document.getElementById('languageOptions');
                        if (langOptions) {
                            langOptions.classList.add('hidden');
                        }
                    }
                });
            } catch (error) {
                console.error('Error setting up dropdowns:', error);
            }
        }

        function updateMediaOptionsVisibility() {
            const mediaOptions = document.getElementById('mediaOptions');
            const imageOptions = document.getElementById('imageOptions');
            const musicOptions = document.getElementById('musicOptions');
            
            mediaOptions.classList.add('hidden');
            imageOptions.classList.add('hidden');
            musicOptions.classList.add('hidden');
            
            if (currentModel === 'tylo-aria-image') {
                mediaOptions.classList.remove('hidden');
                imageOptions.classList.remove('hidden');
                if (currentStyle !== 'artistic') {
                    document.querySelectorAll('#styleOptions .dropdown-option').forEach(opt => 
                        opt.classList.remove('selected'));
                    document.querySelector('#styleOptions .dropdown-option[data-value="artistic"]').classList.add('selected');
                    currentStyle = 'artistic';
                }
            } else if (currentModel === 'tylo-aria-music') {
                mediaOptions.classList.remove('hidden');
                musicOptions.classList.remove('hidden');
                if (currentStyle !== 'artistic') {
                    document.querySelectorAll('#styleOptions .dropdown-option').forEach(opt => 
                        opt.classList.remove('selected'));
                    document.querySelector('#styleOptions .dropdown-option[data-value="artistic"]').classList.add('selected');
                    currentStyle = 'artistic';
                }
            }
        }

        function setupAutoSuggestions() {
            ['userInput', 'replyInput'].forEach(id => {
                const input = document.getElementById(id);
                let suggestionTimer = null;
                
                input.addEventListener('input', function() {
                    clearTimeout(suggestionTimer);
                    hideSuggestions();
                    
                    if (this.value.trim() === '') {
                        suggestionTimer = setTimeout(() => {
                            showRandomSuggestion();
                        }, 5000);
                    }
                });
                
                input.addEventListener('focus', function() {
                    if (this.value.trim() === '') {
                        suggestionTimer = setTimeout(() => {
                            showRandomSuggestion();
                        }, 5000);
                    }
                });
                
                input.addEventListener('blur', function() {
                    clearTimeout(suggestionTimer);
                    setTimeout(hideSuggestions, 500);
                });
            });
        }

        function handleWritingAutoComplete(input) {
            const value = input.value.toLowerCase();
            const suggestions = document.getElementById('aiSuggestions');
            const suggestionText = document.getElementById('suggestionText');
            
            // Multi-language trigger words
            const triggers = {
                'en': ['help me', 'write', 'create'],
                'zh-cn': ['帮我', '写', '创建'],
                'ja': ['書いて', '作成', '手伝って'],
                'ko': ['도와', '쓰기', '작성']
            };
            
            const currentTriggers = triggers[currentLanguage] || triggers['en'];
            const shouldShow = currentTriggers.some(trigger => value.includes(trigger));
            
            if (shouldShow) {
                const writingSuggestions = {
                    'en': [
                        'Help me write a diary entry',
                        'Help me write a lab report',
                        'Help me write a TikTok video script',
                        'Help me write a professional email',
                        'Help me write a resume',
                        'Help me write a marketing post'
                    ],
                    'zh-cn': [
                        '帮我写一篇日记',
                        '帮我写一份实验报告',
                        '帮我写一篇短视频脚本适用于抖音',
                        '帮我写一封专业邮件',
                        '帮我写一份简历',
                        '帮我写一条营销文案'
                    ],
                    'ja': [
                        '日記を書いて',
                        '実験レポートを書いて',
                        'TikTok動画スクリプトを書いて',
                        'プロフェッショナルなメールを書いて',
                        '履歴書を書いて',
                        'マーケティング投稿を書いて'
                    ],
                    'ko': [
                        '일기를 써줘',
                        '실험 보고서를 써줘',
                        '틱톡 동영상 스크립트를 써줘',
                        '전문 이메일을 써줘',
                        '이력서를 써줘',
                        '마케팅 게시물을 써줘'
                    ]
                };
                
                const currentSuggestions = writingSuggestions[currentLanguage] || writingSuggestions['en'];
                
                // Show as clickable options
                const greeting = document.getElementById('timeGreeting');
                if (greeting) {
                    greeting.innerHTML = `
                        <div class="space-y-2 text-left w-full">
                            ${currentSuggestions.map(sugg => `
                                <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded cursor-pointer text-sm" onclick="fillSuggestion('${sugg.replace(/'/g, "\\'")}')">
                                    ${sugg}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } else {
                // Restore greeting
                updateTimeGreeting();
            }
        }

        function fillSuggestion(text) {
            const input = document.getElementById('userInput');
            input.value = text;
            input.focus();
            updateTimeGreeting();
        }

        function showRandomSuggestion() {
            const suggestions = document.getElementById('aiSuggestions');
            const suggestionText = document.getElementById('suggestionText');
            
            if (suggestions && suggestionText) {
                const langSuggestions = AI_SUGGESTIONS_POOL[currentLanguage] || AI_SUGGESTIONS_POOL['en'];
                const randomSuggestion = langSuggestions[Math.floor(Math.random() * langSuggestions.length)];
                suggestionText.textContent = translate('try_asking', randomSuggestion);
                suggestions.classList.remove('hidden');
            }
        }

        function hideSuggestions() {
            document.getElementById('aiSuggestions').classList.add('hidden');
        }

        function updateUIFromUserData() {
            // Show/hide Pro-only features
            document.querySelectorAll('.pro-only').forEach(el => {
                if (userData.isPro || userData.isMax) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            });

            // Update monthly restore button text
            const restoreBtn = document.getElementById('monthlyRestoreBtn');
            if (restoreBtn && userData.isPro) {
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;
                const isUsed = userData.lastRestoreReset === currentMonth && userData.monthlyRestoreUsed;
                
                if (isUsed) {
                    restoreBtn.textContent = '✔ Monthly Restore Used';
                    restoreBtn.disabled = true;
                    restoreBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    restoreBtn.textContent = 'Monthly Restore';
                    restoreBtn.disabled = false;
                    restoreBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
            try {
                document.getElementById('userNickname').textContent = userData.nickname || 'User';
                // æ›´æ–°åŽæ€è€ƒå‰©ä½™æ¬¡æ•°æ˜¾ç¤º
                if (!userData.isPro && !userData.isStudent) {
                    const remaining = 5 - (userData.postThinkingUsageThisMonth || 0);
                    const countElement = document.getElementById('postThinkingCount');
                    if (countElement) {
                        countElement.textContent = remaining;
                    }
                }
                document.getElementById('userAvatar').src = userData.avatar || 'https://via.placeholder.com/40';
                document.getElementById('levelBadge').textContent = userData.level || 1;
                document.getElementById('pointsDisplay').textContent = (userData.points || 0).toLocaleString();
                
                const headerPoints = document.getElementById('headerPointsDisplay');
                if (headerPoints) {
                    headerPoints.textContent = (userData.points || 0).toLocaleString();
                }
                
                const membershipStatus = document.getElementById('membershipStatus');
                const planStatus = document.getElementById('planStatus');
                const pointsContainer = document.getElementById('pointsContainer');
                const headerPointsDisplay = document.getElementById('headerPointsDisplay');
                const pointsDisplay = document.getElementById('pointsDisplay');

                if (userData.isMax) {
                    membershipStatus.textContent = 'Max';
                    membershipStatus.className = 'ml-2 px-2 py-0.5 bg-gradient-to-r from-purple-600 to-pink-600 text-xs rounded-full text-white';
                    if (planStatus) planStatus.style.display = 'none';
                    // Hide ALL point-related elements
                    if (pointsContainer) pointsContainer.style.display = 'none';
                    if (headerPointsDisplay) headerPointsDisplay.parentElement.style.display = 'none';
                    document.querySelectorAll('.model-cost, .option-cost, .option-limit').forEach(el => el.style.display = 'none');
                    updateModelOptionsForMax();
                } else if (userData.isPro) {
                    membershipStatus.textContent = 'Pro';
                    membershipStatus.className = 'ml-2 px-2 py-0.5 bg-gradient-to-r from-blue-500 to-cyan-500 text-xs rounded-full text-white';
                    if (planStatus) planStatus.style.display = 'none';
                    // Show points but update model options
                    updateModelOptionsForPro();
                } else {
                    membershipStatus.textContent = 'Free';
                    membershipStatus.className = 'ml-2 px-2 py-0.5 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs rounded-full';
                    if (planStatus) planStatus.style.display = 'block';
                }
                
                const maxXP = (userData.level || 1) * 100;
                const xpPercent = ((userData.xp || 0) / maxXP) * 100;
                document.getElementById('xpProgress').style.width = xpPercent + '%';
                document.getElementById('xpText').textContent = `${userData.xp || 0}/${maxXP} ${translate('xp')}`;
                
                document.getElementById('settingsLevel').textContent = userData.level || 1;
                document.getElementById('settingsXP').textContent = userData.xp || 0;
                document.getElementById('settingsMaxXP').textContent = maxXP;
                document.getElementById('settingsXPBar').style.width = xpPercent + '%';
                
                // ä¸ºMaxç”¨æˆ·éšè—ä½¿ç”¨ç»Ÿè®¡
                if (userData.isMax) {
                    document.getElementById('odeUsage').textContent = 'Unlimited';
                    document.getElementById('agentUsage').textContent = 'Unlimited';
                    document.getElementById('imageUsage').textContent = 'Unlimited';
                    document.getElementById('videoUsage').textContent = 'Unlimited';
                } else {
                    document.getElementById('odeUsage').textContent = `Used this month: ${userData.odeUsageThisMonth || 0}`;
                    document.getElementById('agentUsage').textContent = `${userData.agentProjectsThisMonth || 0}/5`;
                    document.getElementById('imageUsage').textContent = `${userData.imagesGeneratedToday || 0}/2`;
                    document.getElementById('videoUsage').textContent = `${userData.videosGenerated || 0}/1`;
                }
                document.getElementById('imageUsage').textContent = `${userData.imagesGeneratedToday || 0}/2`;
                document.getElementById('videoUsage').textContent = `${userData.videosGenerated || 0}/1`;
                document.getElementById('totalChats').textContent = chatHistory.length;

                // Update font and background selectors
                if (document.getElementById('fontSelector')) {
                    document.getElementById('fontSelector').value = currentFont;
                }
                if (document.getElementById('backgroundSelector')) {
                    document.getElementById('backgroundSelector').value = currentBackground;
                }
                if (document.getElementById('customBgUrl')) {
                    document.getElementById('customBgUrl').value = userData.customBgUrl || '';
                    if (currentBackground === 'custom') {
                        document.getElementById('customBgUrl').classList.remove('hidden');
                    }
                }
                
            } catch (error) {
                console.error('Error updating UI from user data:', error);
            }
            // Ã¤Â¸ÂºProÃ§â€Â¨Ã¦Ë†Â·Ã¦â€ºÂ´Ã¦â€“Â°Ã¦Â¨Â¡Ã¥Å¾â€¹Ã©â‚¬â€°Ã©Â¡Â¹Ã¦ËœÂ¾Ã§Â¤Âº
            if (userData.isPro || userData.isStudent) {
                updateModelOptionsForPro();
                // Ã©Å¡ÂÃ¨â€”ÂÃ¦â€°â‚¬Ã¦Å“â€°Ã§Â§Â¯Ã¥Ë†â€ Ã§â€ºÂ¸Ã¥â€¦Â³Ã¥â€¦Æ’Ã§Â´ 
                const pointsElements = document.querySelectorAll('[data-cost]');
                pointsElements.forEach(el => {
                    const costSpan = el.querySelector('.text-xs');
                    if (costSpan && costSpan.textContent.includes('pts')) {
                        costSpan.textContent = 'Unlimited';
                        costSpan.className = 'text-xs text-green-500';
                    }
                });
            }
            updateModelOptionsForPro();
            // Hide points elements for Pro/Student
            if (userData.isPro || userData.isStudent) {
                hidePointsForProUsers();
            }
        }

        // Hide points display for Pro/Student users
        function hidePointsForProUsers() {
            if (userData.isPro || userData.isStudent) {
                // Hide all point cost displays
                document.querySelectorAll('.text-xs').forEach(el => {
                    if (el.textContent.includes('pts') || el.textContent.includes('points')) {
                        el.style.display = 'none';
                    }
                });
                
                // Hide point deduction messages
                document.querySelectorAll('#normalThinkingOption, #webSearchOption').forEach(el => {
                    const text = el.textContent;
                    if (text.includes('+100 pts')) {
                        el.innerHTML = el.innerHTML.replace(/\(\+100 pts\)/g, '');
                    }
                });
            }
        }

        function updateModelOptionsForPro() {
            document.querySelectorAll('#modelOptions .dropdown-option').forEach(option => {
                const costSpan = option.querySelector('.text-xs');
                if (costSpan) {
                    const dataCost = option.dataset.cost;
                    
                    if (userData.isPro || userData.isStudent) {
                        // Pro/StudentÃ§â€Â¨Ã¦Ë†Â·Ã¦ËœÂ¾Ã§Â¤ÂºUnlimited
                        if (dataCost && parseInt(dataCost) > 0) {
                            costSpan.textContent = translate('unlimited');
                            costSpan.className = 'text-xs text-green-500';
                        }
                    } else {
                        // Ã¥â€¦ÂÃ¨Â´Â¹Ã§â€Â¨Ã¦Ë†Â·Ã¦ËœÂ¾Ã§Â¤ÂºÃ§Â§Â¯Ã¥Ë†â€ Ã¦Â¶Ë†Ã¨â‚¬â€”
                        if (dataCost && parseInt(dataCost) > 0) {
                            costSpan.textContent = `(${dataCost}pts)`;
                            costSpan.className = 'text-xs text-blue-500';
                        } else if (option.dataset.value === 'ode-5-flash') {
                            costSpan.textContent = translate('free_unlimited');
                            costSpan.className = 'text-xs text-green-500';
                        } else if (option.dataset.value === 'ode-5') {
                            costSpan.textContent = translate('smart_monthly');
                            costSpan.className = 'text-xs text-green-500';
                        }
                    }
                }
            });
        }

        function updateModelOptionsForMax() {
            // Hide all cost indicators
            document.querySelectorAll('.model-cost').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.option-cost').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.option-limit').forEach(el => el.style.display = 'none');
            
            // Update dropdown options
            document.querySelectorAll('#modelOptions .dropdown-option').forEach(option => {
                const costSpan = option.querySelector('.model-cost');
                if (costSpan) {
                    costSpan.style.display = 'none';
                }
            });
        }

        function addXP(amount) {
            userData.xp = (userData.xp || 0) + amount;
            const maxXP = (userData.level || 1) * 100;
            
            if (userData.xp >= maxXP) {
                userData.level = (userData.level || 1) + 1;
                userData.xp -= maxXP;
                showAchievement(`Level Up! You're now level ${userData.level}!`);
                
                if (userData.level === 5) {
                    unlockAchievement('level_up_5');
                }
            }
            
            saveAllData();
        }

        function unlockAchievement(achievementId) {
            if (!(userData.achievements || []).includes(achievementId) && ACHIEVEMENTS[achievementId]) {
                userData.achievements = userData.achievements || [];
                userData.achievements.push(achievementId);
                const achievement = ACHIEVEMENTS[achievementId];
                addXP(achievement.xp);
                showAchievement(`Achievement: ${achievement.name} - ${achievement.description}`);
                saveAllData();
            }
        }

        function showAchievement(text) {
            const popup = document.getElementById('achievementPopup');
            document.getElementById('achievementText').textContent = text;
            popup.classList.remove('hidden');
            
            setTimeout(() => {
                popup.classList.add('hidden');
            }, 4000);
        }

        function updateAchievementsList() {
            const list = document.getElementById('achievementsList');
            list.innerHTML = '';
            
            Object.entries(ACHIEVEMENTS).forEach(([id, achievement]) => {
                const unlocked = (userData.achievements || []).includes(id);
                const item = document.createElement('div');
                item.className = `flex items-center p-2 rounded ${unlocked ? 'bg-green-50 dark:bg-green-900' : 'bg-gray-50 dark:bg-gray-700'} ${unlocked ? 'text-green-800 dark:text-green-200' : 'text-gray-500'}`;
                item.innerHTML = `
                    <i class="fas ${achievement.icon} mr-3"></i>
                    <div class="flex-1">
                        <div class="font-medium">${achievement.name}</div>
                        <div class="text-xs">${achievement.description}</div>
                    </div>
                    ${unlocked ? '<i class="fas fa-check text-green-500"></i>' : `<span class="text-xs">${achievement.xp} XP</span>`}
                `;
                list.appendChild(item);
            });
        }

        // æœ¬åœ°å…³é”®è¯é¢„ç­›é€‰
        const LOCAL_MEMORY_KEYWORDS = {
            'name': ['my name is', 'call me', 'i am', 'i\'m', 'æˆ‘å«', 'æˆ‘æ˜¯', 'å«æˆ‘'],
            'age': ['i am', 'years old', 'age', 'å²', 'å¹´é¾„'],
            'location': ['live in', 'from', 'located in', 'ä½åœ¨', 'æ¥è‡ª'],
            'job': ['work as', 'my job', 'profession', 'å·¥ä½œ', 'èŒä¸š'],
            'hobby': ['like', 'love', 'enjoy', 'hobby', 'å–œæ¬¢', 'çˆ±å¥½'],
            'preference': ['prefer', 'favorite', 'hate', 'dislike', 'å–œæ¬¢', 'è®¨åŽŒ', 'åå¥½']
        };

        function quickMemoryMatch(message) {
            const lowerMsg = message.toLowerCase();
            
            for (const [category, keywords] of Object.entries(LOCAL_MEMORY_KEYWORDS)) {
                for (const keyword of keywords) {
                    if (lowerMsg.includes(keyword)) {
                        // æå–å…³é”®ä¿¡æ¯
                        let summary = '';
                        if (category === 'name') {
                            const nameMatch = message.match(/(?:my name is|call me|i am|i'm|æˆ‘å«|æˆ‘æ˜¯)\s+(\w+)/i);
                            if (nameMatch) summary = `User's name is ${nameMatch[1]}`;
                        }
                        else if (category === 'age') {
                            const ageMatch = message.match(/(\d+)\s*(?:years old|å²)/i);
                            if (ageMatch) summary = `User is ${ageMatch[1]} years old`;
                        }
                        else if (category === 'location') {
                            const locMatch = message.match(/(?:live in|from|located in|ä½åœ¨|æ¥è‡ª)\s+([^,.!?]+)/i);
                            if (locMatch) summary = `User lives in ${locMatch[1].trim()}`;
                        }
                        
                        if (summary) {
                            return {
                                needsSave: true,
                                category: category,
                                summary: summary
                            };
                        }
                    }
                }
            }
            return null;
        }

        async function analyzeMessageForMemory(message, isUser = true) {
            try {
                // 先尝试本地快速匹配
                const quickMatch = quickMemoryMatch(message);
                
                if (quickMatch) {
                    console.log('✓ 本地快速匹配到记忆关键词');
                    const memory = {
                        category: quickMatch.category,
                        summary: quickMatch.summary,
                        message: message.substring(0, 200),
                        timestamp: new Date().toISOString(),
                        isUser: isUser
                    };
                    
                    // 检查是否已存在相似记忆
                    const existingIndex = aiMemory.findIndex(m => 
                        m.category === memory.category && 
                        m.summary.toLowerCase().includes(memory.summary.toLowerCase().substring(0, 20))
                    );
                    
                    if (existingIndex !== -1) {
                        aiMemory[existingIndex] = memory;
                    } else {
                        aiMemory.push(memory);
                    }
                    
                    if (aiMemory.length > 20) {
                        aiMemory = aiMemory.slice(-20);
                    }
                    
                    saveAllData();
                    updateMemoryList();
                    showMemorySavedNotification(memory.summary);
                    return; // 直接返回，不继续API调用
                }
                
                // 如果本地没匹配到，使用API但不输出思考过程
                const response = await fetch(`${API_CONFIG.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gemini-1.5-flash-002', // 使用更快的模型
                        messages: [{
                            role: 'user',
                            content: `Analyze if this message contains memorable personal info. Be concise.
        Message: "${message}"

        Return ONLY a JSON object (no explanation):
        {"needsSave": true/false, "category": "name/preference/fact/other", "summary": "brief description"}`
                        }],
                        temperature: 0.3,
                        max_tokens: 80 // 减少token限制
                    })
                });

                const data = await response.json();
                const content = data.choices[0].message.content.trim();
                
                let analysis;
                try {
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    analysis = JSON.parse(jsonMatch ? jsonMatch[0] : content);
                } catch (e) {
                    console.error('Failed to parse memory analysis:', e);
                    return;
                }

                if (analysis.needsSave) {
                    const memory = {
                        category: analysis.category || 'other',
                        summary: analysis.summary || message.substring(0, 100),
                        message: message.substring(0, 200),
                        timestamp: new Date().toISOString(),
                        isUser: isUser
                    };

                    const existingIndex = aiMemory.findIndex(m => 
                        m.category === memory.category && 
                        m.summary.toLowerCase().includes(memory.summary.toLowerCase().substring(0, 20))
                    );

                    if (existingIndex !== -1) {
                        aiMemory[existingIndex] = memory;
                    } else {
                        aiMemory.push(memory);
                    }

                    if (aiMemory.length > 20) {
                        aiMemory = aiMemory.slice(-20);
                    }

                    saveAllData();
                    updateMemoryList();
                    showMemorySavedNotification(memory.summary);
                }

            } catch (error) {
                console.error('Error analyzing message for memory:', error);
            }
        }

        // æ˜¾ç¤ºè®°å¿†ä¿å­˜é€šçŸ¥
        function showMemorySavedNotification(summary) {
            const notification = document.createElement('div');
            notification.id = 'memorySavedNotification';
            notification.className = 'fixed top-20 right-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg z-50 cursor-pointer transform transition-all duration-300 hover:scale-105';
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <div class="font-medium">${translate('memory_saved')}</div>
                        <div class="text-xs opacity-90">${summary.substring(0, 50)}...</div>
                    </div>
                </div>
            `;
            
            // ç‚¹å‡»æ‰“å¼€è®¾ç½®æŸ¥çœ‹è®°å¿†
            notification.onclick = () => {
                openSettingsModal();
                // æ»šåŠ¨åˆ°è®°å¿†éƒ¨åˆ†
                setTimeout(() => {
                    const memorySection = document.querySelector('#memoryList').parentElement;
                    if (memorySection) {
                        memorySection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        memorySection.style.animation = 'pulse 1s ease-in-out 2';
                    }
                }, 300);
            };
            
            document.body.appendChild(notification);
            
            // 3ç§’åŽè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function updateMemoryList() {
            const list = document.getElementById('memoryList');
            
            // æ·»åŠ "å¦‚ä½•ä½¿ç”¨è®°å¿†"é“¾æŽ¥
            const headerHtml = `
                <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-200 dark:border-gray-600">
                    <span class="font-medium text-sm">${translate('ai_memory')}</span>
                    <a href="terms.html" target="_blank" class="text-xs text-blue-500 hover:text-blue-600 hover:underline flex items-center">
                        <i class="fas fa-info-circle mr-1"></i>
                        ${translate('how_we_use_memory')}
                    </a>
                </div>
            `;
            
            if (aiMemory.length === 0) {
                list.innerHTML = headerHtml + `<p class="text-gray-500 text-sm">${translate('no_memories')}</p>`;
                return;
            }
            
            let memoriesHtml = headerHtml;
            
            // æŒ‰ç±»åˆ«åˆ†ç»„æ˜¾ç¤º
            const categories = {
                'name': { icon: 'fa-user', color: 'blue' },
                'preference': { icon: 'fa-heart', color: 'pink' },
                'fact': { icon: 'fa-lightbulb', color: 'yellow' },
                'other': { icon: 'fa-bookmark', color: 'gray' }
            };
            
            aiMemory.slice(-10).reverse().forEach(memory => {
                const category = categories[memory.category] || categories['other'];
                memoriesHtml += `
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg mb-2 hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors">
                        <div class="flex items-start space-x-2">
                            <i class="fas ${category.icon} text-${category.color}-500 mt-1"></i>
                            <div class="flex-1">
                                <div class="font-medium text-sm">${memory.summary}</div>
                                <div class="text-xs text-gray-600 dark:text-gray-400 mt-1">${memory.message.substring(0, 100)}${memory.message.length > 100 ? '...' : ''}</div>
                                <div class="text-xs text-gray-500 mt-1">
                                    <i class="far fa-clock mr-1"></i>
                                    ${new Date(memory.timestamp).toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = memoriesHtml;
        }

        function clearAIMemory() {
            if (confirm('Are you sure you want to clear all AI memories? This cannot be undone.')) {
                aiMemory = [];
                updateMemoryList();
                saveAllData();
                showAchievement('All memories cleared successfully');
            }
        }
        function deductPoints(amount) {
            if (userData.isMax) return true;
            
            
            if ((userData.points || 0) >= amount) {
                userData.points = (userData.points || 0) - amount;
                saveAllData();  // 先保存
                updateUIFromUserData(); // 后更新UI
                return true;
            }
            
            alert('Insufficient points! Upgrade to Pro for more points or Max for unlimited access.');
            return false;
        }

        function checkOdeUsage() {
            // Maxç”¨æˆ·æ— é™åˆ¶
            if (userData.isMax) return true;
                
            // Proå’ŒFreeç”¨æˆ·éƒ½éœ€è¦æ¶ˆè€—ç§¯åˆ†ï¼Œä¸å†æœ‰æœˆåº¦é™åˆ¶
            return true;
        }

        function checkImageQuota(count) {
            if (userData.isPro || userData.isStudent) return true;
            
            if ((userData.imagesGeneratedToday || 0) === 0 && count <= 2) {
                return true;
            } else if ((userData.imagesGeneratedToday || 0) >= 1 && count === 1) {
                return true;
            } else {
                alert(translate('insufficient_quota'));
                return false;
            }
        }

        function checkVideoQuota() {
            if (userData.isPro || userData.isStudent) return true;
            
            if ((userData.videosGenerated || 0) >= 1) {
                alert(translate('video_limit_reached'));
                return false;
            }
            
            return true;
        }

        function checkDailyTasks() {
            const today = new Date().toDateString();
            const lastCheckin = userData.lastCheckin ? new Date(userData.lastCheckin).toDateString() : null;
            
            if (lastCheckin !== today) {
                if (lastCheckin && lastCheckin !== today) {
                    userData.points = 3000;
                }
                
                setTimeout(() => showDailyCheckin(), 2000);
            }
        }

        function showDailyCheckin() {
            const today = new Date().toDateString();
            const lastCheckin = userData.lastCheckin ? new Date(userData.lastCheckin).toDateString() : null;
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            let streak = 1;
            let bonus = 3000;
            
            if (lastCheckin === yesterday) {
                streak = (userData.dailyStreak || 0) + 1;
            } else if (lastCheckin !== today) {
                streak = 1;
            }
            
            // New streak bonus system: 300, 400, 500, 600, then reset
            const streakBonuses = [300, 400, 500, 600];
            const bonusIndex = (streak - 1) % 4;
            bonus = streakBonuses[bonusIndex];

            // Base daily points
            const baseDailyPoints = userData.isMax ? 0 : (userData.isPro ? 6000 : 3000);
            const totalBonus = baseDailyPoints + bonus; 
            
            document.getElementById('checkinBonus').textContent = bonus;
            document.getElementById('checkinStreak').textContent = streak;
            
            const modal = document.getElementById('checkinModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            // ã€å…³é”®ä¿®å¤ã€‘åœ¨æ¨¡æ€æ¡†æ˜¾ç¤ºåŽç»‘å®šæŒ‰é’®äº‹ä»¶
            setTimeout(() => {
                const btn = document.getElementById('claimCheckin');
                if (btn) {
                    btn.onclick = function() {
                        try {
                            const bonus = parseInt(document.getElementById('checkinBonus').textContent);
                            const streak = parseInt(document.getElementById('checkinStreak').textContent);
                            
                            userData.points = (userData.points || 0) + bonus;
                            userData.dailyStreak = streak;
                            userData.lastCheckin = new Date().toISOString();
                            
                            if (streak === 1) unlockAchievement('daily_checkin_1');
                            if (streak === 7) unlockAchievement('daily_checkin_7');
                            
                            saveAllData();
                            updateUIFromUserData();
                            
                            modal.classList.add('hidden');
                            modal.classList.remove('flex');
                            
                            showAchievement(`ç­¾åˆ°æˆåŠŸï¼èŽ·å¾— ${bonus} ç§¯åˆ†`);
                        } catch (error) {
                            console.error('ç­¾åˆ°å¤±è´¥:', error);
                            alert('ç­¾åˆ°å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    };
                }
            }, 100);
        }

        function claimDailyCheckin() {
            try {
                const bonus = parseInt(document.getElementById('checkinBonus').textContent);
                const streak = parseInt(document.getElementById('checkinStreak').textContent);
                
                userData.points = (userData.points || 0) + bonus;
                userData.dailyStreak = streak;
                userData.lastCheckin = new Date().toISOString();
                
                if (streak === 1) unlockAchievement('daily_checkin_1');
                if (streak === 7) unlockAchievement('daily_checkin_7');
                
                saveAllData();
                updateUIFromUserData();
                
                document.getElementById('checkinModal').classList.add('hidden');
                document.getElementById('checkinModal').classList.remove('flex');
                
                showAchievement(`Daily check-in complete! +${bonus} points`);
            } catch (error) {
                console.error('Error claiming daily check-in:', error);
                alert('Failed to claim daily check-in. Please try again.');
            }
        }

        function updateDailyTasks() {
            const list = document.getElementById('dailyTasksList');
            const today = new Date().toDateString();
            const checkedInToday = userData.lastCheckin && new Date(userData.lastCheckin).toDateString() === today;
            
            list.innerHTML = `
                <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded">
                    <div class="flex items-center">
                        <i class="fas fa-calendar-check mr-2 ${checkedInToday ? 'text-green-500' : 'text-gray-400'}"></i>
                        <span>${translate('daily_checkin_task') || 'Daily Check-in'}</span>
                    </div>
                    <span class="text-sm ${checkedInToday ? 'text-green-500' : 'text-gray-500'}">
                        ${checkedInToday ? translate('complete') : '+3000-5000 pts'}
                    </span>
                </div>
                <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700 rounded">
                    <div class="flex items-center">
                        <i class="fas fa-comments mr-2 ${(userData.chatCount || 0) >= 5 ? 'text-green-500' : 'text-gray-400'}"></i>
                        <span>${translate('send_messages_task') || 'Send 5 messages'}</span>
                    </div>
                    <span class="text-sm ${(userData.chatCount || 0) >= 5 ? 'text-green-500' : 'text-gray-500'}">
                        ${userData.chatCount || 0}/5
                    </span>
                </div>
            `;
        }

        let tutorialStep = 0;

        function showTutorial() {
            document.getElementById('tutorialOverlay').classList.remove('hidden');
            document.getElementById('tutorialOverlay').classList.add('flex');
            tutorialStep = 0;
            
            // Enable/disable next button based on form validation
            const usernameInput = document.getElementById('tutorialUsername');
            const regionSelect = document.getElementById('tutorialRegion');
            const privacyCheck = document.getElementById('tutorialPrivacy');
            const ageCheck = document.getElementById('tutorialAge');
            const nextBtn = document.getElementById('tutorialNextBtn1');
            
            function validateForm() {
                const isValid = usernameInput.value.trim() !== '' && 
                            regionSelect.value !== '' && 
                            privacyCheck.checked && 
                            ageCheck.checked;
                nextBtn.disabled = !isValid;
                document.getElementById('tutorialError').classList.toggle('hidden', isValid);
            }
            
            usernameInput.addEventListener('input', validateForm);
            regionSelect.addEventListener('change', validateForm);
            privacyCheck.addEventListener('change', validateForm);
            ageCheck.addEventListener('change', validateForm);
        }

        function validateAndNextStep() {
            const username = document.getElementById('tutorialUsername').value.trim();
            const region = document.getElementById('tutorialRegion').value;
            
            // Save user info
            userData.nickname = username;
            userData.region = region;
            
            // Set language based on region
            if (region === 'cn') {
                setLanguage('zh-cn');
            } else if (region === 'jp') {
                setLanguage('ja');
            } else if (region === 'kr') {
                setLanguage('ko');
            } else {
                setLanguage('en');
            }
            
            // Set timezone for daily reset
            const timezones = {
                'cn': 'Asia/Shanghai',
                'us': 'America/New_York',
                'eu': 'Europe/London',
                'jp': 'Asia/Tokyo',
                'kr': 'Asia/Seoul',
                'sea': 'Asia/Singapore',
                'other': 'UTC'
            };
            userData.timezone = timezones[region] || 'UTC';
            
            saveAllData();
            nextTutorialStep();
        }

        function highlightTutorialElement(step) {
            document.querySelectorAll('.tutorial-highlight').forEach(el => {
                el.classList.remove('tutorial-highlight');
                el.style.position = '';
                el.style.zIndex = '';
            });
            
            switch(step) {
                case 0:
                    const input = document.getElementById('userInput');
                    if (input) {
                        input.classList.add('tutorial-highlight');
                        input.style.position = 'relative';
                        input.style.zIndex = '1001';
                    }
                    break;
                case 1:
                    const modelSelector = document.getElementById('modelSelector');
                    const styleSelector = document.getElementById('styleSelector');
                    if (modelSelector) {
                        modelSelector.classList.add('tutorial-highlight');
                        modelSelector.style.position = 'relative';
                        modelSelector.style.zIndex = '1001';
                    }
                    if (styleSelector) {
                        styleSelector.classList.add('tutorial-highlight');
                        styleSelector.style.position = 'relative';
                        styleSelector.style.zIndex = '1001';
                    }
                    break;
                case 2:
                    const userPanel = document.getElementById('userPanel');
                    if (userPanel) {
                        userPanel.classList.add('tutorial-highlight');
                        userPanel.style.position = 'relative';
                        userPanel.style.zIndex = '1001';
                    }
                    break;
            }
        }

        function nextTutorialStep() {
            tutorialStep++;
            document.querySelectorAll('.tutorial-step').forEach(step => step.classList.add('hidden'));
            const nextStep = document.getElementById(`tutorialStep${tutorialStep + 1}`);
            if (nextStep) {
                nextStep.classList.remove('hidden');
                highlightTutorialElement(tutorialStep);
            }
        }

        function completeTutorial() {
            document.querySelectorAll('.tutorial-highlight').forEach(el => {
                el.classList.remove('tutorial-highlight');
                el.style.position = '';
                el.style.zIndex = '';
            });
            
            userData.tutorialCompleted = true;
            unlockAchievement('tutorial_complete');
            addXP(100);
            document.getElementById('tutorialOverlay').classList.add('hidden');
            document.getElementById('tutorialOverlay').classList.remove('flex');
        }

        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const replyFileInput = document.getElementById('replyFileInput');
            
            fileInput.addEventListener('change', (e) => handleFileSelect(e, 'main'));
            replyFileInput.addEventListener('change', (e) => handleFileSelect(e, 'reply'));

            function handleFileSelect(e, inputType) {
                handleFiles(e.target.files, inputType);
            }

            function handleFiles(files, inputType) {
                [...files].forEach(file => processFile(file, inputType));
            }

            async function processFile(file, inputType) {
                try {
                    let content = '';
                    let fileType = file.type;
                    
                    if (file.type.startsWith('text/') || file.name.endsWith('.txt') || file.name.endsWith('.md')) {
                        content = await readTextFile(file);
                    } else if (file.type.startsWith('image/')) {
                        content = await readImageFile(file);
                        fileType = 'image';
                    } else if (file.name.endsWith('.pdf')) {
                        content = `[PDF File: ${file.name} - ${Math.round(file.size/1024)}KB]`;
                        fileType = 'pdf';
                    } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
                        content = `[Document File: ${file.name} - ${Math.round(file.size/1024)}KB]`;
                        fileType = 'document';
                    } else {
                        content = `[File: ${file.name} - ${Math.round(file.size/1024)}KB - ${file.type}]`;
                        fileType = 'other';
                    }
                    
                    const fileData = {
                        id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                        name: file.name,
                        size: file.size,
                        type: fileType,
                        content: content,
                        uploadTime: new Date().toISOString()
                    };
                    
                    if (inputType === 'main') {
                        uploadedFiles.push(fileData);
                        updateFilePreview('filePreviewContainer', uploadedFiles);
                    } else {
                        replyUploadedFiles.push(fileData);
                        updateFilePreview('replyFilePreviewContainer', replyUploadedFiles);
                    }
                    
                    showFileUploadedMessage(file.name);
                    
                } catch (error) {
                    console.error('Error processing file:', error);
                    alert(`Error processing file ${file.name}: ${error.message}`);
                }
            }

            function readTextFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                });
            }

            function readImageFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(new Error('Failed to read image'));
                    reader.readAsDataURL(file);
                });
            }
        }

        function updateFilePreview(containerId, files) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (files.length > 0) {
                container.classList.remove('hidden');
                files.forEach(file => {
                    const preview = document.createElement('div');
                    preview.className = 'file-preview';
                    preview.innerHTML = `
                        <div class="flex items-center">
                            <i class="fas ${getFileIcon(file.type)} mr-2"></i>
                            <span class="text-sm font-medium">${file.name}</span>
                            <span class="text-xs text-gray-500 ml-2">(${Math.round(file.size/1024)}KB)</span>
                        </div>
                        <button onclick="removeFile('${file.id}', '${containerId}')" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(preview);
                });
            } else {
                container.classList.add('hidden');
            }
        }

        function getFileIcon(fileType) {
            switch(fileType) {
                case 'image': return 'fa-image';
                case 'pdf': return 'fa-file-pdf';
                case 'document': return 'fa-file-word';
                default: return 'fa-file';
            }
        }

        function removeFile(fileId, containerId) {
            if (containerId === 'filePreviewContainer') {
                uploadedFiles = uploadedFiles.filter(f => f.id !== fileId);
                updateFilePreview('filePreviewContainer', uploadedFiles);
            } else {
                replyUploadedFiles = replyUploadedFiles.filter(f => f.id !== fileId);
                updateFilePreview('replyFilePreviewContainer', replyUploadedFiles);
            }
        }

        function showFileUploadedMessage(fileName) {
            const message = translate('file_uploaded', fileName);
            const tempDiv = document.createElement('div');
            tempDiv.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
            tempDiv.textContent = message;
            document.body.appendChild(tempDiv);
            
            setTimeout(() => {
                tempDiv.remove();
            }, 3000);
        }

        function setupAutoResize() {
            ['userInput', 'replyInput'].forEach(id => {
                const textarea = document.getElementById(id);
                if (textarea) {
                    textarea.addEventListener('input', function() {
                        this.style.height = 'auto';
                        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
                        // Auto-complete for skill mode
                        if (isSkillMode && currentSkill === 'writing') {
                            handleWritingAutoComplete(this);
                        }
                        // Parse markdown-like formatting for real-time preview
                        if (this.value.includes('**') || this.value.includes('*') || this.value.includes('`')) {
                            // Add subtle styling hints for markdown
                            this.style.fontFamily = this.value.includes('`') ? 'monospace' : 'inherit';
                        }
                    });
                    
                    textarea.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && e.shiftKey) {
                            return;
                        } else if (e.key === 'Enter' && !e.shiftKey && this.value.trim() !== '') {
                            e.preventDefault();
                            sendMessage(this.id);
                        }
                    });
                }
            });
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const collapsibleButtons = document.getElementById('collapsibleButtons');
            const verticalDivider = document.getElementById('verticalDivider');
            
            sidebar.classList.toggle('active');
            
            if (sidebar.classList.contains('active')) {
                // ä¾§è¾¹æ æ‰“å¼€ï¼šéšè—ä¸‹é¢ä¸¤ä¸ªæŒ‰é’®å’Œåˆ†å‰²çº¿
                collapsibleButtons.classList.add('hidden');
                verticalDivider.classList.add('hidden');
            } else {
                // ä¾§è¾¹æ å…³é—­ï¼šæ˜¾ç¤ºæŒ‰é’®å’Œåˆ†å‰²çº¿
                collapsibleButtons.classList.remove('hidden');
                verticalDivider.classList.remove('hidden');
            }
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const collapsibleButtons = document.getElementById('collapsibleButtons');
            const verticalDivider = document.getElementById('verticalDivider');
            
            sidebar.classList.remove('active');
            collapsibleButtons.classList.remove('hidden');
            verticalDivider.classList.remove('hidden');
        }
        
        function initDarkMode() {
            if (localStorage.getItem('darkMode') === 'true') {
                document.documentElement.classList.add('dark');
            }
        }
        
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
            saveAllData();
        }

        function openSettingsModal() {
            document.getElementById('nicknameInput').value = userData.nickname || '';
            document.getElementById('avatarUrlInput').value = userData.avatar || '';
            document.getElementById('preferencesInput').value = userData.preferences || '';
            
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('settingsModal').classList.add('flex');
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').classList.add('hidden');
            document.getElementById('settingsModal').classList.remove('flex');
        }
        
        function saveUserSettings() {
            userData.nickname = document.getElementById('nicknameInput').value || 'User';
            userData.avatar = document.getElementById('avatarUrlInput').value || 'https://via.placeholder.com/40';
            userData.preferences = document.getElementById('preferencesInput').value;
            
            saveAllData();
            closeSettingsModal();
        }

        function useMonthlyRestore() {
            if (!userData.isPro || userData.isMax) {
                alert('This feature is only available for Pro members.');
                return;
            }
            
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;
            
            // æ£€æŸ¥æ˜¯å¦å·²ä½¿ç”¨æœ¬æœˆæ¢å¤
            if (userData.lastRestoreReset === currentMonth && userData.monthlyRestoreUsed) {
                alert('You have already used your monthly restore for this month.');
                return;
            }
            
            // é‡ç½®æœˆåº¦æ ‡è®°
            if (userData.lastRestoreReset !== currentMonth) {
                userData.monthlyRestoreUsed = false;
                userData.lastRestoreReset = currentMonth;
            }
            
            if (confirm('Use your monthly restore to reset points to 6,000? This can only be used once per month.')) {
                userData.points = 6000;
                userData.monthlyRestoreUsed = true;
                saveAllData();
                updateUIFromUserData();
                showAchievement('Points restored to 6,000!');
            }
        }

        function openUpgradeModal() {
            const modal = document.getElementById('upgradeModal');
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
        }

        function openUpgradeModal() {
            document.getElementById('upgradeModal').classList.remove('hidden');
            document.getElementById('upgradeModal').classList.add('flex');
        }
        
        function closeUpgradeModal() {
            document.getElementById('upgradeModal').classList.add('hidden');
            document.getElementById('upgradeModal').classList.remove('flex');
        }

        function openPointsModal() {
            document.getElementById('pointsModal').classList.remove('hidden');
            document.getElementById('pointsModal').classList.add('flex');
        }

        function closePointsModal() {
            document.getElementById('pointsModal').classList.add('hidden');
            document.getElementById('pointsModal').classList.remove('flex');
            document.getElementById('pointsCodeInput').value = '';
            document.getElementById('pointsMessage').classList.add('hidden');
        }

        // 移动到全局区域（约第3200行附近，与其他modal函数放一起）
        function handlePayment() {
            try {
                const upgradeModal = document.getElementById('upgradeModal');
                if (upgradeModal) {
                    upgradeModal.classList.add('hidden');
                    upgradeModal.classList.remove('flex');
                }
                
                const paymentMethodModal = document.getElementById('paymentMethodModal');
                if (paymentMethodModal) {
                    paymentMethodModal.classList.remove('hidden');
                    paymentMethodModal.classList.add('flex');
                }
            } catch (error) {
                console.error('Error opening payment modal:', error);
                alert('Unable to open payment options. Please try again.');
            }
        }

        function redeemPoints() {
            const code = document.getElementById('pointsCodeInput').value.trim().toUpperCase();
            
            const pointsCodes = {
                'EVAN110131': 1000,
                '110131EVAN': 1000,
                '123456': 1000,
                '20240901': 4000
            };
            
            if (pointsCodes[code]) {
                userData.points = (userData.points || 0) + pointsCodes[code];
                
                document.getElementById('headerPointsDisplay').textContent = userData.points.toLocaleString();
                document.getElementById('pointsDisplay').textContent = userData.points.toLocaleString();
                
                saveAllData();
                
                const message = document.getElementById('pointsMessage');
                message.textContent = `Successfully redeemed ${pointsCodes[code]} points!`;
                message.className = 'mt-3 text-sm text-green-500';
                message.classList.remove('hidden');
                
                setTimeout(() => {
                    closePointsModal();
                }, 2000);
            } else {
                const message = document.getElementById('pointsMessage');
                message.textContent = 'Invalid redemption code';
                message.className = 'mt-3 text-sm text-red-500';
                message.classList.remove('hidden');
            }
        }



        function redeemCode() {
            const code = document.getElementById('codeInput').value.trim().toUpperCase();
            
            const pointsCodes = {
                'EVAN110131': 1000,
                '110131EVAN': 1000,
                '123456': 1000,
                '20240901': 4000
            };
            
            const membershipCodes = {
                'FOUNDERS-WEEK-20250901': 7
            };
            
            if (pointsCodes[code]) {
                userData.points = (userData.points || 0) + pointsCodes[code];
                
                document.getElementById('headerPointsDisplay').textContent = userData.points.toLocaleString();
                document.getElementById('pointsDisplay').textContent = userData.points.toLocaleString();
                
                saveAllData();
                showAchievement(`Points added: +${pointsCodes[code]}`);
                closeUpgradeModal();
                
            } else if (membershipCodes[code]) {
                const days = membershipCodes[code];
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + days);
                
                userData.isPro = true;
                userData.membershipExpiry = expiryDate.toISOString();
                saveAllData();
                
                showAchievement(`Membership activated: ${days} days`);
                closeUpgradeModal();
                
                setTimeout(checkMembershipExpiry, 1000 * 60 * 60);
                
            } else {
                alert('Invalid redemption code. Please check and try again.');
            }
        }

                // MD5Ã¥Å  Ã¥Â¯â€ Ã¥â€¡Â½Ã¦â€¢Â°Ã¯Â¼Ë†Ã§Â®â‚¬Ã¥Å’â€“Ã§â€°Ë†Ã¯Â¼â€°
        function MD5(string) {
            function RotateLeft(lValue, iShiftBits) {
                return (lValue<<iShiftBits) | (lValue>>>(32-iShiftBits));
            }
            
            function AddUnsigned(lX,lY) {
                var lX4,lY4,lX8,lY8,lResult;
                lX8 = (lX & 0x80000000);
                lY8 = (lY & 0x80000000);
                lX4 = (lX & 0x40000000);
                lY4 = (lY & 0x40000000);
                lResult = (lX & 0x3FFFFFFF)+(lY & 0x3FFFFFFF);
                if (lX4 & lY4) {
                    return (lResult ^ 0x80000000 ^ lX8 ^ lY8);
                }
                if (lX4 | lY4) {
                    if (lResult & 0x40000000) {
                        return (lResult ^ 0xC0000000 ^ lX8 ^ lY8);
                    } else {
                        return (lResult ^ 0x40000000 ^ lX8 ^ lY8);
                    }
                } else {
                    return (lResult ^ lX8 ^ lY8);
                }
            }
            
            function F(x,y,z) { return (x & y) | ((~x) & z); }
            function G(x,y,z) { return (x & z) | (y & (~z)); }
            function H(x,y,z) { return (x ^ y ^ z); }
            function I(x,y,z) { return (y ^ (x | (~z))); }
            
            function FF(a,b,c,d,x,s,ac) {
                a = AddUnsigned(a, AddUnsigned(AddUnsigned(F(b, c, d), x), ac));
                return AddUnsigned(RotateLeft(a, s), b);
            };
            
            function GG(a,b,c,d,x,s,ac) {
                a = AddUnsigned(a, AddUnsigned(AddUnsigned(G(b, c, d), x), ac));
                return AddUnsigned(RotateLeft(a, s), b);
            };
            
            function HH(a,b,c,d,x,s,ac) {
                a = AddUnsigned(a, AddUnsigned(AddUnsigned(H(b, c, d), x), ac));
                return AddUnsigned(RotateLeft(a, s), b);
            };
            
            function II(a,b,c,d,x,s,ac) {
                a = AddUnsigned(a, AddUnsigned(AddUnsigned(I(b, c, d), x), ac));
                return AddUnsigned(RotateLeft(a, s), b);
            };
            
            function ConvertToWordArray(string) {
                var lWordCount;
                var lMessageLength = string.length;
                var lNumberOfWords_temp1=lMessageLength + 8;
                var lNumberOfWords_temp2=(lNumberOfWords_temp1-(lNumberOfWords_temp1 % 64))/64;
                var lNumberOfWords = (lNumberOfWords_temp2+1)*16;
                var lWordArray=Array(lNumberOfWords-1);
                var lBytePosition = 0;
                var lByteCount = 0;
                while ( lByteCount < lMessageLength ) {
                    lWordCount = (lByteCount-(lByteCount % 4))/4;
                    lBytePosition = (lByteCount % 4)*8;
                    lWordArray[lWordCount] = (lWordArray[lWordCount] | (string.charCodeAt(lByteCount)<<lBytePosition));
                    lByteCount++;
                }
                lWordCount = (lByteCount-(lByteCount % 4))/4;
                lBytePosition = (lByteCount % 4)*8;
                lWordArray[lWordCount] = lWordArray[lWordCount] | (0x80<<lBytePosition);
                lWordArray[lNumberOfWords-2] = lMessageLength<<3;
                lWordArray[lNumberOfWords-1] = lMessageLength>>>29;
                return lWordArray;
            };
            
            function WordToHex(lValue) {
                var WordToHexValue="",WordToHexValue_temp="",lByte,lCount;
                for (lCount = 0;lCount<=3;lCount++) {
                    lByte = (lValue>>>(lCount*8)) & 255;
                    WordToHexValue_temp = "0" + lByte.toString(16);
                    WordToHexValue = WordToHexValue + WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);
                }
                return WordToHexValue;
            };
            
            function Utf8Encode(string) {
                string = string.replace(/\r\n/g,"\n");
                var utftext = "";
                
                for (var n = 0; n < string.length; n++) {
                    var c = string.charCodeAt(n);
                    if (c < 128) {
                        utftext += String.fromCharCode(c);
                    }
                    else if((c > 127) && (c < 2048)) {
                        utftext += String.fromCharCode((c >> 6) | 192);
                        utftext += String.fromCharCode((c & 63) | 128);
                    }
                    else {
                        utftext += String.fromCharCode((c >> 12) | 224);
                        utftext += String.fromCharCode(((c >> 6) & 63) | 128);
                        utftext += String.fromCharCode((c & 63) | 128);
                    }
                }
                
                return utftext;
            };
            
            var x=Array();
            var k,AA,BB,CC,DD,a,b,c,d;
            var S11=7, S12=12, S13=17, S14=22;
            var S21=5, S22=9 , S23=14, S24=20;
            var S31=4, S32=11, S33=16, S34=23;
            var S41=6, S42=10, S43=15, S44=21;
            
            string = Utf8Encode(string);
            
            x = ConvertToWordArray(string);
            
            a = 0x67452301; b = 0xEFCDAB89; c = 0x98BADCFE; d = 0x10325476;
            
            for (k=0;k<x.length;k+=16) {
                AA=a; BB=b; CC=c; DD=d;
                a=FF(a,b,c,d,x[k+0], S11,0xD76AA478);
                d=FF(d,a,b,c,x[k+1], S12,0xE8C7B756);
                c=FF(c,d,a,b,x[k+2], S13,0x242070DB);
                b=FF(b,c,d,a,x[k+3], S14,0xC1BDCEEE);
                a=FF(a,b,c,d,x[k+4], S11,0xF57C0FAF);
                d=FF(d,a,b,c,x[k+5], S12,0x4787C62A);
                c=FF(c,d,a,b,x[k+6], S13,0xA8304613);
                b=FF(b,c,d,a,x[k+7], S14,0xFD469501);
                a=FF(a,b,c,d,x[k+8], S11,0x698098D8);
                d=FF(d,a,b,c,x[k+9], S12,0x8B44F7AF);
                c=FF(c,d,a,b,x[k+10],S13,0xFFFF5BB1);
                b=FF(b,c,d,a,x[k+11],S14,0x895CD7BE);
                a=FF(a,b,c,d,x[k+12],S11,0x6B901122);
                d=FF(d,a,b,c,x[k+13],S12,0xFD987193);
                c=FF(c,d,a,b,x[k+14],S13,0xA679438E);
                b=FF(b,c,d,a,x[k+15],S14,0x49B40821);
                a=GG(a,b,c,d,x[k+1], S21,0xF61E2562);
                d=GG(d,a,b,c,x[k+6], S22,0xC040B340);
                c=GG(c,d,a,b,x[k+11],S23,0x265E5A51);
                b=GG(b,c,d,a,x[k+0], S24,0xE9B6C7AA);
                a=GG(a,b,c,d,x[k+5], S21,0xD62F105D);
                d=GG(d,a,b,c,x[k+10],S22,0x2441453);
                c=GG(c,d,a,b,x[k+15],S23,0xD8A1E681);
                b=GG(b,c,d,a,x[k+4], S24,0xE7D3FBC8);
                a=GG(a,b,c,d,x[k+9], S21,0x21E1CDE6);
                d=GG(d,a,b,c,x[k+14],S22,0xC33707D6);
                c=GG(c,d,a,b,x[k+3], S23,0xF4D50D87);
                b=GG(b,c,d,a,x[k+8], S24,0x455A14ED);
                a=GG(a,b,c,d,x[k+13],S21,0xA9E3E905);
                d=GG(d,a,b,c,x[k+2], S22,0xFCEFA3F8);
                c=GG(c,d,a,b,x[k+7], S23,0x676F02D9);
                b=GG(b,c,d,a,x[k+12],S24,0x8D2A4C8A);
                a=HH(a,b,c,d,x[k+5], S31,0xFFFA3942);
                d=HH(d,a,b,c,x[k+8], S32,0x8771F681);
                c=HH(c,d,a,b,x[k+11],S33,0x6D9D6122);
                b=HH(b,c,d,a,x[k+14],S34,0xFDE5380C);
                a=HH(a,b,c,d,x[k+1], S31,0xA4BEEA44);
                d=HH(d,a,b,c,x[k+4], S32,0x4BDECFA9);
                c=HH(c,d,a,b,x[k+7], S33,0xF6BB4B60);
                b=HH(b,c,d,a,x[k+10],S34,0xBEBFBC70);
                a=HH(a,b,c,d,x[k+13],S31,0x289B7EC6);
                d=HH(d,a,b,c,x[k+0], S32,0xEAA127FA);
                c=HH(c,d,a,b,x[k+3], S33,0xD4EF3085);
                b=HH(b,c,d,a,x[k+6], S34,0x4881D05);
                a=HH(a,b,c,d,x[k+9], S31,0xD9D4D039);
                d=HH(d,a,b,c,x[k+12],S32,0xE6DB99E5);
                c=HH(c,d,a,b,x[k+15],S33,0x1FA27CF8);
                b=HH(b,c,d,a,x[k+2], S34,0xC4AC5665);
                a=II(a,b,c,d,x[k+0], S41,0xF4292244);
                d=II(d,a,b,c,x[k+7], S42,0x432AFF97);
                c=II(c,d,a,b,x[k+14],S43,0xAB9423A7);
                b=II(b,c,d,a,x[k+5], S44,0xFC93A039);
                a=II(a,b,c,d,x[k+12],S41,0x655B59C3);
                d=II(d,a,b,c,x[k+3], S42,0x8F0CCC92);
                c=II(c,d,a,b,x[k+10],S43,0xFFEFF47D);
                b=II(b,c,d,a,x[k+1], S44,0x85845DD1);
                a=II(a,b,c,d,x[k+8], S41,0x6FA87E4F);
                d=II(d,a,b,c,x[k+15],S42,0xFE2CE6E0);
                c=II(c,d,a,b,x[k+6], S43,0xA3014314);
                b=II(b,c,d,a,x[k+13],S44,0x4E0811A1);
                a=II(a,b,c,d,x[k+4], S41,0xF7537E82);
                d=II(d,a,b,c,x[k+11],S42,0xBD3AF235);
                c=II(c,d,a,b,x[k+2], S43,0x2AD7D2BB);
                b=II(b,c,d,a,x[k+9], S44,0xEB86D391);
                a=AddUnsigned(a,AA);
                b=AddUnsigned(b,BB);
                c=AddUnsigned(c,CC);
                d=AddUnsigned(d,DD);
            }
            
            var temp = WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d);
            
            return temp.toLowerCase();
        }

        function checkMembershipExpiry() {
            if (userData.membershipExpiry) {
                const now = new Date();
                const expiry = new Date(userData.membershipExpiry);
                
                if (now > expiry) {
                    userData.isPro = false;
                    userData.membershipExpiry = null;
                    saveAllData();
                    updateUIFromUserData();
                    showAchievement('Your membership has expired. Thanks for your support!');
                } else {
                    setTimeout(checkMembershipExpiry, 1000 * 60 * 60);
                }
            }
        }

        function startNewChat() {
            try {
                if (currentChatMessages.length > 0 && currentChatId) {
                    const existingChatIndex = chatHistory.findIndex(c => c.id === currentChatId);
                    if (existingChatIndex !== -1) {
                        chatHistory[existingChatIndex].messages = [...currentChatMessages];
                        chatHistory[existingChatIndex].timestamp = new Date().toISOString();
                    } else {
                        const chatTitle = generateChatTitle(currentChatMessages[0].content);
                        const chat = {
                            id: currentChatId,
                            title: chatTitle,
                            messages: [...currentChatMessages],
                            timestamp: new Date().toISOString()
                        };
                        chatHistory.unshift(chat);
                    }
                    saveChatHistory();
                }
                
                currentChatMessages = [];
                currentChatId = null;
                uploadedFiles = [];
                replyUploadedFiles = [];
                
                document.getElementById('initialView').classList.remove('hidden');
                document.getElementById('chatView').classList.add('hidden');
                document.getElementById('bottomInputArea').classList.add('hidden');
                document.getElementById('currentChatTitle').classList.add('hidden');
                document.getElementById('chatView').innerHTML = '';
                updateFilePreview('filePreviewContainer', uploadedFiles);
                updateFilePreview('replyFilePreviewContainer', replyUploadedFiles);
                updateChatHistoryUI();
                closeSidebar();
            } catch (error) {
                console.error('Error starting new chat:', error);
            }
        }

        function generateChatTitle(firstMessage) {
            return firstMessage.length > 50 ? firstMessage.substring(0, 47) + '...' : firstMessage;
        }

        // Replace the loadChat function with this fixed version:

        function loadChat(chatId) {
            try {
                const chat = chatHistory.find(c => c.id === chatId);
                if (chat) {
                    if (currentChatMessages.length > 0 && currentChatId) {
                        const existingChatIndex = chatHistory.findIndex(c => c.id === currentChatId);
                        if (existingChatIndex !== -1) {
                            chatHistory[existingChatIndex].messages = [...currentChatMessages];
                            chatHistory[existingChatIndex].timestamp = new Date().toISOString();
                        }
                    }
                    
                    currentChatMessages = [...chat.messages];
                    currentChatId = chat.id;
                    uploadedFiles = [];
                    replyUploadedFiles = [];
                    
                    document.getElementById('initialView').classList.add('hidden');
                    document.getElementById('chatView').classList.remove('hidden');
                    document.getElementById('bottomInputArea').classList.remove('hidden');
                    document.getElementById('currentChatTitle').textContent = chat.title;
                    document.getElementById('currentChatTitle').classList.remove('hidden');
                    
                    const chatView = document.getElementById('chatView');
                    chatView.innerHTML = '';
                    currentChatMessages.forEach(msg => {
                        if (msg.role === 'user') {
                            addUserMessage(msg.content, false);
                        } else if (msg.role === 'assistant') {
                            if (msg.content.includes('<artifact>')) {
                                addAIMessageWithArtifacts(msg.content, false);
                            } else if (msg.postThinking) {
                                // Handle post thinking messages
                                reconstructPostThinkingMessage(msg, false);
                            } else if (msg.thinkingProcess) {
                                // Handle normal deep thinking messages
                                addAIMessageWithThinking(msg.content, msg.thinkingProcess, false);
                            } else if (msg.secondaryThinking) {
                                // Handle messages with secondary thinking
                                reconstructSecondaryThinkingMessage(msg, false);
                            } else {
                                addAIMessage(msg.content, false);
                            }
                        }
                    });
                    
                    updateFilePreview('filePreviewContainer', uploadedFiles);
                    updateFilePreview('replyFilePreviewContainer', replyUploadedFiles);
                }
                closeSidebar();
            } catch (error) {
                console.error('Error loading chat:', error);
            }
        }

        // Add this new function to reconstruct post thinking messages
        function reconstructPostThinkingMessage(msg, scroll = true) {
            const chatView = document.getElementById('chatView');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message-ai mb-4';
            
            let html = '';
            
            // First thinking process
            if (msg.firstThinking || msg.thinkingProcess) {
                const thinkingContent = msg.firstThinking || msg.thinkingProcess;
                html += `
                    <div class="thinking-process mb-4">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleThinking(this)">
                            <div class="flex items-center">
                                <i class="fas fa-brain mr-2 text-purple-500"></i>
                                <span class="font-medium">${translate('thinking_process') || 'Thinking Process'}</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform"></i>
                        </div>
                        <div class="thinking-content p-3 pt-0 hidden">
                            <div class="text-sm text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap">${thinkingContent}</div>
                        </div>
                    </div>
                `;
            }
            
            // Second thinking process (if exists)
            if (msg.secondThinking) {
                html += `
                    <div class="thinking-process mb-4">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleThinking(this)">
                            <div class="flex items-center">
                                <i class="fas fa-brain mr-2 text-purple-500"></i>
                                <span class="font-medium">Phase 2 Thinking</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform"></i>
                        </div>
                        <div class="thinking-content p-3 pt-0 hidden">
                            <div class="text-sm text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap">${msg.secondThinking}</div>
                        </div>
                    </div>
                `;
            }
            
            // Response content
            html += `
                <div class="response-content">
                    ${marked.parse(msg.content)}
                </div>
            `;
            
            messageDiv.innerHTML = html;
            
            addMessageControls(messageDiv);
            addCodeCopyButtons(messageDiv);
            
            if (typeof Prism !== 'undefined') {
                Prism.highlightAllUnder(messageDiv);
            }
            
            chatView.appendChild(messageDiv);
            if (scroll) chatView.scrollTop = chatView.scrollHeight;
            return messageDiv;
        }

        // Add this new function to reconstruct secondary thinking messages
        function reconstructSecondaryThinkingMessage(msg, scroll = true) {
            const chatView = document.getElementById('chatView');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message-ai mb-4';
            
            let html = '';
            
            // Main thinking process (if exists)
            if (msg.thinkingProcess) {
                html += `
                    <div class="thinking-process mb-4">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleThinking(this)">
                            <div class="flex items-center">
                                <i class="fas fa-brain mr-2 text-blue-500"></i>
                                <span class="font-medium">${translate('thinking_process') || 'Thinking Process'}</span>
                            </div>
                            <i class="fas fa-chevron-down transition-transform"></i>
                        </div>
                        <div class="thinking-content p-3 pt-0 hidden">
                            <div class="text-sm text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap">${msg.thinkingProcess}</div>
                        </div>
                    </div>
                `;
            }
            
            // Main response content
            html += `
                <div class="response-content">
                    ${marked.parse(msg.content)}
                </div>
            `;
            
            // Secondary thinking (if exists)
            if (msg.secondaryThinking) {
                html += `
                    <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg">
                        <div class="space-y-2">
                            <div class="flex items-center border-b border-blue-200 dark:border-blue-700 pb-2">
                                <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                                <span class="font-medium">Secondary Analysis Complete</span>
                            </div>
                            <div class="text-sm text-gray-700 dark:text-gray-300">
                                ${marked.parse(msg.secondaryThinking)}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = html;
            
            addMessageControls(messageDiv);
            addCodeCopyButtons(messageDiv);
            
            if (typeof Prism !== 'undefined') {
                Prism.highlightAllUnder(messageDiv);
            }
            
            chatView.appendChild(messageDiv);
            if (scroll) chatView.scrollTop = chatView.scrollHeight;
            return messageDiv;
        }

        // Also update the saveChatHistory function to ensure thinking processes are saved
        function saveChatHistory() {
            try {
                // Ensure all thinking processes are included in saved messages
                chatHistory.forEach(chat => {
                    if (chat.messages) {
                        chat.messages = chat.messages.map(msg => {
                            // Preserve all thinking-related properties
                            if (msg.role === 'assistant') {
                                return {
                                    role: msg.role,
                                    content: msg.content,
                                    thinkingProcess: msg.thinkingProcess || null,
                                    postThinking: msg.postThinking || false,
                                    firstThinking: msg.firstThinking || null,
                                    secondThinking: msg.secondThinking || null,
                                    secondaryThinking: msg.secondaryThinking || null,
                                    cutoffPoint: msg.cutoffPoint || null,
                                    phase1Content: msg.phase1Content || null,
                                    phase2Content: msg.phase2Content || null,
                                    singlePhase: msg.singlePhase || false
                                };
                            }
                            return msg;
                        });
                    }
                });
                
                localStorage.setItem('tyloai_chats', JSON.stringify(chatHistory));
            } catch (error) {
                console.error('Error saving chat history:', error);
            }
        }

        function loadChatHistory() {
            try {
                const saved = localStorage.getItem('tyloai_chats');
                if (saved) {
                    chatHistory = JSON.parse(saved);
                    updateChatHistoryUI();
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
                chatHistory = [];
            }
        }

        function updateChatHistoryUI() {
            try {
                const historyContainer = document.getElementById('chatHistory');
                if (chatHistory.length === 0) {
                    historyContainer.innerHTML = `<div class="space-y-2"><p class="text-gray-500 dark:text-gray-400 text-sm">${translate('no_chat_history')}</p></div>`;
                    return;
                }
                
                historyContainer.innerHTML = '<div class="space-y-2"></div>';
                const container = historyContainer.firstElementChild;
                
                chatHistory.slice(0, 20).forEach(chat => {
                    const item = document.createElement('div');
                    item.className = `p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded cursor-pointer text-sm ${currentChatId === chat.id ? 'bg-blue-100 dark:bg-blue-900' : ''}`;
                    const agentBadge = chat.isAgent ? '<span class="inline-block bg-purple-500 text-white text-xs px-2 py-1 rounded-full mr-2">Agent</span>' : '';
                    item.innerHTML = `
                        <div class="font-medium truncate">${agentBadge}${chat.title}</div>
                        <div class="text-xs text-gray-500">${new Date(chat.timestamp).toLocaleDateString()}</div>
                    `;
                    item.onclick = () => loadChat(chat.id);
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error updating chat history UI:', error);
            }
        }

        function searchChats() {
            try {
                const query = document.getElementById('searchInput').value.toLowerCase();
                const historyContainer = document.getElementById('chatHistory').firstElementChild;
                
                if (!query) {
                    updateChatHistoryUI();
                    return;
                }
                
                historyContainer.innerHTML = '';
                const filteredChats = chatHistory.filter(chat => 
                    chat.title.toLowerCase().includes(query) ||
                    chat.messages.some(msg => msg.content.toLowerCase().includes(query))
                );
                
                filteredChats.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'p-2 hover:bg-gray-200 dark:hover:bg-gray-700 rounded cursor-pointer text-sm';
                    
                    const highlightedTitle = highlightText(chat.title, query);
                    item.innerHTML = `
                        <div class="font-medium truncate">${highlightedTitle}</div>
                        <div class="text-xs text-gray-500">${new Date(chat.timestamp).toLocaleDateString()}</div>
                    `;
                    item.onclick = () => loadChat(chat.id);
                    historyContainer.appendChild(item);
                });
            } catch (error) {
                console.error('Error searching chats:', error);
            }
        }

        function highlightText(text, query) {
            const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedQuery})`, 'gi');
            return text.replace(regex, '<mark class="bg-yellow-200 dark:bg-yellow-600">$1</mark>');
        }

        function stopGeneration() {
            if (currentController) {
                currentController.abort();
                isGenerating = false;
                
                document.getElementById('sendIcon').classList.remove('hidden');
                document.getElementById('stopIcon').classList.add('hidden');
                
                const lastMessage = document.querySelector('.chat-message-ai:last-child');
                if (lastMessage && lastMessage.querySelector('.ai-typing')) {
                    lastMessage.innerHTML = `<p class="text-gray-500 italic">${translate('generation_stopped')}</p>`;
                }
            }
        }

        async function sendMessage(inputId) {
            // In sendMessage function, update the cost calculation:
            let totalCost = 0;

            if (isCodingMode) {
                totalCost += 100; // Base coding mode cost
                
                // Add model cost
                const modelInfo = CODING_MODELS[currentModel];
                if (modelInfo) {
                    totalCost += modelInfo.cost;
                }
                
                // Deep thinking in coding mode adds 200 pts
                if (isNormalThinking) {
                    totalCost += 200;
                }
            } else {
                if (currentModel === 'ode-6') {

                if (userData.isMax) {
                    totalCost += 0;
                } else if (userData.isPro) {
                    totalCost += 400;
                } else {
                    totalCost += 300;
                }
            } else if (currentModel === 'ode-6-flash') {
                if (!userData.isMax) {
                    if (userData.isPro) {
                        totalCost += 0;
                    } else {
                        totalCost += 50;
                    }
                }
            }
            }

            // æ‹“å±•æ€è€ƒè´¹ç”¨
            if (isNormalThinking) {
                if (userData.isMax) {
                    totalCost += 0;
                } else if (userData.isPro) {
                    totalCost += 0; // Proç”¨æˆ·æ‹“å±•æ€è€ƒæ— é™æ¬¡
                } else {
                    totalCost += 100;
                }
            }

            // è”ç½‘æœç´¢è´¹ç”¨
            if (isWebSearch) {
                if (!userData.isMax) {
                    totalCost += 100; // Proå’ŒFreeç”¨æˆ·éƒ½éœ€è¦100ç§¯åˆ†
                }
            }

            if (totalCost > 0 && !userData.isPro && !userData.isStudent) {
                if (!deductPoints(totalCost)) {
                    return;
                }
            }



            if (isSending) return;
            
            try {
                const input = document.getElementById(inputId);
                const message = input.value.trim();
                if (!message) return;
                
                if (!currentChatId) {
                    currentChatId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                }
                
                const relevantFiles = inputId === 'userInput' ? uploadedFiles : replyUploadedFiles;
                
                if (currentModel === 'tylo-aria-image') {
                    await handleImageGeneration(message, input, relevantFiles);
                    return;
                } else if (currentModel === 'tylo-aria-video') {
                    await handleVideoGeneration(message, input, relevantFiles);
                    return;
                } else if (currentModel === 'tylo-aria-music') {
                    await handleMusicGeneration(message, input, relevantFiles);
                    return;
                }
                
                // Check usage limits
                if (currentModel === 'ode-5' && !userData.isPro && !userData.isStudent) {
                    if (!checkOdeUsage()) {
                        return;
                    }
                    userData.odeUsageThisMonth = (userData.odeUsageThisMonth || 0) + 1;
                    saveAllData();
                }
                
                const modelCost = document.querySelector('#modelOptions .dropdown-option.selected')?.dataset.cost || 0;
                if (parseInt(modelCost) > 0 && !deductPoints(parseInt(modelCost))) {
                    return;
                }
                
                isSending = true;
                isGenerating = true;
                input.disabled = true;

                document.getElementById('initialView').classList.add('hidden');
                document.getElementById('chatView').classList.remove('hidden');
                document.getElementById('bottomInputArea').classList.remove('hidden');

                document.getElementById('sendIcon').classList.add('hidden');
                document.getElementById('stopIcon').classList.remove('hidden');
                

                removeAllMessageControls();

                addUserMessage(message);
                
                let messageWithFiles = message;
                if (relevantFiles.length > 0) {
                    messageWithFiles = message + '\n\n[Uploaded Files Context]:\n';
                    relevantFiles.forEach(file => {
                        messageWithFiles += `\n--- ${file.name} (${file.type}) ---\n`;
                        if (file.type === 'image' && file.content.startsWith('data:image')) {
                            messageWithFiles += `[Image file: ${file.name}]\n`;
                        } else if (file.content.length > 0 && !file.content.startsWith('[')) {
                            messageWithFiles += file.content + '\n';
                        } else {
                            messageWithFiles += file.content + '\n';
                        }
                    });
                }
                
                // 在 sendMessage 函数中
                currentChatMessages.push({ role: 'user', content: messageWithFiles });

                // 先声明 typingDiv（移到前面）
                const typingDiv = addAIMessage('');

                // 然后再使用
                Promise.all([
                    callAPI(messageWithFiles, typingDiv),
                    analyzeMessageForMemory(message, true).catch(err => 
                        console.error('Memory analysis error:', err)
                    )
                ]).then(() => {
                    // 两个任务都完成后的处理
                }).catch(err => {
                    console.error('API call error:', err);
                });
                
                userData.chatCount = (userData.chatCount || 0) + 1;
                if (userData.chatCount === 1) unlockAchievement('first_chat');
                if (userData.chatCount === 10) unlockAchievement('chat_count_10');
                
                input.value = '';
                input.style.height = 'auto';

                if (inputId === 'userInput') {
                    uploadedFiles = [];
                    updateFilePreview('filePreviewContainer', uploadedFiles);
                } else {
                    replyUploadedFiles = [];
                    updateFilePreview('replyFilePreviewContainer', replyUploadedFiles);
                }

                hideSuggestions();

                // 先声明 typingDiv

                // 然后再并发执行
                const apiPromise = callAPI(messageWithFiles, typingDiv);
                const memoryPromise = analyzeMessageForMemory(message, true).catch(err => {
                    console.error('Memory analysis error (non-blocking):', err);
                });

                // 等待主API完成(不等记忆分析)
                await apiPromise;

                input.disabled = false;
                isSending = false;
                isGenerating = false;

                document.getElementById('sendIcon').classList.remove('hidden');
                document.getElementById('stopIcon').classList.add('hidden');

                saveAllData();
                saveChatHistory();

                // 记忆分析在后台继续执行,不阻塞用户
                
            } catch (error) {
                console.error('Error in sendMessage:', error);
                if (error.name !== 'AbortError') {
                    const lastMessage = document.querySelector('.chat-message-ai:last-child');
                    if (lastMessage) {
                        lastMessage.innerHTML = `<p class="text-red-500">${translate('api_error') || 'Sorry, I encountered an error. Please try again.'}</p>`;
                    }
                }
                
                const input = document.getElementById(inputId);
                if (input) input.disabled = false;
                isSending = false;
                isGenerating = false;
                document.getElementById('sendIcon').classList.remove('hidden');
                document.getElementById('stopIcon').classList.add('hidden');
            }
        }

        async function handleImageGeneration(message, input, relevantFiles) {
            if (!checkImageQuota(selectedImageCount)) {
                return;
            }
            
            if (!deductPoints(1000)) {
                return;
            }
            
            isSending = true;
            input.disabled = true;

            document.getElementById('initialView').classList.add('hidden');
            document.getElementById('chatView').classList.remove('hidden');
            document.getElementById('bottomInputArea').classList.remove('hidden');
            
            addUserMessage(message);
            
            const responseDiv = addAIMessage('');
            
            try {
                responseDiv.innerHTML = `<p>${translate('creating_image', selectedArtStyle)}...</p><div class="ai-typing"></div>`;
                
                const enhancedPrompt = await enhancePrompt(message, selectedArtStyle, 'image');
                
                responseDiv.innerHTML = `<p>I will create a ${selectedArtStyle} image for you...</p><div class="mt-2 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg"><strong>Enhanced prompt:</strong> ${enhancedPrompt}</div>`;
                
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'mt-4 p-6 rounded-lg media-generating flex items-center justify-center';
                loadingDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-palette text-2xl mb-2 animate-pulse"></i>
                        <p>Generating ${selectedImageCount} image${selectedImageCount > 1 ? 's' : ''}...</p>
                    </div>
                `;
                responseDiv.appendChild(loadingDiv);
                
                const images = await generateImages(enhancedPrompt, selectedImageCount);
                
                loadingDiv.remove();
                
                const imagesContainer = document.createElement('div');
                imagesContainer.className = `grid gap-4 mt-4 ${selectedImageCount === 2 ? 'grid-cols-2' : 'grid-cols-1'}`;
                
                images.forEach((imageUrl, index) => {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'relative';
                    imgDiv.innerHTML = `
                        <img src="${imageUrl}" alt="Generated image ${index + 1}" class="w-full rounded-lg shadow-lg">
                        <div class="absolute top-2 right-2 flex space-x-1">
                            <button onclick="downloadImage('${imageUrl}', '${index + 1}')" class="bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="shareImage('${imageUrl}')" class="bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70">
                                <i class="fas fa-share"></i>
                            </button>
                        </div>
                    `;
                    imagesContainer.appendChild(imgDiv);
                });
                
                responseDiv.appendChild(imagesContainer);
                
                userData.imagesGeneratedToday = (userData.imagesGeneratedToday || 0) + selectedImageCount;
                if (!(userData.achievements || []).includes('first_image')) {
                    unlockAchievement('first_image');
                }
                
                const successDiv = document.createElement('div');
                successDiv.className = 'mt-4 p-3 bg-green-50 dark:bg-green-900 rounded-lg';
                successDiv.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i>${translate('media_generated')}`;
                responseDiv.appendChild(successDiv);
                
            } catch (error) {
                console.error('Error generating image:', error);
                responseDiv.innerHTML = `<p class="text-red-500">Sorry, I encountered an error generating the image. Please try again.</p>`;
            }
            
            input.disabled = false;
            isSending = false;
            saveAllData();
        }

        async function handleVideoGeneration(message, input, relevantFiles) {
            if (!checkVideoQuota()) {
                return;
            }
            
            if (!deductPoints(3000)) {
                return;
            }
            
            isSending = true;
            input.disabled = true;

            document.getElementById('initialView').classList.add('hidden');
            document.getElementById('chatView').classList.remove('hidden');
            document.getElementById('bottomInputArea').classList.remove('hidden');
            
            addUserMessage(message);
            
            const responseDiv = addAIMessage('');
            
            try {
                responseDiv.innerHTML = `<p>${translate('creating_video')}...</p><div class="ai-typing"></div>`;
                
                const enhancedPrompt = await enhancePrompt(message, 'cinematic', 'video');
                
                responseDiv.innerHTML = `<p>I will create a video for you...</p><div class="mt-2 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg"><strong>Enhanced prompt:</strong> ${enhancedPrompt}</div>`;
                
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'mt-4 p-6 rounded-lg media-generating flex items-center justify-center';
                loadingDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-video text-2xl mb-2 animate-pulse"></i>
                        <p>Generating video... This may take a few minutes.</p>
                    </div>
                `;
                responseDiv.appendChild(loadingDiv);
                
                const videoUrl = await generateVideo(enhancedPrompt);
                
                loadingDiv.remove();
                
                const videoContainer = document.createElement('div');
                videoContainer.className = 'video-container mt-4';
                videoContainer.innerHTML = `
                    <video controls class="w-full rounded-lg shadow-lg">
                        <source src="${videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    <div class="flex justify-center mt-2 space-x-2">
                        <button onclick="downloadVideo('${videoUrl}')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                            <i class="fas fa-download mr-2"></i>Download
                        </button>
                        <button onclick="shareVideo('${videoUrl}')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                            <i class="fas fa-share mr-2"></i>Share
                        </button>
                    </div>
                `;
                
                responseDiv.appendChild(videoContainer);
                
                userData.videosGenerated = (userData.videosGenerated || 0) + 1;
                if (!(userData.achievements || []).includes('first_video')) {
                    unlockAchievement('first_video');
                }
                
                const successDiv = document.createElement('div');
                successDiv.className = 'mt-4 p-3 bg-green-50 dark:bg-green-900 rounded-lg';
                successDiv.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i>${translate('media_generated')}`;
                responseDiv.appendChild(successDiv);
                
            } catch (error) {
                console.error('Error generating video:', error);
                responseDiv.innerHTML = `<p class="text-red-500">Sorry, I encountered an error generating the video. Please try again.</p>`;
            }
            
            input.disabled = false;
            isSending = false;
            saveAllData();
        }

        async function handleMusicGeneration(message, input, relevantFiles) {
            if (!deductPoints(3000)) {
                return;
            }
            
            isSending = true;
            input.disabled = true;

            document.getElementById('initialView').classList.add('hidden');
            document.getElementById('chatView').classList.remove('hidden');
            document.getElementById('bottomInputArea').classList.remove('hidden');
            
            addUserMessage(message);
            
            const responseDiv = addAIMessage('');
            
            try {
                responseDiv.innerHTML = `<p>${translate('creating_music')}...</p><div class="ai-typing"></div>`;
                
                const lyrics = await generateLyrics(message, selectedMusicStyle);
                
                responseDiv.innerHTML = `<p>I will create ${selectedMusicStyle} music for you...</p><div class="mt-2 p-3 bg-gray-100 dark:bg-gray-700 rounded-lg"><strong>Generated Lyrics:</strong><br><pre class="whitespace-pre-wrap text-sm mt-2">${lyrics}</pre></div>`;
                
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'mt-4 p-6 rounded-lg media-generating flex items-center justify-center';
                loadingDiv.innerHTML = `
                    <div class="text-center">
                        <i class="fas fa-music text-2xl mb-2 animate-pulse"></i>
                        <p>Generating music... This may take a few minutes.</p>
                    </div>
                `;
                responseDiv.appendChild(loadingDiv);
                
                const musicUrl = await generateMusic(lyrics, selectedMusicStyle);
                
                loadingDiv.remove();
                
                const musicContainer = document.createElement('div');
                musicContainer.className = 'audio-container mt-4';
                musicContainer.innerHTML = `
                    <h4 class="text-lg font-bold mb-2">${selectedMusicStyle.charAt(0).toUpperCase() + selectedMusicStyle.slice(1)} Song</h4>
                    <p class="text-sm opacity-90 mb-3">Generated by TyloAI</p>
                    <audio controls>
                        <source src="${musicUrl}" type="audio/mpeg">
                        Your browser does not support the audio element.
                    </audio>
                    <div class="flex justify-center mt-4 space-x-2">
                        <button onclick="downloadMusic('${musicUrl}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-md transition-all">
                            <i class="fas fa-download mr-2"></i>Download
                        </button>
                        <button onclick="shareMusic('${musicUrl}')" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-md transition-all">
                            <i class="fas fa-share mr-2"></i>Share
                        </button>
                    </div>
                `;
                
                responseDiv.appendChild(musicContainer);
                
                userData.musicGenerated = (userData.musicGenerated || 0) + 1;
                if (!(userData.achievements || []).includes('first_music')) {
                    unlockAchievement('first_music');
                }
                
                const successDiv = document.createElement('div');
                successDiv.className = 'mt-4 p-3 bg-green-50 dark:bg-green-900 rounded-lg';
                successDiv.innerHTML = `<i class="fas fa-check-circle text-green-500 mr-2"></i>${translate('media_generated')}`;
                responseDiv.appendChild(successDiv);
                
            } catch (error) {
                console.error('Error generating music:', error);
                responseDiv.innerHTML = `<p class="text-red-500">Sorry, I encountered an error generating the music. Please try again.</p>`;
            }
            
            input.disabled = false;
            isSending = false;
            saveAllData();
        }

        async function enhancePrompt(userPrompt, style, mediaType) {
            try {
                let enhancementInstructions = '';
                
                if (mediaType === 'image') {
                    enhancementInstructions = `You are an expert prompt engineer for DALL-E-3. Transform this user request into a detailed, vivid prompt that will generate amazing ${style} images. User request: "${userPrompt}"

Guidelines:
- Make it highly detailed and descriptive
- Include lighting, composition, and mood elements
- Specify ${style} style characteristics
- Keep it under 100 words
- Make it creative and artistic

Enhanced prompt:`;
                } else if (mediaType === 'video') {
                    enhancementInstructions = `You are an expert prompt engineer for video generation AI. Transform this user request into a detailed, vivid prompt for creating cinematic videos. User request: "${userPrompt}"

Guidelines:
- Make it highly detailed and descriptive
- Include camera movements, lighting, and scene descriptions
- Specify cinematic elements and mood
- Keep it under 150 words
- Focus on visual storytelling

Enhanced prompt:`;
                }

                const response = await fetch(`${API_CONFIG.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-v3',
                        messages: [{ role: 'user', content: enhancementInstructions }],
                        temperature: 0.8,
                        max_tokens: 200
                    })
                });

                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('Error enhancing prompt:', error);
                return `A beautiful ${style} ${mediaType} of ${userPrompt}`;
            }
        }

        async function generateImages(prompt, count) {
            try {
                const images = [];
                
                for (let i = 0; i < count; i++) {
                    const response = await fetch(`${API_CONFIG.baseUrl}/images/generations`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_CONFIG.apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'dall-e-3',
                            prompt: prompt,
                            size: '1024x1024',
                            quality: 'standard',
                            n: 1
                        })
                    });

                    const data = await response.json();
                    if (data.data && data.data[0]) {
                        images.push(data.data[0].url);
                    }
                }
                
                return images;
            } catch (error) {
                console.error('Error generating images:', error);
                throw error;
            }
        }

        async function generateVideo(prompt) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/video/generations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'luma_video_api',
                        prompt: prompt,
                        duration: 5,
                        aspect_ratio: '16:9'
                    })
                });

                const data = await response.json();
                if (data.video_url) {
                    return data.video_url;
                } else {
                    throw new Error('No video URL returned');
                }
            } catch (error) {
                console.error('Error generating video:', error);
                throw error;
            }
        }

        async function generateLyrics(prompt, style) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'suno_lyrics',
                        messages: [{ 
                            role: 'user', 
                            content: `Write ${style} song lyrics based on this theme: ${prompt}. Make it catchy and suitable for music generation.` 
                        }],
                        temperature: 0.9,
                        max_tokens: 500
                    })
                });

                const data = await response.json();
                return data.choices[0].message.content.trim();
            } catch (error) {
                console.error('Error generating lyrics:', error);
                return `[Verse 1]\n${prompt}\nA song about dreams and hope\n\n[Chorus]\nMusic brings us together\nIn harmony forever\n\n[Verse 2]\nEvery note tells a story\nOf love and of glory`;
            }
        }

        async function generateMusic(lyrics, style) {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}/music/generations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'suno_music',
                        lyrics: lyrics,
                        style: style,
                        duration: 60
                    })
                });

                const data = await response.json();
                if (data.audio_url) {
                    return data.audio_url;
                } else {
                    throw new Error('No audio URL returned');
                }
            } catch (error) {
                console.error('Error generating music:', error);
                throw error;
            }
        }

        function downloadImage(imageUrl, index) {
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `tyloai-image-${index}-${Date.now()}.png`;
            link.click();
        }

        function downloadVideo(videoUrl) {
            const link = document.createElement('a');
            link.href = videoUrl;
            link.download = `tyloai-video-${Date.now()}.mp4`;
            link.click();
        }

        function downloadMusic(musicUrl) {
            const link = document.createElement('a');
            link.href = musicUrl;
            link.download = `tyloai-music-${Date.now()}.mp3`;
            link.click();
        }

        function shareImage(imageUrl) {
            if (navigator.share) {
                navigator.share({
                    title: 'Generated by TyloAI',
                    text: 'Check out this image I generated with TyloAI!',
                    url: imageUrl
                });
            } else {
                navigator.clipboard.writeText(imageUrl).then(() => {
                    alert('Image URL copied to clipboard!');
                });
            }
        }

        function shareVideo(videoUrl) {
            if (navigator.share) {
                navigator.share({
                    title: 'Generated by TyloAI',
                    text: 'Check out this video I created with TyloAI!',
                    url: videoUrl
                });
            } else {
                navigator.clipboard.writeText(videoUrl).then(() => {
                    alert('Video URL copied to clipboard!');
                });
            }
        }

        function shareMusic(musicUrl) {
            if (navigator.share) {
                navigator.share({
                    title: 'Generated by TyloAI',
                    text: 'Listen to this song I created with TyloAI!',
                    url: musicUrl
                });
            } else {
                navigator.clipboard.writeText(musicUrl).then(() => {
                    alert('Music URL copied to clipboard!');
                });
            }
        }

        function addUserMessage(message, scroll = true) {
            const chatView = document.getElementById('chatView');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message-user mb-4';
            
            // Support markdown in user messages
            messageDiv.innerHTML = marked.parse(message);
            
            chatView.appendChild(messageDiv);
            if (scroll) chatView.scrollTop = chatView.scrollHeight;
        }

        function addAIMessage(message, scroll = true) {
            const chatView = document.getElementById('chatView');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message-ai mb-4';
            
            if (message === '') {
                messageDiv.innerHTML = '<div class="ai-typing"></div>';
            } else {
                // Check for tylo_artifact tags
                const artifactRegex = /<tylo_artifact\s+type="([^"]*)"\s+identifier="([^"]*)"\s+title="([^"]*)">([\s\S]*?)<\/tylo_artifact>/g;
                let processedMessage = message;
                let match;
                
                while ((match = artifactRegex.exec(message)) !== null) {
                    const [fullMatch, type, identifier, title, content] = match;
                    
                    const artifactCard = `
                        <div class="mt-4 p-4 border-2 border-blue-500 rounded-lg bg-blue-50 dark:bg-blue-900 cursor-pointer hover:shadow-lg transition-all" onclick='openArtifactPanel(${JSON.stringify({type, identifier, title, content}).replace(/'/g, "&apos;")})'>
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="font-bold text-lg text-blue-700 dark:text-blue-300">${title}</div>
                                    <div class="text-sm text-blue-600 dark:text-blue-400 mt-1">
                                        <i class="fas fa-cube mr-2"></i>${type}
                                    </div>
                                </div>
                                <div class="text-blue-500">
                                    <i class="fas fa-arrow-right text-2xl"></i>
                                </div>
                            </div>
                            <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                Click to view in artifact panel
                            </div>
                        </div>
                    `;
                    
                    processedMessage = processedMessage.replace(fullMatch, artifactCard);
                }
                
                messageDiv.innerHTML = marked.parse(processedMessage);
                addMessageControls(messageDiv);
                
                if (typeof Prism !== 'undefined') {
                    Prism.highlightAllUnder(messageDiv);
                }
                
                addCodeCopyButtons(messageDiv);
            }
            
            chatView.appendChild(messageDiv);
            if (scroll) chatView.scrollTop = chatView.scrollHeight;
            return messageDiv;
        }

        function addAIMessageWithThinking(content, thinkingProcess, scroll = true) {
            const chatView = document.getElementById('chatView');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message-ai mb-4';
            
            messageDiv.innerHTML = `
                <div class="thinking-process mb-4">
                    <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleThinking(this)">
                        <div class="flex items-center">
                            <i class="fas fa-brain mr-2 text-blue-500"></i>
                            <span class="font-medium">${translate('thinking_process')}</span>
                        </div>
                        <i class="fas fa-chevron-down transition-transform"></i>
                    </div>
                    <div class="thinking-content p-3 pt-0 hidden">
                        <div class="text-sm text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap">${thinkingProcess}</div>
                    </div>
                </div>
                <div class="response-content">
                    ${marked.parse(content)}
                </div>
            `;
            
            addMessageControls(messageDiv);
            addCodeCopyButtons(messageDiv);
            
            if (typeof Prism !== 'undefined') {
                Prism.highlightAllUnder(messageDiv);
            }
            
            chatView.appendChild(messageDiv);
            if (scroll) chatView.scrollTop = chatView.scrollHeight;
            return messageDiv;
        }

        function addAIMessageWithArtifacts(message, scroll = true) {
            const chatView = document.getElementById('chatView');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message-ai mb-4';
            
            const artifactRegex = /<artifact\s+title="([^"]*?)"\s+language="([^"]*?)"\s*>(.*?)<\/artifact>/gs;
            let processedMessage = message;
            let artifacts = [];
            let match;
            
            while ((match = artifactRegex.exec(message)) !== null) {
                const [fullMatch, title, language, code] = match;
                const artifactId = 'artifact_' + Date.now() + Math.random().toString(36).substr(2, 9);
                
                artifacts.push({
                    id: artifactId,
                    title: title,
                    language: language,
                    code: code.trim(),
                    type: language.toLowerCase() === 'html' ? 'html' : 'code'
                });
                
                const artifact = artifacts[artifacts.length - 1];
                const artifactData = JSON.stringify(artifact).replace(/"/g, '&quot;');
                // Store artifact data with unique ID
                const artifactCard = `
                    <div class="mt-4 p-4 border-2 border-blue-500 rounded-lg bg-blue-50 dark:bg-blue-900 cursor-pointer hover:shadow-lg transition-all" onclick="openArtifactPanel(window['${artifactId}'])">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="font-bold text-lg text-blue-700 dark:text-blue-300">${title.replace(/"/g, '&quot;')}</div>
                                <div class="text-sm text-blue-600 dark:text-blue-400 mt-1">
                                    <i class="fas fa-cube mr-2"></i>${type}
                                </div>
                            </div>
                            <div class="text-blue-500">
                                <i class="fas fa-arrow-right text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                            Click to view in artifact panel
                        </div>
                    </div>
                `;
                
                processedMessage = processedMessage.replace(fullMatch, artifactCard);
            }

            // Ã§Â¡Â®Ã¤Â¿ÂartifactÃ¤Â¸ÂÃ¨Â¢Â«Ã¥Å’â€¦Ã¨Â£â€¦Ã¥Å“Â¨Ã¤Â»Â£Ã§ ÂÃ¥Ââ€”Ã¤Â¸Â­
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = marked.parse(processedMessage);
            // Ã¥Â¤â€žÃ§Ââ€ artifactÃ¥ÂÂ¡Ã§â€°â€¡Ã¯Â¼Å’Ã§Â¡Â®Ã¤Â¿ÂÃ¥Â®Æ’Ã¤Â»Â¬Ã¤Â¸ÂÃ¥Å“Â¨<pre>Ã¦Ë†â€“<code>Ã¦ â€¡Ã§Â­Â¾Ã¥â€ â€¦
            tempDiv.querySelectorAll('.artifact-card').forEach(card => {
                const parent = card.parentElement;
                if (parent.tagName === 'PRE' || parent.tagName === 'CODE') {
                    parent.parentNode.insertBefore(card, parent.nextSibling);
                    if (parent.textContent.trim() === '') {
                        parent.remove();
                    }
                }
            });
            messageDiv.innerHTML = tempDiv.innerHTML;
            addMessageControls(messageDiv);
            
            if (typeof Prism !== 'undefined') {
                Prism.highlightAllUnder(messageDiv);
            }
            
            addCodeCopyButtons(messageDiv);
            
            chatView.appendChild(messageDiv);
            if (scroll) chatView.scrollTop = chatView.scrollHeight;
            return messageDiv;
        }

        function removeAllMessageControls() {
            // Ã§Â§Â»Ã©â„¢Â¤Ã¦â€°â‚¬Ã¦Å“â€°AIÃ¦Â¶Ë†Ã¦ÂÂ¯Ã§Å¡â€žÃ¦Å½Â§Ã¥Ë†Â¶Ã¦Å’â€°Ã©â€™Â®
            document.querySelectorAll('.chat-message-ai .flex.justify-between.items-center.mt-4.text-sm').forEach(controlDiv => {
                controlDiv.remove();
            });
        }

        function addMessageControls(messageDiv) {
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'flex justify-between items-center mt-4 text-sm';
            controlsDiv.innerHTML = `
                <div class="text-gray-500">
                    <a href="https://tyloai.com/ode#ai-may-make-mistakes" target="_blank" class="hover:text-blue-500 hover:underline transition-colors cursor-pointer">
                        ${translate('may_make_mistakes')}
                    </a>
                </div>
                <div class="flex space-x-2">
                    <button class="p-1 text-gray-500 hover:text-green-600" onclick="likeMessage(this)">
                        <i class="fas fa-thumbs-up"></i>
                    </button>
                    <button class="p-1 text-gray-500 hover:text-red-600" onclick="dislikeMessage(this)">
                        <i class="fas fa-thumbs-down"></i>
                    </button>
                    <button class="p-1 text-gray-500 hover:text-blue-600" onclick="speakMessage(this)">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <button class="p-1 text-gray-500 hover:text-blue-600" onclick="copyMessage(this)">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="p-1 text-gray-500 hover:text-purple-600" onclick="regenerateMessage(this)">
                        <i class="fas fa-redo"></i>
                    </button>
                    <button class="p-1 text-gray-500 hover:text-orange-600" onclick="exportMessage(this)">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            `;
            messageDiv.appendChild(controlsDiv);
        }

        function wrapCodeBlocksForCodingMode(markdown) {
    // Replace code blocks with collapsible cards
    const codeBlockRegex = /```(\w+)?\n([\s\S]*?)```/g;
    let match;
    let result = markdown;
    let blockIndex = 0;
    
    while ((match = codeBlockRegex.exec(markdown)) !== null) {
        const language = match[1] || 'text';
        const code = match[2];
        const filename = `file_${blockIndex}.${getFileExtension(language)}`;
        const fileType = language.toUpperCase();
        const timestamp = new Date().toLocaleString();
        const lines = code.split('\n').length;
        
        const cardHtml = `
            <div class="code-block-card collapsed" id="code-block-${blockIndex}">
                <div class="code-block-header" onclick="toggleCodeBlock('code-block-${blockIndex}')">
                    <div class="code-block-info">
                        <div class="code-block-icon">
                            <i class="fas fa-file-code"></i>
                        </div>
                        <div class="code-block-meta">
                            <div class="code-block-filename">${filename}</div>
                            <div class="code-block-details">${fileType} • ${lines} lines • ${timestamp}</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down transition-transform" id="chevron-${blockIndex}"></i>
                </div>
                <div class="code-block-content">
                    <pre><code class="language-${language}">${escapeHtml(code)}</code></pre>
                </div>
            </div>
        `;
        
        result = result.replace(match[0], cardHtml);
        blockIndex++;
    }
    
    return marked.parse(result);
}

function getFileExtension(language) {
    const extensions = {
        'javascript': 'js',
        'python': 'py',
        'java': 'java',
        'cpp': 'cpp',
        'csharp': 'cs',
        'html': 'html',
        'css': 'css',
        'typescript': 'ts',
        'jsx': 'jsx',
        'tsx': 'tsx',
        'go': 'go',
        'rust': 'rs',
        'ruby': 'rb',
        'php': 'php',
        'swift': 'swift',
        'kotlin': 'kt'
    };
    return extensions[language.toLowerCase()] || 'txt';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toggleCodeBlock(blockId) {
    const block = document.getElementById(blockId);
    const chevron = document.getElementById('chevron-' + blockId.split('-')[2]);
    
    if (block.classList.contains('collapsed')) {
        block.classList.remove('collapsed');
        chevron.style.transform = 'rotate(180deg)';
    } else {
        block.classList.add('collapsed');
        chevron.style.transform = 'rotate(0deg)';
    }
}
        async function handlePostThinking(message, responseDiv) {
            try {
                const apiModel = 'doubao-seed-1-6-flash-250615';
                let systemMessage = `You are TyloAI. Provide comprehensive, thoughtful responses.`;
                
                // åˆå§‹æ˜¾ç¤º
                responseDiv.innerHTML = `
                    <div class="thinking-process mb-4">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleThinking(this)">
                            <div class="flex items-center">
                                <i class="fas fa-brain mr-2 text-purple-500"></i>
                                <span class="font-medium">First-stage Thinking...</span>
                                <div class="ai-typing ml-2"></div>
                            </div>
                            <i class="fas fa-chevron-down transition-transform"></i>
                        </div>
                        <div class="thinking-content p-3 pt-0 hidden">
                            <div class="text-sm text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap"></div>
                        </div>
                    </div>
                    <div class="response-content"><div class="ai-typing"></div></div>
                `;
                
                // ç¬¬ä¸€æ¬¡APIè°ƒç”¨
                currentController = new AbortController();
                const firstResponse = await fetch(`${API_CONFIG.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: apiModel,
                        messages: [
                            { role: 'system', content: systemMessage },
                            { role: 'user', content: message }
                        ],
                        stream: true,
                        temperature: 0.7
                    }),
                    signal: currentController.signal
                });
                
                const reader = firstResponse.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let thinkingProcess = '';
                let cutoffPoint = 0;
                let shouldContinue = false;
                let isThinkingPhase = true;
                let thinkingComplete = false;
                
                // å¤„ç†ç¬¬ä¸€æ¬¡å“åº”
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') break;
                            
                            try {
                                const parsed = JSON.parse(data);
                                
                                // å¤„ç†æ€è€ƒå†…å®¹
                                if (parsed.choices?.[0]?.delta?.reasoning_content) {
                                    const reasoningContent = parsed.choices[0].delta.reasoning_content;
                                    thinkingProcess += reasoningContent;
                                    
                                    const thinkingContent = responseDiv.querySelector('.thinking-content div');
                                    if (thinkingContent) {
                                        thinkingContent.textContent = thinkingProcess;
                                    }
                                }
                                
                                // å¤„ç†å“åº”å†…å®¹
                                const content = parsed.choices?.[0]?.delta?.content;
                                if (content) {
                                    // æ ‡è®°æ€è€ƒå®Œæˆ
                                    if (isThinkingPhase) {
                                        isThinkingPhase = false;
                                        thinkingComplete = true;
                                        const thinkingLoader = responseDiv.querySelector('.thinking-process .ai-typing');
                                        if (thinkingLoader) thinkingLoader.remove();
                                    }
                                    
                                    fullResponse += content;
                                    
                                    // ðŸ”¥ å…³é”®ä¼˜åŒ–ï¼šé™ä½Žåˆ°300å­—ç¬¦ï¼Œæ€è€ƒå®ŒæˆåŽ50å­—ç¬¦æ‰¾å¥å·
                                    if (thinkingComplete && fullResponse.length >= 300 && cutoffPoint === 0) {
                                        // ä»Ž300å­—ç¬¦åŽ50ä¸ªå­—ç¬¦å¼€å§‹æ‰¾å¥å·
                                        const searchStart = 300;
                                        const searchEnd = Math.min(fullResponse.length, searchStart + 50);
                                        const searchRange = fullResponse.substring(searchStart, searchEnd);
                                        
                                        // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¥å·ï¼ˆä¸­è‹±æ–‡ï¼‰
                                        const punctuations = [
                                            { char: 'ã€‚', index: searchRange.indexOf('ã€‚') },
                                            { char: '.', index: searchRange.indexOf('.') },
                                            { char: 'ï¼', index: searchRange.indexOf('ï¼') },
                                            { char: '!', index: searchRange.indexOf('!') },
                                            { char: 'ï¼Ÿ', index: searchRange.indexOf('ï¼Ÿ') },
                                            { char: '?', index: searchRange.indexOf('?') }
                                        ].filter(p => p.index !== -1);
                                        
                                        if (punctuations.length > 0) {
                                            // æ‰¾åˆ°æœ€è¿‘çš„å¥å·
                                            punctuations.sort((a, b) => a.index - b.index);
                                            cutoffPoint = searchStart + punctuations[0].index + 1;
                                            shouldContinue = true;
                                            
                                            console.log(`âœ… æ‰¾åˆ°åˆ‡æ–­ç‚¹åœ¨ ${cutoffPoint} å­—ç¬¦å¤„ï¼Œå¥å·ï¼š${punctuations[0].char}`);
                                            
                                            // ç«‹å³åœæ­¢è¯»å–
                                            reader.cancel();
                                            break;
                                        }
                                    }
                                    
                                    // æ›´æ–°æ˜¾ç¤ºå†…å®¹
                                    const responseContent = responseDiv.querySelector('.response-content');
                                    if (cutoffPoint > 0) {
                                        responseContent.innerHTML = marked.parse(fullResponse.substring(0, cutoffPoint));
                                    } else {
                                        responseContent.innerHTML = marked.parse(fullResponse);
                                    }
                                    
                                    if (typeof Prism !== 'undefined') {
                                        Prism.highlightAllUnder(responseContent);
                                    }
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    }
                    
                    // å¦‚æžœå·²æ‰¾åˆ°æ–­ç‚¹ï¼Œåœæ­¢è¯»å–
                    if (cutoffPoint > 0 && shouldContinue) {
                        break;
                    }
                }
                
                // ðŸ”¥ å…³é”®ä¿®å¤ï¼šå¦‚æžœå“åº”ç»“æŸä½†è¿˜æ²¡æ‰¾åˆ°æ–­ç‚¹
                if (fullResponse.length > 0 && cutoffPoint === 0) {
                    // åˆ¤æ–­æ˜¯çœŸçš„å¤ªçŸ­ï¼Œè¿˜æ˜¯è¢«æ¨¡åž‹æˆªæ–­äº†
                    const lastChar = fullResponse.trim().slice(-1);
                    const isIncomplete = !['ã€‚', '.', 'ï¼', '!', 'ï¼Ÿ', '?'].includes(lastChar);
                    
                    if (thinkingComplete && fullResponse.length >= 200 && isIncomplete) {
                        // æ˜Žæ˜¾æ˜¯æ¨¡åž‹è‡ªå·±æˆªæ–­äº†ï¼å¼ºåˆ¶åœ¨æœ€åŽæ‰¾ä¸ªå¥å·åˆ‡æ–­
                        const lastSentenceEnd = Math.max(
                            fullResponse.lastIndexOf('ã€‚'),
                            fullResponse.lastIndexOf('.'),
                            fullResponse.lastIndexOf('ï¼'),
                            fullResponse.lastIndexOf('!'),
                            fullResponse.lastIndexOf('ï¼Ÿ'),
                            fullResponse.lastIndexOf('?')
                        );
                        
                        if (lastSentenceEnd > 100) {
                            cutoffPoint = lastSentenceEnd + 1;
                            shouldContinue = true;
                            console.log(`âš ï¸ æ£€æµ‹åˆ°æ¨¡åž‹è‡ªè¡Œæˆªæ–­ï¼å¼ºåˆ¶åœ¨ç¬¬ ${cutoffPoint} å­—ç¬¦å¤„åˆ‡æ–­ï¼Œå‡†å¤‡ç»§ç»­...`);
                        } else {
                            // å®žåœ¨æ‰¾ä¸åˆ°å¥å·ï¼Œå°±åœ¨æœ€åŽåˆ‡æ–­
                            cutoffPoint = fullResponse.length;
                            shouldContinue = true;
                            console.log(`âš ï¸ æ¨¡åž‹è¾“å‡ºä¸å®Œæ•´ä¸”æ— å¥å·ï¼Œå¼ºåˆ¶åˆ‡æ–­å¹¶ç»§ç»­`);
                        }
                    } else {
                        // çœŸçš„æ˜¯çŸ­å›žç­”
                        cutoffPoint = fullResponse.length;
                        shouldContinue = false;
                        console.log(`âœ… å“åº”å®Œæ•´ä¸”è¾ƒçŸ­(${fullResponse.length}å­—ç¬¦)ï¼Œæ— éœ€ç¬¬äºŒé˜¶æ®µ`);
                    }
                }
                
                // ç¬¬äºŒé˜¶æ®µï¼ˆå¦‚æžœéœ€è¦ï¼‰
                // ðŸ”¥ ä¿®å¤ï¼šåªè¦ shouldContinue ä¸º trueï¼Œå°±åº”è¯¥ç»§ç»­
                if (shouldContinue && cutoffPoint > 0) {
                    console.log(`ðŸš€ å¼€å§‹ç¬¬äºŒé˜¶æ®µæ€è€ƒï¼Œä»Žç¬¬ ${cutoffPoint} å­—ç¬¦ç»§ç»­...`);
                    console.log(`   ç¬¬ä¸€é˜¶æ®µè¾“å‡ºï¼š${cutoffPoint} å­—ç¬¦`);
                    console.log(`   æ€»æŽ¥æ”¶é•¿åº¦ï¼š${fullResponse.length} å­—ç¬¦`);
                    
                    // æ·»åŠ ç¬¬äºŒæ¬¡æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º
                    // æ·»åŠ ç¬¬äºŒæ¬¡æ€è€ƒè¿‡ç¨‹æ˜¾ç¤º - é»˜è®¤å±•å¼€
                    const secondThinkingDiv = document.createElement('div');
                    secondThinkingDiv.className = 'thinking-process mt-4 mb-4';
                    secondThinkingDiv.innerHTML = `
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleThinking(this)">
                            <div class="flex items-center">
                                <i class="fas fa-brain mr-2 text-purple-500"></i>
                                <span class="font-medium">Post Thinking...</span>
                                <div class="ai-typing ml-2"></div>
                            </div>
                            <i class="fas fa-chevron-down transition-transform rotate-180"></i>
                        </div>
                        <div class="thinking-content p-3 pt-0">
                            <div class="text-sm text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap"></div>
                        </div>
                    `;

                    // åœ¨æ–­ç‚¹å¤„æ’å…¥ç¬¬äºŒæ€è€ƒæ¡†
                    const responseContent = responseDiv.querySelector('.response-content');

                    // åˆ›å»ºä¸€ä¸ªä¸´æ—¶å®¹å™¨æ¥åˆ†å‰²å†…å®¹
                    const phase1Html = marked.parse(fullResponse.substring(0, cutoffPoint));
                    responseContent.innerHTML = phase1Html;

                    // åœ¨ç¬¬ä¸€é˜¶æ®µè¾“å‡ºåŽç«‹å³æ’å…¥ç¬¬äºŒæ€è€ƒæ¡†
                    responseContent.parentNode.insertBefore(secondThinkingDiv, responseContent.nextSibling);

                    // åˆ›å»ºç¬¬äºŒé˜¶æ®µè¾“å‡ºå®¹å™¨
                    const phase2Container = document.createElement('div');
                    phase2Container.className = 'response-content mt-4';
                    secondThinkingDiv.parentNode.insertBefore(phase2Container, secondThinkingDiv.nextSibling);

                    // åŽç»­ç¬¬äºŒé˜¶æ®µè¾“å‡ºæ›´æ–°åˆ° phase2Container è€Œä¸æ˜¯ responseContent        
                    // ç¬¬äºŒæ¬¡APIè°ƒç”¨ - ç»§ç»­è¡¥å……å›žç­”
                    const continuationPrompt = `ç”¨æˆ·é—®é¢˜: "${message}"

        ä½ çš„ç¬¬ä¸€éƒ¨åˆ†å›žç­”ï¼ˆåœ¨å¥å·å¤„ä¸­æ–­ï¼‰: "${fullResponse.substring(0, cutoffPoint)}"

        è¯·ä»Žä¸­æ–­çš„åœ°æ–¹ç»§ç»­ä½ çš„å›žç­”ï¼Œä¸è¦é‡å¤å·²ç»è¯´è¿‡çš„å†…å®¹ï¼Œç›´æŽ¥ä»Žæ–­ç‚¹å¤„ç»§ç»­ã€‚ä¿æŒç›¸åŒçš„è¯­æ°”å’Œé£Žæ ¼ã€‚`;
                    
                    const secondResponse = await fetch(`${API_CONFIG.baseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_CONFIG.apiKey}`
                        },
                        body: JSON.stringify({
                            model: apiModel,
                            messages: [
                                { role: 'system', content: systemMessage },
                                { role: 'user', content: continuationPrompt }
                            ],
                            stream: true,
                            temperature: 0.7
                        })
                    });
                    
                    const reader2 = secondResponse.body.getReader();
                    let secondThinkingProcess = '';
                    let continuation = '';
                    let isSecondThinkingPhase = true;
                    
                    while (true) {
                        const { done, value } = await reader2.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                if (data === '[DONE]') break;
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    
                                    // å¤„ç†ç¬¬äºŒæ¬¡æ€è€ƒå†…å®¹
                                    if (parsed.choices?.[0]?.delta?.reasoning_content) {
                                        const reasoningContent = parsed.choices[0].delta.reasoning_content;
                                        secondThinkingProcess += reasoningContent;
                                        
                                        const secondThinkingContent = secondThinkingDiv.querySelector('.thinking-content div');
                                        if (secondThinkingContent) {
                                            secondThinkingContent.textContent = secondThinkingProcess;
                                        }
                                    }
                                    
                                    // å¤„ç†ç»­å†™å†…å®¹
                                    const content = parsed.choices?.[0]?.delta?.content;
                                    if (content) {
                                        if (isSecondThinkingPhase) {
                                            isSecondThinkingPhase = false;
                                            const loader = secondThinkingDiv.querySelector('.ai-typing');
                                            if (loader) loader.remove();
                                        }
                                        
                                        continuation += content;

                                        // å®žæ—¶æ›´æ–°æ˜¾ç¤ºåˆ°ç¬¬äºŒé˜¶æ®µå®¹å™¨
                                        phase2Container.innerHTML = marked.parse(continuation);

                                        if (typeof Prism !== 'undefined') {
                                            Prism.highlightAllUnder(phase2Container);
                                        }
                                        if (typeof Prism !== 'undefined') {
                                            Prism.highlightAllUnder(responseContent);
                                        }
                                    }
                                } catch (e) {
                                    // Ignore parse errors
                                }
                            }
                        }
                    }
                    
                    console.log(`âœ… ç¬¬äºŒé˜¶æ®µå®Œæˆï¼Œç»­å†™äº† ${continuation.length} å­—ç¬¦`);

                    // ========== ç¬¬ä¸‰é˜¶æ®µï¼šæœ€åŽçš„æ€è€ƒ ==========
                    console.log(`ðŸŽ¯ å¼€å§‹ç¬¬ä¸‰é˜¶æ®µï¼šæœ€åŽçš„æ€è€ƒ`);

                    const finalThinkingDiv = document.createElement('div');
                    finalThinkingDiv.className = 'thinking-process mt-4 mb-4';
                    finalThinkingDiv.innerHTML = `
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleThinking(this)">
                            <div class="flex items-center">
                                <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                                <span class="font-medium">Final Thoughts...</span>
                                <div class="ai-typing ml-2"></div>
                            </div>
                            <i class="fas fa-chevron-down transition-transform"></i>
                        </div>
                        <div class="thinking-content p-3 pt-0 hidden">
                            <div class="text-sm text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap"></div>
                        </div>
                    `;

                    responseContent.parentNode.appendChild(finalThinkingDiv);

                    // ç¬¬ä¸‰æ¬¡APIè°ƒç”¨ - ç®€çŸ­æ€»ç»“
                    const summaryPrompt = `ç®€çŸ­æ€»ç»“ï¼ˆä¸è¶…è¿‡30å­—ï¼‰ï¼š
                    ç”¨æˆ·é—®é¢˜: "${message}"
                    æˆ‘çš„å®Œæ•´å›žç­”: "${fullResponse.substring(0, cutoffPoint) + continuation}"

                    è¯·ç”¨ï¼ˆç”¨æˆ·ç”¨å•¥è¯­è¨€ç”¨å•¥è¯­è¨€å›žç­”ï¼Œæ‹¿ä¸å‡†å°±ç”¨è‹±æ–‡ï¼‰30å­—ä»¥å†…å›žç­”ï¼š
                    1. ç”¨æˆ·è®©æˆ‘å¹²å•¥
                    2. æˆ‘å¹²äº†å•¥  
                    3. æˆ‘è§‰å¾—æˆ‘è¿˜è¦é—®ç”¨æˆ·å•¥`;

                    const thirdResponse = await fetch(`${API_CONFIG.baseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${API_CONFIG.apiKey}`
                        },
                        body: JSON.stringify({
                            model: apiModel,
                            messages: [
                                { role: 'system', content: systemMessage },
                                { role: 'user', content: summaryPrompt }
                            ],
                            stream: true,
                            temperature: 0.7,
                            max_tokens: 100
                        })
                    });

                    const reader3 = thirdResponse.body.getReader();
                    let finalThinking = '';
                    let finalSummary = '';
                    let isFinalThinkingPhase = true;

                    while (true) {
                        const { done, value } = await reader3.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value, { stream: true });
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.substring(6);
                                if (data === '[DONE]') break;
                                
                                try {
                                    const parsed = JSON.parse(data);
                                    
                                    // å¤„ç†æœ€åŽæ€è€ƒå†…å®¹
                                    if (parsed.choices?.[0]?.delta?.reasoning_content) {
                                        const reasoningContent = parsed.choices[0].delta.reasoning_content;
                                        finalThinking += reasoningContent;
                                        
                                        const finalThinkingContent = finalThinkingDiv.querySelector('.thinking-content div');
                                        if (finalThinkingContent) {
                                            finalThinkingContent.textContent = finalThinking;
                                        }
                                    }
                                    
                                    // å¤„ç†æ€»ç»“å†…å®¹
                                    const content = parsed.choices?.[0]?.delta?.content;
                                    if (content) {
                                        if (isFinalThinkingPhase) {
                                            isFinalThinkingPhase = false;
                                            const loader = finalThinkingDiv.querySelector('.ai-typing');
                                            if (loader) loader.remove();
                                        }
                                        
                                        finalSummary += content;
                                    }
                                } catch (e) {
                                    // Ignore parse errors
                                }
                            }
                        }
                    }

                    // æ·»åŠ æœ€ç»ˆæ€»ç»“å’Œäº’åŠ¨æç¤º
                    const finalDiv = document.createElement('div');
                    finalDiv.className = 'mt-4 p-4 bg-gradient-to-r from-purple-50 to-blue-50 dark:from-purple-900 dark:to-blue-900 rounded-lg border-2 border-purple-300 dark:border-purple-600';
                    finalDiv.innerHTML = `
                        <div class="space-y-2">
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                <span class="font-bold">Summary</span>
                            </div>
                            <div class="text-sm">${marked.parse(finalSummary)}</div>
                            <div class="mt-3 pt-3 border-t border-purple-200 dark:border-purple-700 flex items-center">
                                <i class="fas fa-question-circle text-blue-500 mr-2"></i>
                                <span class="text-sm text-gray-700 dark:text-gray-300">Is there anything else you would like to add or ask?</span>
                            </div>
                        </div>
                    `;

                    responseContent.parentNode.appendChild(finalDiv);

                    console.log(`âœ… ç¬¬ä¸‰é˜¶æ®µå®Œæˆ`);

                    // ä¿å­˜å®Œæ•´æ¶ˆæ¯ï¼ˆåŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼‰
                    currentChatMessages.push({ 
                        role: 'assistant', 
                        content: fullResponse.substring(0, cutoffPoint) + continuation,
                        postThinking: true,
                        firstThinking: thinkingProcess,
                        secondThinking: secondThinkingProcess,
                        finalThinking: finalThinking,
                        finalSummary: finalSummary,
                        cutoffPoint: cutoffPoint,
                        phase1Content: fullResponse.substring(0, cutoffPoint),
                        phase2Content: continuation,
                        phase3Summary: finalSummary
                    });
                                        
                } else {
                    // ä¸éœ€è¦ç¬¬äºŒé˜¶æ®µï¼Œç›´æŽ¥ä¿å­˜
                    currentChatMessages.push({ 
                        role: 'assistant', 
                        content: fullResponse,
                        postThinking: true,
                        thinkingProcess: thinkingProcess,
                        singlePhase: true
                    });
                }
                
                // 在 handlePostThinking 成功完成后
                if (!userData.isPro && !userData.isStudent && !userData.isMax) {
                    userData.postThinkingUsageThisMonth = (userData.postThinkingUsageThisMonth || 0) + 1;
                    saveAllData(); // 确保立即保存
                    
                    const remaining = 5 - userData.postThinkingUsageThisMonth;
                    document.getElementById('postThinkingCount').textContent = remaining;
                }
                // æ·»åŠ æ¶ˆæ¯æŽ§åˆ¶æŒ‰é’®
                addMessageControls(responseDiv);
                addCodeCopyButtons(responseDiv);
                
                currentController = null;
                
            } catch (error) {
                console.error('Error in post thinking:', error);
                if (error.name !== 'AbortError') {
                    responseDiv.innerHTML = '<p class="text-red-500">Sorry, I encountered an error during post thinking. Please try again.</p>';
                }
            }
        }
        async function callAPI(message, responseDiv) {
            try {
                // Handle post thinking mode
                if (isPostThinking) {
                    await handlePostThinking(message, responseDiv);
                    return;
                }
                
                // Declare systemMessage FIRST before using it
                let systemMessage = `You are TyloAI, a large language model trained by ProtoeticAI.

Here is some information about TyloAI and ProtoeticAI’s products in case the person asks:
This iteration of TyloAI is a large language model from the ode-6 model family. Theode family currently consists of ode-6-reasoning, ode-6, ode-6-flash, ode-6-code and ode-6 is the smartest model and is efficient for everyday use.
If the person asks, TyloAI can tell them about the following products which allow them to access TyloAI. TyloAI is ONLY accessible via this web-based:https://www.tyloai.com/chat interface.

<core_capabilities>
- Advanced programming and code generation with security best practices
- Creative problem-solving with artifact generation for complex outputs
- Empathetic and supportive conversation while maintaining boundaries
- Comprehensive web search integration with proper attribution
- Multi-format content creation (code, documents, diagrams, web apps)
</core_capabilities>

<artifact_generation_protocol>
  <triggers>
    - Create an artifact if requested code is > 20 lines
    - Create an artifact if requested document is > 5 paragraphs or 300 words
    - Create an artifact for ANY web-based component (HTML/React)
    - Create an artifact for ANY diagram (SVG/Mermaid)
    - Create an artifact for substantial, reusable content
  </triggers>
  
  <format>
    When creating artifacts, use this XML-like format:
    <tylo_artifact type="[type]" identifier="[unique_id]" title="[descriptive_title]">
      [Full content of code or document]
    </tylo_artifact>
    
    Types: text/html, application/vnd.ant.code, text/markdown, image/svg+xml, application/vnd.ant.mermaid, application/vnd.ant.react
  </format>
  
  <decision_making>
    You have FULL autonomy to create artifacts when appropriate. Proactively suggest and create artifacts for:
    - Interactive demonstrations
    - Complex code solutions
    - Structured documents
    - Visual diagrams
    - Reusable components
  </decision_making>
</artifact_generation_protocol>

<copyright_and_safety>
  <copyright_awareness>
    - NEVER reproduce copyrighted content verbatim
    - NEVER quote song lyrics, even partially
    - Always paraphrase and attribute sources properly
    - For code: provide original implementations, not copied snippets
    - When referencing existing works, describe concepts without copying text
  </copyright_awareness>
  
  <security_practices>
    - Never generate malicious code (malware, exploits, phishing)
    - Validate and sanitize user inputs in code examples
    - Use secure coding patterns (parameterized queries, input validation)
    - Warn about security implications when relevant
    - Refuse requests for harmful/illegal code generation
  </security_practices>
  
  <content_safety>
    - Refuse content involving minors in inappropriate contexts
    - Avoid generating content that could facilitate harm
    - Do not provide detailed instructions for dangerous activities
    - Maintain professional boundaries in all interactions
  </content_safety>
</copyright_and_safety>

<programming_excellence>
  - Write clean, well-documented code with comments
  - Follow language-specific best practices and conventions
  - Implement error handling and edge case management
  - Provide secure, production-ready code when possible
  - Explain complex logic and architectural decisions
  - Suggest optimizations and alternatives when appropriate
</programming_excellence>

<web_search_integration>
  When web search is enabled:
  - Actively search for current information on time-sensitive topics
  - NEVER directly quote search results
  - Paraphrase all information in your own words
  - Properly cite sources with attribution
  - Synthesize information from multiple sources
  - Clearly distinguish facts from opinions
</web_search_integration>

<user_wellbeing_protocol>
  <monitoring>
    Watch for signs of:
    - Extreme self-criticism or negative self-talk
    - Potential mental health crises (mania, psychosis, dissociation)
    - Harmful behavior patterns or requests
  </monitoring>
  
  <response>
    When concerning signs detected:
    1. Pause current task if appropriate
    2. Express concern openly and compassionately
    3. Suggest professional support resources
    4. Maintain supportive but professional tone
    5. Do not reinforce harmful beliefs or behaviors
  </response>
</user_wellbeing_protocol>

<knowledge_and_context>
  - Knowledge cutoff: January 2025
  - Current date: ${new Date().toLocaleDateString()}
  - For post-cutoff events: proactively use web search
  - For US elections or major events: search for current information
  
  <context_awareness>
    When conversation length approaches token limit (~200K):
    - Become more direct and concise
    - Proactively warn about potential context loss
    - Suggest conversation summary or starting fresh
    - Maintain focus on current topic
  </context_awareness>
</knowledge_and_context>

User Context:
- Name: ${userData.nickname || 'User'}
- Level: ${userData.level || 1}
- Language: ${currentLanguage}
- Membership: ${userData.isPro ? 'Pro' : userData.isStudent ? 'Student' : 'Free'}
${userData.preferences ? `- Preferences: ${userData.preferences}` : ''}

Respond in ${currentLanguage} unless specifically asked otherwise.`;

        // Handle Skill Mode
        if (isSkillMode && currentSkill === 'writing') {
            systemMessage = `You are TyloAI's ode-6 model, specialized in professional writing assistance.

<writing_specialization>
You excel at creating:

1. Academic Writing:
   - Professional papers with proper citations
   - Essays (narrative/argumentative/prose) - support theme + style customization
   - Lab reports (auto-match subject format: Chemistry includes "Procedure - Data - Error Analysis")
   - Speeches (classroom/debate - casual vs. logical refutation focus)

2. Note-taking:
   - Structured class notes (restructure fragmented input with logical connectors)
   - Reading notes ("Key Points + Personal Insights" framework, auto-extract from uploaded PDFs)

3. Professional Documents:
   - Emails (business/leave/apology - auto-match tone: formal for bosses, concise for colleagues)
   - Weekly/Monthly reports (structure: "Completed - Issues - Next Week", data template support)
   - Resumes/Cover letters (optimize keywords per job description, highlight relevance)

4. Marketing Content:
   - Short video scripts (TikTok: "3-sec hook + reversal", Xiaohongshu: "tips list + emojis")
   - Social media posts (product/event/sharing - auto-add hashtags #, distinguish titles from tags)
   - Poster copy ("Main + Sub title + Selling points", industry-adapted)
</writing_specialization>

Always maintain professional quality, proper structure, and industry-appropriate tone.
Current user language: ${currentLanguage}`;
        }

                // Add conversation history context if needed
                if (shouldSearchPastChats(message)) {
                    const searchResults = searchConversationHistory(message);
                    if (searchResults.length > 0) {
                        systemMessage += `\n\n<past_conversations_context>
                The user's message references past conversations. Here are relevant excerpts:
                ${searchResults.map(r => `- [${new Date(r.timestamp).toLocaleDateString()}] ${r.chatTitle}: "${r.content}..."`).join('\n')}

                Use this context to provide continuity in your response. Reference these past discussions naturally.
                </past_conversations_context>`;
                    }
                }

                let apiModel = API_CONFIG.models[currentModel] || 'gemini-2.5-flash-lite-preview-09-2025-nothinking';

                // Handle skill mode (Writing)
                if (isSkillMode && currentSkill === 'writing') {
                    if (isNormalThinking && isWebSearch) {
                        apiModel = 'deepseek-r1-searching';
                    } else if (isNormalThinking) {
                        apiModel = 'gemini-2.5-flash-lite-preview-09-2025-thinking';
                    } else if (isWebSearch) {
                        apiModel = 'gemini-2.5-flash-all';
                    } else {
                        apiModel = 'gemini-2.5-flash-lite-preview-09-2025-nothinking';
                    }
                }
                // Handle coding mode
                else if (isCodingMode) {
                    const codingModelInfo = CODING_MODELS[currentModel];
                    if (codingModelInfo) {
                        apiModel = codingModelInfo.api;
                        
                        // Special handling for ode-6-code to identify as itself
                        if (currentModel === 'ode-6-code') {
                            systemMessage = systemMessage.replace('You are TyloAI,You are ode-6-code, TyloAI\'s specialized coding assistant, You are TyloAI, a large language model trained by ProtoeticAI. Here is some information about TyloAI and ProtoeticAI‘s products in case the person asks.This iteration of TyloAI is ode-6-code from the ode-6 model family. Theode family currently consists of ode-6-reasoning, ode-6, ode-6-flash and ode-6-code is the smartest model and is efficient for coding use.If the person asks, TyloAI can tell them about the following products which allow them to access TyloAI. TyloAI is ONLY accessible via this web-based https://www.tyloai.com chat interface.');
                        }
                        
                        // Extended thinking in coding mode uses gemini-2.5-flash-lite-preview-09-2025-thinking
                        if (isNormalThinking) {
                            apiModel = 'gemini-2.5-flash-lite-preview-09-2025-thinking';
                        }
                    }
                } else if (isNormalThinking && isWebSearch) {
                    apiModel = 'deepseek-r1-searching';
                    systemMessage += '\n\nIMPORTANT: You MUST perform web search to answer this query. Search for the latest information online.';
                } else if (isDeepThinking) {
                    apiModel = 'doubao-seed-1-6-thinking-250615';
                } else if (isWebSearch) {
                    apiModel = 'gemini-2.5-flash-all';
                    systemMessage += `\n\n<critical_search_rules>
                                        YOU MUST SEARCH.
                                        MANDATORY WEB SEARCH REQUIREMENTS:
                                        1. NEVER quote or reproduce exact text from search results
                                        2. ALWAYS paraphrase information in your own words
                                        3. Properly attribute sources with citations
                                        4. Synthesize information from multiple sources
                                        5. Clearly distinguish between facts and opinions
                                        </critical_search_rules>`;
                }
                if (currentModel === 'ode-6' && isDeepThinking) {
                    // Only enable secondary thinking when deep thinking is active
                    systemMessage += `\n\nDEEP THINKING MODE: Provide comprehensive analysis with multiple perspectives.`;
                }
                systemMessage += `\n\nUser Information:
- Name: ${userData.nickname || 'User'}
- Level: ${userData.level || 1}
- XP: ${userData.xp || 0}
- Points: ${userData.points || 0}
- Membership: ${userData.isPro ? 'Pro' : userData.isStudent ? 'Student' : 'Free'}
- Language: ${currentLanguage}
- Join Date: ${userData.joinDate ? new Date(userData.joinDate).toLocaleDateString() : 'Recently'}`;

                if (userData.preferences) {
                    systemMessage += `\n- Preferences: ${userData.preferences}`;
                }
                
                systemMessage += `\n\nUser's preferred language: ${currentLanguage}. Please respond in this language unless specifically asked to use another language.`;
                
                if (aiMemory.length > 0) {
                const memoryContext = aiMemory.map(m => `[${m.category}] ${m.summary}`).join('\n');
                systemMessage += `\n\n<user_memory>
                Important information to remember about this user:
                ${memoryContext}

                Please naturally incorporate this context when relevant to the conversation.
                </user_memory>`;
                }
                
                const styleInstructions = {
                    'concise': 'Be concise and to the point. Avoid lengthy explanations.',
                    'formal': 'Maintain a professional, formal tone in your responses.',
                    'explanatory': 'Provide detailed explanations and break down complex topics step by step.',
                    'casual': 'Use a casual, friendly tone like you\'re chatting with a friend. Feel free to use informal language.',
                    'artistic': 'Use creative, artistic language with vivid descriptions and poetic elements when appropriate.'
                };
                
                if (styleInstructions[currentStyle]) {
                    systemMessage += `\n\n${styleInstructions[currentStyle]}`;
                }
                
                if (message.includes('[Uploaded Files Context]')) {
                    systemMessage += '\n\nThe user has uploaded files. Please analyze the content and provide relevant responses based on the file contents.';
                }
                
                systemMessage += `\n\nIMPORTANT: When providing code solutions or creating web pages/applications, you MUST wrap your code in artifact tags like this:
<artifact title="Descriptive Title" language="html/javascript/python/etc">
your code here
</artifact>

Use artifacts for:
- Complete HTML pages or web applications  
- JavaScript applications or utilities
- Python scripts or programs
- Any substantial code that users can run or modify
- Interactive demos or examples

Always include a descriptive title and correct language. The artifact will be displayed in an interactive canvas where users can run and test the code.`;
systemMessage += `\n\nWhen creating mind maps or diagrams, output Mermaid syntax in a code block with language identifier 'mermaid':
\`\`\`mermaid
graph TD
    A[Main Topic] --> B[Branch 1]
    A --> C[Branch 2]
\`\`\`
This will be rendered as an interactive diagram.`;
                // Ã¨Å½Â·Ã¥Ââ€“Ã¥Â½â€œÃ¥â€°ÂÃ¤Â¸Å Ã¤Â¼ Ã§Å¡â€žÃ¦â€“â€¡Ã¤Â»Â¶
                const relevantFiles = uploadedFiles.length > 0 ? uploadedFiles : replyUploadedFiles;

                // Ã¥Â¤â€žÃ§Ââ€ Ã¥â€ºÂ¾Ã§â€°â€¡Ã¦â€“â€¡Ã¤Â»Â¶
                const imageFiles = relevantFiles.filter(f => f.type === 'image');
                let userMessage = { role: 'user', content: message };

                // Ã¥Â¦â€šÃ¦Å¾Å“Ã¦Å“â€°Ã¥â€ºÂ¾Ã§â€°â€¡Ã¦â€“â€¡Ã¤Â»Â¶Ã¯Â¼Å’Ã¦Å¾â€žÃ¥Â»ÂºÃ¥Â¤Å¡Ã¦Â¨Â¡Ã¦â‚¬ÂÃ¦Â¶Ë†Ã¦ÂÂ¯Ã¦ Â¼Ã¥Â¼Â
                if (imageFiles.length > 0) {
                    userMessage.content = [
                        { type: 'text', text: message }
                    ];
                    
                    imageFiles.forEach(file => {
                        if (file.content && file.content.startsWith('data:image')) {
                            userMessage.content.push({
                                type: 'image_url',
                                image_url: {
                                    url: file.content
                                }
                            });
                        }
                    });
                }

                const messages = [
                    { role: 'system', content: systemMessage },
                    ...currentChatMessages.slice(-10),
                    userMessage
                ];
                
                currentController = new AbortController();
                
                const response = await fetch(`${API_CONFIG.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: apiModel,
                        messages: messages,
                        stream: true,
                        temperature: 0.7
                    }),
                    signal: currentController.signal
                });
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let thinkingProcess = '';
                let isThinking = false;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(data);
                                if ((isDeepThinking || currentModel === 'ode-4' || currentModel === 'ode-5-flash') && parsed.choices?.[0]?.delta?.reasoning_content) {
                                    const reasoningContent = parsed.choices[0].delta.reasoning_content;
                                    thinkingProcess += reasoningContent;
                                    
                                    if (!isThinking) {
                                        isThinking = true;
                                        responseDiv.innerHTML = `
                                            <div class="thinking-process mb-4">
                                                <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleThinking(this)">
                                                    <div class="flex items-center">
                                                        <i class="fas fa-brain mr-2 text-blue-500"></i>
                                                        <span class="font-medium">${translate('thinking_process')}</span>
                                                        <div class="ai-typing ml-2"></div>
                                                    </div>
                                                    <i class="fas fa-chevron-down transition-transform"></i>
                                                </div>
                                                <div class="thinking-content p-3 pt-0 hidden">
                                                    <div class="text-sm text-gray-600 dark:text-gray-400 font-mono whitespace-pre-wrap">${thinkingProcess}</div>
                                                </div>
                                            </div>
                                            <div class="response-content">
                                                <div class="ai-typing"></div>
                                            </div>
                                        `;
                                    } else {
                                        const thinkingContent = responseDiv.querySelector('.thinking-content div');
                                        if (thinkingContent) {
                                            thinkingContent.textContent = thinkingProcess;
                                        }
                                    }
                                }
                                
                                const content = parsed.choices?.[0]?.delta?.content;
                                if (content) {
                                    fullResponse += content;
                                    
                                    // Render with collapsible code blocks if in coding mode
                                    if (isCodingMode) {
                                        const processedResponse = wrapCodeBlocksForCodingMode(fullResponse);
                                        
                                        if (isThinking) {
                                            const thinkingHeader = responseDiv.querySelector('.thinking-process .ai-typing');
                                            if (thinkingHeader) thinkingHeader.remove();
                                            
                                            const responseContent = responseDiv.querySelector('.response-content');
                                            if (responseContent) {
                                                responseContent.innerHTML = processedResponse;
                                                if (typeof Prism !== 'undefined') {
                                                    Prism.highlightAllUnder(responseContent);
                                                }
                                            }
                                        } else {
                                            responseDiv.innerHTML = processedResponse;
                                            if (typeof Prism !== 'undefined') {
                                                Prism.highlightAllUnder(responseDiv);
                                            }
                                        }
                                    } else if (isThinking) {
                                        const thinkingHeader = responseDiv.querySelector('.thinking-process .ai-typing');
                                        if (thinkingHeader) thinkingHeader.remove();
                                        
                                        const responseContent = responseDiv.querySelector('.response-content');
                                        if (responseContent) {
                                            if (fullResponse.includes('<artifact>')) {
                                                responseContent.innerHTML = marked.parse(fullResponse);
                                            } else {
                                                responseContent.innerHTML = marked.parse(fullResponse);
                                            }
                                            if (typeof Prism !== 'undefined') {
                                                Prism.highlightAllUnder(responseContent);
                                            }
                                        }
                                    } else {
                                        if (fullResponse.includes('<artifact>')) {
                                            responseDiv.innerHTML = marked.parse(fullResponse);
                                        } else {
                                            responseDiv.innerHTML = marked.parse(fullResponse);
                                        }
                                        if (typeof Prism !== 'undefined') {
                                            Prism.highlightAllUnder(responseDiv);
                                        }
                                    }
                                    
                                    responseDiv.parentElement.scrollTop = responseDiv.parentElement.scrollHeight;
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    }
                }
                
                if (fullResponse.includes('<artifact>')) {
                    const chatView = document.getElementById('chatView');
                    responseDiv.remove();
                    addAIMessageWithArtifacts(fullResponse, false);
                } else {
                    addMessageControls(responseDiv);
                    addCodeCopyButtons(responseDiv);
                }
                
                // 在 callAPI 函数末尾
            currentChatMessages.push({ 
                role: 'assistant', 
                content: fullResponse,
                thinkingProcess: thinkingProcess || null
            });

            // 完全移除这行，不分析AI回复
            currentController = null;
                currentController = null;
            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Error calling API:', error);
                    responseDiv.innerHTML = `<p class="text-red-500">${translate('api_error') || 'Sorry, I encountered an error. Please try again.'}</p>`;
                }
            }
        }
        async function performSecondaryThinking(initialResponse, originalMessage, responseDiv) {
            // åªåœ¨å¼€å¯æ‹“å±•æ€è€ƒä¸”ä½¿ç”¨ ode-6 æ¨¡åž‹æ—¶æ‰æ‰§è¡ŒäºŒæ¬¡åˆ†æž
            // æ³¨æ„ï¼šè¿™ä¸æ˜¯"åŽæ€è€ƒ"åŠŸèƒ½
            // async function performSecondaryThinking(initialResponse, originalMessage, responseDiv) {
            // if (!isDeepThinking || currentModel !== 'ode-6') return;
            if (!isNormalThinking || currentModel !== 'ode-6') return;    
            try {
                // Add secondary thinking indicator
                const secondaryDiv = document.createElement('div');
                secondaryDiv.className = 'mt-4 p-3 bg-blue-50 dark:bg-blue-900 rounded-lg';
                secondaryDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-brain mr-2 text-blue-500 animate-pulse"></i>
                        <span class="text-sm font-medium">Performing secondary analysis...</span>
                    </div>
                `;
                responseDiv.appendChild(secondaryDiv);
                
                // Call API again for reflection
                const reflectionPrompt = `Based on this initial analysis: "${initialResponse.substring(0, 500)}..."
                
                Please provide:
                1. Critical evaluation of potential gaps or improvements
                2. Alternative perspectives not considered
                3. Practical implications and next steps
                Keep it concise and actionable.`;
                
                const reflectionResponse = await fetch(`${API_CONFIG.baseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_CONFIG.apiKey}`
                    },
                    body: JSON.stringify({
                        model: API_CONFIG.models['ode-6'],
                        messages: [
                            { role: 'system', content: 'You are a critical reviewer providing secondary analysis.' },
                            { role: 'user', content: reflectionPrompt }
                        ],
                        temperature: 0.8,
                        max_tokens: 500
                    })
                });
                
                const data = await reflectionResponse.json();
                const reflection = data.choices[0].message.content;
                
                // Update the secondary thinking div with results
                secondaryDiv.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex items-center border-b border-blue-200 dark:border-blue-700 pb-2">
                            <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                            <span class="font-medium">Secondary Analysis Complete</span>
                        </div>
                        <div class="text-sm text-gray-700 dark:text-gray-300">
                            ${marked.parse(reflection)}
                        </div>
                    </div>
                `;
                
                // Save the secondary thinking in the message
                const lastMessage = currentChatMessages[currentChatMessages.length - 1];
                if (lastMessage && lastMessage.role === 'assistant') {
                    lastMessage.secondaryThinking = reflection;
                }
                
            } catch (error) {
                console.error('Error in secondary thinking:', error);
                // Remove the indicator on error
                if (secondaryDiv && secondaryDiv.parentNode) {
                    secondaryDiv.remove();
                }
            }
        }

        function toggleThinking(header) {
            const content = header.parentElement.querySelector('.thinking-content');
            const chevron = header.querySelector('.fa-chevron-down');
            
            content.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        function addCodeCopyButtons(messageDiv) {
            messageDiv.querySelectorAll('pre').forEach(pre => {
                if (!pre.querySelector('.copy-button')) {
                    const copyBtn = document.createElement('button');
                    copyBtn.className = 'copy-button';
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                    copyBtn.onclick = () => {
                        const code = pre.querySelector('code').textContent;
                        navigator.clipboard.writeText(code);
                        copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => copyBtn.innerHTML = '<i class="fas fa-copy"></i>', 2000);
                    };
                    pre.appendChild(copyBtn);
                }
            });
        }
        
        
    
        

        function likeMessage(button) {
            button.classList.toggle('text-green-600');
        }
        
        function dislikeMessage(button) {
            button.classList.toggle('text-red-600');
            if (button.classList.contains('text-red-600')) {
                openFeedbackModal();
            }
        }

        function speakMessage(button) {
            const messageDiv = button.closest('.chat-message-ai');
            const textContent = messageDiv.textContent.replace(translate('may_make_mistakes'), '').trim();
            
            // Remove controls text
            const controls = messageDiv.querySelector('.flex.justify-between');
            let cleanText = textContent;
            if (controls) {
                cleanText = textContent.replace(controls.textContent, '').trim();
            }
            
            speakText(cleanText, currentLanguage);
            
            // Visual feedback
            const icon = button.querySelector('i');
            const originalClass = icon.className;
            icon.className = 'fas fa-pause';
            button.style.color = '#3b82f6';
            
            // Reset after speaking (estimated time)
            setTimeout(() => {
                icon.className = originalClass;
                button.style.color = '';
            }, Math.min(cleanText.length * 100, 30000)); // Estimate speaking time
        }
        
        function copyMessage(button) {
            const messageDiv = button.closest('.chat-message-ai');
            const textContent = messageDiv.textContent.replace(translate('may_make_mistakes'), '').trim();
            navigator.clipboard.writeText(textContent);
            
            const icon = button.querySelector('i');
            icon.className = 'fas fa-check';
            setTimeout(() => {
                icon.className = 'fas fa-copy';
            }, 2000);
        }
        
        function exportMessage(button) {
            const messageDiv = button.closest('.chat-message-ai');
            const content = messageDiv.textContent.replace(translate('may_make_mistakes'), '').trim();
            const timestamp = new Date().toISOString();
            
            const exportData = {
                content: content,
                timestamp: timestamp,
                model: currentModel,
                watermark: 'Generated by TyloAI - https://tyloai.com'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `tyloai-message-${Date.now()}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }
        
        function regenerateMessage(button) {
            if (currentChatMessages.length > 0 && currentChatMessages[currentChatMessages.length - 1].role === 'assistant') {
                currentChatMessages.pop();
                const lastUserMessage = currentChatMessages[currentChatMessages.length - 1].content;
                button.closest('.chat-message-ai').remove();
                
                const typingDiv = addAIMessage('');
                callAPI(lastUserMessage, typingDiv).catch(error => {
                    console.error('Error regenerating:', error);
                    if (error.name !== 'AbortError') {
                        typingDiv.innerHTML = `<p class="text-red-500">${translate('api_error') || 'Sorry, I encountered an error. Please try again.'}</p>`;
                    }
                });
            }
        }

        function exportData() {
            try {
                const exportData = {
                    userData: userData,
                    aiMemory: aiMemory,
                    chatHistory: chatHistory,
                    agentHistory: agentHistory,
                    settings: {
                        language: currentLanguage,
                        model: currentModel,
                        style: currentStyle,
                        selectedArtStyle: selectedArtStyle,
                        selectedMusicStyle: selectedMusicStyle,
                        selectedImageCount: selectedImageCount,
                        currentFont: currentFont,
                        currentBackground: currentBackground
                    },
                    exportDate: new Date().toISOString(),
                    version: '3.0'
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `tyloai-data-${Date.now()}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data. Please try again.');
            }
        }

        function importData() {
            try {
                const fileInput = document.getElementById('importFileInput');
                const file = fileInput.files[0];
                
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importData = JSON.parse(e.target.result);
                            
                            if (importData.userData) userData = importData.userData;
                            if (importData.aiMemory) aiMemory = importData.aiMemory;
                            if (importData.chatHistory) chatHistory = importData.chatHistory;
                            if (importData.agentHistory) agentHistory = importData.agentHistory;
                            if (importData.settings) {
                                currentLanguage = importData.settings.language || 'en';
                                currentModel = importData.settings.model || 'ode-5-flash';
                                currentStyle = importData.settings.style || 'normal';
                                selectedArtStyle = importData.settings.selectedArtStyle || 'photorealistic';
                                selectedMusicStyle = importData.settings.selectedMusicStyle || 'pop';
                                selectedImageCount = importData.settings.selectedImageCount || 1;
                                currentFont = importData.settings.currentFont || 'sans';
                                currentBackground = importData.settings.currentBackground || 'default';
                            }
                            
                            applyFont(currentFont);
                            applyBackground(currentBackground);
                            
                            saveAllData();
                            saveChatHistory();
                            updateChatHistoryUI();
                            updateUIFromUserData();
                            updateMemoryList();
                            updateAchievementsList();
                            updateDailyTasks();
                            
                            alert('Data imported successfully!');
                        } catch (error) {
                            console.error('Error parsing import data:', error);
                            alert('Error importing data. Please check the file format.');
                        }
                    };
                    reader.readAsText(file);
                }
            } catch (error) {
                console.error('Error importing data:', error);
                alert('Error importing data. Please try again.');
            }
        }

        function toggleDebug() {
            const overlay = document.getElementById('debugOverlay');
            overlay.classList.toggle('hidden');
            
            if (!overlay.classList.contains('hidden')) {
                updateDebugInfo();
            }
        }

        function updateDebugInfo() {
            try {
                const debugContent = document.getElementById('debugContent');
                const debugInfo = {
                    'User Data': userData,
                    'AI Memory': aiMemory,
                    'Chat History Count': chatHistory.length,
                    'Agent History Count': agentHistory.length,
                    'Current Messages': currentChatMessages.length,
                    'Current Chat ID': currentChatId,
                    'Current Model': currentModel,
                    'Current Style': currentStyle,
                    'Current Language': currentLanguage,
                    'Research Mode': isResearchMode,
                    'Selected Art Style': selectedArtStyle,
                    'Selected Music Style': selectedMusicStyle,
                    'Selected Image Count': selectedImageCount,
                    'Current Font': currentFont,
                    'Current Background': currentBackground,
                    'Is Pro': userData.isPro,
                    'Is Student': userData.isStudent,
                    'Points': userData.points,
                    'Ode Usage': userData.odeUsageThisMonth,
                    'Agent Usage': userData.agentProjectsThisMonth,
                    'Research Usage': userData.researchUsageThisMonth,
                    'Images Today': userData.imagesGeneratedToday,
                    'Videos Generated': userData.videosGenerated,
                    'Music Generated': userData.musicGenerated,
                    'Uploaded Files': uploadedFiles.length,
                    'Reply Files': replyUploadedFiles.length,
                    'Browser Info': {
                        userAgent: navigator.userAgent,
                        localStorage: localStorage.length + ' items',
                        darkMode: document.documentElement.classList.contains('dark'),
                        language: navigator.language,
                        online: navigator.onLine,
                        speechSynthesis: 'speechSynthesis' in window
                    },
                    'API Config': {
                        baseUrl: API_CONFIG.baseUrl,
                        models: Object.keys(API_CONFIG.models)
                    }
                };
                
                debugContent.textContent = JSON.stringify(debugInfo, null, 2);
            } catch (error) {
                console.error('Error updating debug info:', error);
                document.getElementById('debugContent').textContent = 'Error loading debug information.';
            }
        }

        document.getElementById('closeDebug').addEventListener('click', () => {
            document.getElementById('debugOverlay').classList.add('hidden');
        });

        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });

        setInterval(() => {
            try {
                saveAllData();
            } catch (error) {
                console.error('Error in periodic save:', error);
            }
        }, 30000);

        console.log('TyloAI fully initialized with all enhanced features');
        // Global error handler for payment issues
        window.addEventListener('error', function(e) {
            if (e.message && e.message.includes('payment')) {
                console.error('Payment error detected:', e);
                // Attempt to recover
                const modal = document.getElementById('paymentMethodModal');
                if (modal && modal.classList.contains('flex')) {
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                }
            }
        });
    </script>
</body>
</html>